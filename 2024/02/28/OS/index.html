<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    <meta name="description" content="Jackcui personal homepage.">
    <meta name="author" content="Jackcui">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-redefine.png">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://evan.beee.top" crossorigin>
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2024/02/28/os/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Talk to the God——Notes for jyy OS">
    <meta property="og:description" content="Jackcui personal homepage.">
    <meta property="og:url" content="http://example.com2024/02/28/OS/">
    
    <meta property="og:site_name" content="Jackcui&#39;s Chatter">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Talk to the God——Notes for jyy OS">
    <meta name="twitter:description" content="Jackcui personal homepage.">
    <meta name="twitter:image" content="/images/redefine-logo.svg">
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/redefine-logo.svg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/redefine-logo.svg">
    <meta name="theme-color" content="#005080">
    <link rel="shortcut icon" href="/images/redefine-logo.svg">
    <!--- Page Info-->
    
    <title>
        
            Talk to the God——Notes for jyy OS -
        
        Jackcui&#39;s Chatter
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/assets/fonts.css">

    <!--- Font Part-->
    
    
    
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    let REDEFINE = window.REDEFINE || {};
    REDEFINE.hexo_config = {"hostname":"example.com","root":"/","language":"en","path":"search.xml"};
    REDEFINE.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#005080","avatar":"https://s2.loli.net/2023/03/24/nBqwGYDJx6CdZr7.png","favicon":"/images/redefine-logo.svg","og_image":{"enable":false,"image_url":null},"article_img_align":"center","right_side_width":"210px","content_max_width":"1000px","nav_color":{"left":"#f78736","right":"#367df7","transparency":35},"hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"background_image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title_color":{"light":"#fff","dark":"#d1d1b6"},"font_sizes":{"title":"2.8rem","subtitle":"1.5rem"},"line_height":1.2,"title":"131a6ea Not Found","subtitle":{"enable":true,"list":["We go near, we go far.","We got found, we got lost"]},"custom_font":{"enable":false,"font_family":null,"font_url":null}},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_block":{"copy":true,"style":"mac","custom_font":{"enable":false,"font_family":null,"font_url":null}},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"1.2.3","friend_links":{"columns":2},"home_article":{"date_format":"auto","category":{"enable":true,"limit":3},"tag":{"enable":true,"limit":3}},"plugins":{"aplayer":{"enable":true,"audio":[{"name":"美好事物","artist":"房东的猫","url":"/mhsw.mp3","cover":"/mhsw.jpg"},{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":false,"version":"9.3.0"}}};
    REDEFINE.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 6.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="menu-wrapper">
    
    <div class="menu-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Jackcui&#39;s Chatter
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="pc">
                <ul class="menu-list">
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        HOME
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="has-dropdown" 
                                    href="#" onClick="return false;">
                                    
                                        
                                            <i class="fa-solid fa-dove"></i>
                                        
                                        LINKS&nbsp;<i class="fa-solid fa-chevron-down"></i>
                                    
                                </a>
                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                    
                                        <li>
                                        <a href="/links">FRIEND LINK
                                        </a>
                                        </li>
                                    
                                    </ul>
                                
                            </li>
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/UNacceptable"  >
                                    
                                        
                                            <i class="fa-solid fa-alien-8bit"></i>
                                        
                                        UNW
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/tags"  >
                                    
                                        
                                            <i class="fa-duotone fa-hashtag"></i>
                                        
                                        TAG
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="menu-drawer">
        <ul class="drawer-menu-list">
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                HOME
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="has-dropdown" 
                        href="#" onClick="return false;">
                            
                                
                                    <i class="fa-solid fa-dove"></i>
                                
                                LINKS&nbsp;<i class="fa-solid fa-chevron-down"></i>
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                              
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" href="/links">FRIEND LINK</a>
                            </li>
                        
                    
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="/UNacceptable"  >
                             
                                
                                    <i class="fa-solid fa-alien-8bit"></i>
                                
                                UNW
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="/tags"  >
                             
                                
                                    <i class="fa-duotone fa-hashtag"></i>
                                
                                TAG
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            
            
                <div class="article-title">
                    <h1 class="article-title-regular">Talk to the God——Notes for jyy OS</h1>
                </div>
            
                
            

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="https://s2.loli.net/2023/03/24/nBqwGYDJx6CdZr7.png">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">Jackcui</span>
                            
                                <span class="author-label">NJU Loser</span>
                            
                        </div>
                        <div class="meta-info">
                            <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="pc">2024-02-28 09:02:59</span>
        <span class="mobile">2024-02-28 09:02</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="pc">2024-08-13 01:16:56</span>
            <span class="mobile">2024-08-13 01:16</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/CS/">CS</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Notes/">Notes</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-file-word"></i>&nbsp;<span>23.7k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>85 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content markdown-body">
                <p><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2024/08/12/Ty82QhEYirN4G3w.png" alt="1.png"></p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>jyy ‘The Green Advisor’ OS, NJU 2024 Spring<br>License same as the original course.</p>
<h2 id="Waiting-List"><a href="#Waiting-List" class="headerlink" title="Waiting List"></a>Waiting List</h2><ul>
<li>第一节 ⛔</li>
<li>第二节 ⛔</li>
<li>M1 ✅ 🛐🛐🛐</li>
<li>第三节 ⛔</li>
<li>第四节 ⛔</li>
<li>L0 ⛔</li>
<li>第五节 ✅</li>
<li>第六节 ✅</li>
<li>第七节 ✅<ul>
<li>阅读XV6源码</li>
<li>群除我佬的问题</li>
<li>*benchmark crimes的阅读</li>
<li>*RCU细节（缺少链接）</li>
</ul>
</li>
<li>第八节 ✅<ul>
<li>学习一下GDB in Python</li>
<li>阅读GDB文档，quick guide, cheat sheet</li>
</ul>
</li>
<li>第九节 ✅ 🛐</li>
<li>第十节 ⛔</li>
<li>第十一节 ✅</li>
<li>第十二节 ✅</li>
<li>第十三节 ⛔</li>
<li>第十四节 ✅ 🛐</li>
<li>第十五节 ⛔</li>
<li>第十六节 ✅ 🛐 *🛐init.gdb</li>
<li>第十七节 ✅ 🛐🛐🛐🛐🛐🛐🛐</li>
<li>第十八节 ✅</li>
<li>第十九节 ✅ *🛐链接 🛐</li>
<li>第二十节 ⛔ </li>
<li>第二十一节 ✅</li>
<li>第二十二节 ✅ *🛐XV6重要！</li>
<li>第二十三节 ✅</li>
<li>第二十四节 ✅ 🛐</li>
<li>第二十五节 ✅</li>
<li>第二十六节 ✅</li>
<li>第二十七节 ✅ 🛐🛐</li>
<li>第二十八节 ⛔</li>
<li>第二十九节 ⛔</li>
<li>第三十节 ⛔</li>
</ul>
<h2 id="绪论"><a href="#绪论" class="headerlink" title="绪论"></a>绪论</h2><p>在做了充足的心理准备之后，终于决定报了jyy老师的OS。</p>
<blockquote>
<p>世界上有两种人：没见过<strong>神</strong>的人和见过jyy的人。</p>
</blockquote>
<p><strong>神</strong>自我革命，<strong>神</strong>制造困境，<strong>神</strong>传达启示，<strong>神</strong>引发灵感。<br>本篇作为与<strong>神</strong>的对话，忠实记录了 jyyOS 24Spring 的课程笔记，实验实录，教材读书笔记和心得感受。</p>
<h3 id="特别说明"><a href="#特别说明" class="headerlink" title="特别说明"></a>特别说明</h3><p>为了更适应英文环境，其实绝大多数的笔记都使用英语来记了，但由于绿导师的内容比较深，大面积的使用英语会使得“再提取”非常困难(鸡尾酒会效应)，而且个别思考内容我第一次用英语乱找一个说法写上，下次自己都看不懂什么意思，因此就用中文记了，我可am not那种Chinese英语mix着说的’fashion speaker’(doge)</p>
<h2 id="Lecture-1"><a href="#Lecture-1" class="headerlink" title="Lecture 1"></a>Lecture 1</h2><div class="note-large notel-blue"><div class="notel-title"><p>OSTEP Chapter 1,2</p>
</div><div class="notel-content"><p>3 Easy Pieces: virtualization, concurrency, persistence</p>
<ul>
<li><p>virtualization: physical—virtualization–&gt;virtual form<br><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="10.854ex" height="1.602ex" role="img" focusable="false" viewBox="0 -697 4797.6 708"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mtext"><path data-c="1D40E" d="M64 339Q64 431 96 502T182 614T295 675T420 696Q469 696 481 695Q620 680 709 589T798 339Q798 173 697 82T432 -10Q262 -10 163 85T64 339ZM625 454Q618 502 600 538T562 593T515 624T469 639T431 642Q331 642 276 563Q232 493 232 353Q232 315 234 285T244 216T267 148T308 94T372 56Q405 46 432 46Q517 46 567 106T627 267Q631 299 631 353Q631 418 625 454Z"></path><path data-c="1D412" d="M64 493Q64 582 120 636T264 696H272Q280 697 285 697Q380 697 454 645L480 669Q484 672 488 676T495 683T500 688T504 691T508 693T511 695T514 696T517 697T522 697Q536 697 539 691T542 652V577Q542 557 542 532T543 500Q543 472 540 465T524 458H511H505Q489 458 485 461T479 478Q472 529 449 564T393 614T336 634T287 639Q228 639 203 610T177 544Q177 517 195 493T247 457Q253 454 343 436T475 391Q574 326 574 207V200Q574 163 559 120Q517 12 389 -9Q380 -10 346 -10Q308 -10 275 -5T221 7T184 22T160 35T151 40L126 17Q122 14 118 10T111 3T106 -2T102 -5T98 -7T95 -9T92 -10T89 -11T84 -11Q70 -11 67 -4T64 35V108Q64 128 64 153T63 185Q63 203 63 211T69 223T77 227T94 228H100Q118 228 122 225T126 205Q130 125 193 88T345 51Q408 51 434 82T460 157Q460 196 439 221T388 257Q384 259 305 276T221 295Q155 313 110 366T64 493Z" transform="translate(864,0)"></path></g><g data-mml-node="mo" transform="translate(1780.8,0)"><path data-c="2248" d="M55 319Q55 360 72 393T114 444T163 472T205 482Q207 482 213 482T223 483Q262 483 296 468T393 413L443 381Q502 346 553 346Q609 346 649 375T694 454Q694 465 698 474T708 483Q722 483 722 452Q722 386 675 338T555 289Q514 289 468 310T388 357T308 404T224 426Q164 426 125 393T83 318Q81 289 69 289Q55 289 55 319ZM55 85Q55 126 72 159T114 210T163 238T205 248Q207 248 213 248T223 249Q262 249 296 234T393 179L443 147Q502 112 553 112Q609 112 649 141T694 220Q694 249 708 249T722 217Q722 153 675 104T555 55Q514 55 468 76T388 123T308 170T224 192Q164 192 125 159T83 84Q80 55 69 55Q55 55 55 85Z"></path></g><g data-mml-node="mtext" transform="translate(2836.6,0)"><path data-c="1D415" d="M592 686H604Q615 685 631 685T666 684T700 684T724 683Q829 683 835 686H843V624H744L611 315Q584 254 546 165Q492 40 482 19T461 -6L460 -7H409Q398 -4 391 9Q385 20 257 315L124 624H25V686H36Q57 683 190 683Q340 683 364 686H377V624H289L384 403L480 185L492 212Q504 240 529 298T575 405L670 624H582V686H592Z"></path><path data-c="1D40C" d="M314 0Q296 3 181 3T48 0H39V62H147V624H39V686H305Q316 679 323 667Q330 653 434 414L546 157L658 414Q766 662 773 674Q778 681 788 686H1052V624H944V62H1052V0H1040Q1016 3 874 3T708 0H696V62H804V341L803 618L786 580Q770 543 735 462T671 315Q540 13 536 9Q528 1 507 1Q485 1 477 9Q472 14 408 162T281 457T217 603Q215 603 215 334V62H323V0H314Z" transform="translate(869,0)"></path></g></g></g></svg></mjx-container><br>*<strong>standard library</strong> (APIs)<br>*<strong>resource manager</strong><br>ctrl-c used to terminate the <strong>foreground</strong> program in UNIX-based OSs<br><strong>ALSR</strong>: Address Space Layout Randomization: randomized the address where executables are put each time when the process is created to avoid buffer overflow attacks</p>
</li>
<li><p>concurrency: differenet processes ‘simultaneous’<br>*due to the OS execute the instruction groups not atomically, ill-designed multithreading programs may have unexpected results</p>
</li>
<li><p>persistence: store data persistently, namely, I/O<br><strong>journaling</strong>:keep track of changes made to data<br>JBD: Journaling Block Device<br>and WAL in database<br><strong>copy-on-write</strong>:delay the copying of data until the moment it’s actually modified.<br>duplicate on use</p>
</li>
</ul>
<p>Design aims:</p>
<ul>
<li>abstractions</li>
<li>performance</li>
<li>protection(isolation)</li>
<li>reliability(not fail)</li>
<li>…</li>
</ul>
<p>OS history…</p>
 </div></div>


<h2 id="Lecture-2"><a href="#Lecture-2" class="headerlink" title="Lecture 2"></a>Lecture 2</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect2.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br>可以认为是对状态机模型的深入阐述：<br>yzh版本：<a class="link" target="_blank" rel="noopener" href="https://jackcuii.github.io/2023/07/04/ysyx0004/">https://jackcuii.github.io/2023/07/04/ysyx0004/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>

<p><em>“最小的应用程序”</em> 说明了什么？ 程序是状态机，状态机不能退出自己，只能从外部退出，操作系统也是程序，也是状态机，也不能退出自己。<br>用户程序—用syscall—借助—&gt;操作系统—用I/O message—借助—&gt;硬件 来退出自己。</p>
<blockquote>
<p>硬件呢？它也是状态机，但从主板总控的视角上看，供电控制系统是伺服运行的，它<strong>从未</strong> <code>退出</code> 过</p>
</blockquote>
<p>深入理解状态机模型：理解调用和递归<br><em>case:C语言解释器解决函数调用</em></p>
<p>2.1 和 2.2 还没</p>
<p>递归向非递归的转换：<br>其实就是手动来实现了栈，也就是函数调用的过程，跳出“出去回来”的思维模式，一切其实都是在“顺序” “前进”</p>
<blockquote>
<p>某种程度上说，都是递归，或者说非递归就是递归，递归可以认为是一种固有的形式逻辑？</p>
</blockquote>
<div class="note-large notel-red"><div class="notel-title"><p>Spicy</p>
</div><div class="notel-content"><p>更深入地理解状态机：理解编译和优化<br>编译就是状态机之间映射。<br>什么是优化？就是行为不变提高效率/减少资源消耗。什么是行为不变？就是<strong>系统调用不变</strong>。（其余的操作<strong>都是黑箱</strong>，只有调用才和外界产生联系）<br>不仅如此？系统调用也可以改变，保证系统调用的行为一致（<strong>行为的行为</strong>），可以把程序本身somehow做成调用，也就是系统的一部分。（前沿了）<br>额…那这和没有操作系统的区别在于？</p>
 </div></div>

<p>还有很多🛐🛐🛐🛐</p>
<hr>
<h2 id="M1-pstree"><a href="#M1-pstree" class="headerlink" title="M1:pstree"></a>M1:pstree</h2><div class="note-large notel-green"><div class="notel-title"><p>M1 Log</p>
</div><div class="notel-content"><ul>
<li>确实觉得祖传代码应该好好打击了!<ul>
<li>hy老师上周宣布算法的OJ由于<strong>系里禁止</strong>查重而取消，这两件事对比起来看让人唏嘘啊。。。</li>
</ul>
</li>
<li>学习jyy在命令行里接入了GPT，感觉方便了许多！</li>
<li>没看后面的就想（问GPT）到了在哪找到state，切实感觉到了方法论的变化（GPT on the shell 之后，问GPT不用点鼠标了，频率飙升）</li>
<li>🛐 <a class="link" target="_blank" rel="noopener" href="https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap12.html">欠债：POSIX参数约定 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></li>
<li>编写可移植的代码？？？</li>
<li>关于Hard Test的事例，略感恐惧<ul>
<li>这个虽然给出了,但以后的实验呢，想都不敢想。。。</li>
<li>这个或许可以通过strace来发现，但“行为相同”到这个程度……</li>
<li>另外就是发现OJ平台好像可以看到错误返回值</li>
</ul>
</li>
</ul>
<div class="note-large notel-red"><div class="notel-title"><p>Spicy🌶️</p>
</div><div class="notel-content"><ul>
<li>Windows Kernel -&gt; offer API</li>
<li>UNIX (Philosophy) -&gt; Everything is a file -&gt; files</li>
<li>在某一个时刻，高级语言也会变成汇编语言，毕竟Programming终究也就是一个Wheel，好像跟蒸汽机没什么区别…</li>
</ul>
 </div></div>

<ul>
<li><p>man 5 proc</p>
</li>
<li><p>还是要认真读manual，实验了半天得到的参数解析规则其实在文档里已经写了，不过好像手册没有明确写熔断？（比如说读到-V之后就不再解析了，后面错误参数也不管了）</p>
</li>
<li><p>🛐<strong>欠债</strong>：如何写出string robust的代码？</p>
</li>
<li><p>🛐<strong>欠债</strong>：如何写出内存安全的代码？</p>
</li>
<li><p>kthreadd pid=2 ppid=0 内核线程守护进程，运行在内核上的进程,并不会显示在pstree里, 而且发现查询后得知线程在对应进程文件夹下的task文件夹里，不过在/proc中cd相应的序号，也可以进去，虽然实际上不在那里也ls不到，不知道是怎么实现的。</p>
<div class="note note-yellow icon-padding"><i class="note-icon fa-solid fa-group-arrows-rotate"></i><p>群除我佬之后发现原生pstree中是可以指定根的，只要指定根为0就可以发现了</p>
</div></li>
</ul>
<p>🔱<strong>3.15 V1.0 感想</strong>：<br>前前后后写了10几个小时，终于得到了第一个稳定的版本，确实感觉很菜（<br>coding 能力确实低下（虽然有熟悉环境的时间）<br>不过也确实感谢去年ICS的自行加练，一定程度上没有让差距拉的更大<br>现在效率确实远没有群众大佬高，但是感觉能力确实在一点点积累，也希望后面能跟上大家的进度。。。<br>在有些地方踌躇过多，但因为其实没有实际的经验，所以写出来的还是缺乏健壮性。。。<br>而且这么简单的功能写了如此之多行，属实是屎山<br>但<strong>新的风暴确实已经产生了！</strong> 🌪️🌪️🌪️</p>
<ul>
<li>32/64 robustness<br>第一次提交挂了，应该是32/64的问题，问了GPT值得注意的问题</li>
</ul>
<p><strong>32/64 Robustness Checklist:</strong><br>🔻 指针整数转换的时候使用：<code>uintptr_t</code>/<code>intptr_t</code><br>🔻 使用定长的<code>uint32_t</code>系列整型，尽量保证整形长度不变<br>🔻 检查数据对齐</p>
<ul>
<li>使用<code>#pragma pack</code>或<code>__attribute__((aligned))</code>等指令来控制结构体的对齐方式。</li>
<li>在动态分配内存时，考虑使用<code>aligned_alloc</code>、<code>posix_memalign</code>等函数来获取对齐的内存块。</li>
</ul>
<p>🔻 注意<code>size_t</code>的使用<br>🔻 确保使用的第三方库和函数的支持<br>🔻 使用预定义宏如<code>__LP64__</code>、<code>_WIN64</code>等实现条件编译<br>🔻 使用静态代码分析工具如Lint、Cppcheck等来检查。</p> </div></div>


<h2 id="L0-Pic-Display"><a href="#L0-Pic-Display" class="headerlink" title="L0-Pic Display"></a>L0-Pic Display</h2><p>对Abstract Machine的理解：<br>某种意义上讲就是将硬件实现的最基本操作进行了封装和抽象，获得一个C库，这个库的flexibility 恰好可以让我们实现现代操作系统最基本的功能（虽然无法进行更精细的控制）。<br>使得底层具体的体系结构对操作系统透明。<br>YCM太讨厌了，一定程度上修好了，但还有一个一直报错。。。<br>需要仅有图像的二进制数据，可以用Linux工具（叫。。。）转化成ppm格式，去掉简短的文件头，再xxd转化成数组即可<br>一个非常经典的愚蠢错误，就是宏展开时的优先级错误，Debug了三个小时！！！！！！！！！！！</p>
<h2 id="Lecture-3"><a href="#Lecture-3" class="headerlink" title="Lecture 3"></a>Lecture 3</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect3.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<p>物理世界也是状态机，计算机系统的状态机通过Intr和外界连接起来。<br>如何控制一台裸机？把程序放到RESET状态里！<br>固件Firmware：系统配置，开机检查，<strong>加载操作系统</strong><br>Legacy BIOS -&gt; UEFI：丰富的I/O设备, PIC IPIC…<br>CIH病毒：破坏BIOS<br>EFI 分区，我们可以用mount挂载它。<br>还有一个Boot管理工具 <a class="link" target="_blank" rel="noopener" href="https://www.rodsbooks.com/refind/">rEFInd <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<ul>
<li>手册并不是写给学生的，但要痛苦的读</li>
<li>AbstractMachine可以让你绕开手册</li>
<li>模拟器需要做的其实就是状态转移</li>
</ul>
<div class="note-large notel-orange"><div class="notel-title"><p>Extension: Learn from the God</p>
</div><div class="notel-content"><p>GPT on the shell!<br><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2024/03/06/7V1YSIWd8qiNDLz.jpg" alt="b0b8a7feeb7d08c76cf146201fc895e.jpg"></p>
 </div></div>

<p>看到3.3节  浮现课上代码</p>
<h2 id="Lecture-4"><a href="#Lecture-4" class="headerlink" title="Lecture 4"></a>Lecture 4</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect4.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<ul>
<li>Coq 语言 -&gt; 经过<a class="link" target="_blank" rel="noopener" href="https://cacm.acm.org/news/formal-software-verification-measures-up/">形式化验证 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></li>
<li><strong>这门课的逻辑思路</strong>：建模-&gt;用Python实现这个模型的Toy（能实现的原因：操作系统就是一个状态机！）-&gt;对比Toy和真实操作系统的区别-&gt;认识真实操作系统的性质</li>
<li>如何设置？把所有<strong>性质</strong>都显式的assertion出来。</li>
<li>操作系统的理解：管理状态机的状态机, 最早的并发程序</li>
<li>那我们如何来实现一个“状态机的状态机”玩具呢？如果有简单的工具就好了！——Generator</li>
<li>数学视角下，状态机就是一个图，因此系统的状态就是图，因此就可以使用图论方法，比方说，用广度优先搜索验证程序/系统的正确性。</li>
</ul>
<p><strong>待完成，跑一下 30lineOS 复习Python Gene，余者完成</strong></p>
<p>GDB TUI?</p>
<h2 id="Lecture-5-C-Intro-of-Multiprocessor"><a href="#Lecture-5-C-Intro-of-Multiprocessor" class="headerlink" title="Lecture 5 (C) Intro of Multiprocessor"></a>Lecture 5 (C) Intro of Multiprocessor</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect5.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<ul>
<li>多线程程序：多个状态机共享内存，有私有的（C：栈区/Assemble：寄存器）</li>
</ul>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p>核心方法论：<strong>Questioning and Proofing</strong><br>对给出的结论持怀疑态度，并且试着去构造案例去验证。（Hands dirty…）</p>
</div>

<ul>
<li>如何证明共享内存？简单！</li>
<li>如何证明不共享栈区？<br>找到栈区？指向栈区的“指针”！-&gt;局部变量取地址<br>如何大致画出栈区范围？ stack overflow! —&gt; default 8MB</li>
</ul>
<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p>阅读代码：<a class="link" target="_blank" rel="noopener" href="https://github.com/Jackcuii/jyy-codes-test-and-read/blob/master/thread-lib/thread.h">最小线程库 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>简化了线程API</p>
</div>

<blockquote>
<p>mosaic的使用：直接连起来即可，管道喂给collect.py这样就可以收集结果。</p>
</blockquote>
<div class="note-large notel-orange"><div class="notel-title"><p>Extention: LLM</p>
</div><div class="notel-content"><p>LLaMA.cpp: Support run LLM on CPU (OpenSource)<br><a class="link" target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/622450960">https://zhuanlan.zhihu.com/p/622450960 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
 </div></div>



<ul>
<li><p><strong>需要reading: Quickguide GDB调试并发程序</strong></p>
</li>
<li><p>开放<strong>你的</strong>思想：“放弃编程原子性的假设”，进行中的状态机会被改变！</p>
<ul>
<li>在一个处理器的多线程意义下，语句的原子性已经不存在了</li>
<li>在多处理器的意义下，连一条汇编指令的原子性都不存在了</li>
</ul>
</li>
<li><p>1+1都写不对了？确实，而且几乎没人能写对 Dekker’s Algorithm 是第一个<br>Question 1+1: N个threads, sum最小是？ 2！任意多个线程都是！</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Thread 1 | Thread 2</span><br><span class="line">load 0   | load 0</span><br><span class="line">store 1  |</span><br><span class="line">load 1   |</span><br><span class="line">store 2  |</span><br><span class="line">         | store 1</span><br><span class="line">load 1   | </span><br><span class="line">         | load 1</span><br><span class="line">         | store 2</span><br><span class="line">         | load 2</span><br><span class="line">         | store 3</span><br><span class="line">store 2  |</span><br></pre></td></tr></table></figure></div></li>
<li><p>线程安排是以一个NP-Complete问题，<em>LLM级别的直觉</em> 也不能解决！</p>
</li>
</ul>
<hr>
<ul>
<li>更大的麻烦：<strong>编译器</strong>也是这么认为的！<br>回顾编译优化，现在每一条指令之间都可能是系统调用！<br>共享内存的背景下，几乎任何程序，都是“不可优化的”！<br><em>‘Heisenbug’</em>: Copilot：“一个bug，你试图修复它，它就消失了！” <ul>
<li>更可怕的是当编译器执行了优化，可能会把并发错误隐藏起来！<br>-O1 稳定 10000000：把和优化到寄存器里了，只最后写内存了一次<br>-O2 稳定 20000000: 直接编译成一个加了，遇到的概率很小</li>
<li>waiting for flag bug:<br>while(!flag);<br>“等另一个线程举起旗子”<br>也不行！编译器视角：要么直接过，<strong>要么死循环</strong>。<ul>
<li>解决（也是很多并发的解决办法）：插入不可优化代码，见jyyppt/volatile</li>
<li><strong>而本课程建议：加锁！</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="note-large notel-red"><div class="notel-title"><p>Spicy</p>
</div><div class="notel-content"><ul>
<li>更更更大的麻烦：<strong>处理器</strong>也是这么认为的！（处理器也是编译器）<br>如果单线程乱序等效，处理器就可以乱序执行。<br>处理器取出多条指令，然后判断是否冲突。欸？这不就是编译器吗，同样会导致并发错误！<ul>
<li>“相对论效应”：复杂的相对时序<br>多处理器的背景下，共享内存并不是简单共享“同一块”，会发现程序执行的绝对顺序完全不存在了，对于不同的CPU，观测到的时序可能是不一样的（因为多级缓存复杂的写入逻辑（copy-on-write 之类的））。</li>
<li>model checker 都失效了<br>因为model checker是基于“一块共享内存”建模的<br>困难的 memory model (比如x86的 write buffer)<ul>
<li>如果model不同，就很难相互模拟，比如ARM和x86之间</li>
</ul>
</li>
</ul>
</li>
</ul>
 </div></div>


<div class="note-large notel-blue"><div class="notel-title"><p>OSTEP Chapter 25,26,27</p>
</div><div class="notel-content"><ul>
<li>PCB(Process Control Block) v.s. TCB(Thread Control Block)</li>
<li>objdump参数：-g</li>
<li><strong>工具使用valgrind, purify, helgrind</strong></li>
<li>pthread库基础<ul>
<li>pthread_create 创建线程 </li>
<li>pthread_join 等待线程返回（并不是所有的场景都需要）</li>
</ul>
</li>
<li>pthread lock<ul>
<li>pthread_mutex_init</li>
<li>pthread_mutex_lock</li>
<li>pthread_mutex_unlock</li>
<li>pthread_mutex_destroy</li>
<li>pthread_mutex_trylock(一般不要用)</li>
<li>pthread_mutex_timedlock(一般不要用)</li>
</ul>
</li>
<li>pthread cond var 暂时略过</li>
</ul>
<p><strong>Multithreading Checklist</strong>:<br>🔻 </p>
 </div></div>


<h2 id="Lecture-6-C-Mutex-amp-lock"><a href="#Lecture-6-C-Mutex-amp-lock" class="headerlink" title="Lecture 6 (C) Mutex & lock"></a>Lecture 6 (C) Mutex &amp; lock</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect6.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<p>‘sequential creature’的反击：<br>互斥！不允许并发！给它们上锁，让状态机上的一部分缩成一个点！<br>如果都不让并发了？那还并发干什么？<br>运算是可以并行的。局部性原理（经典物理：“物体对相邻的物体产生影响需要时间！”），局部的计算都可以独立的进行，只需要谨慎的处理分块的边界。可以认为不能并发的<strong>任务</strong>部分远远少于可以并发的。</p>
<p>对于一个处理器，关中断就可以了！<br>但当某一个程序卡死了，OS就卡死了。<br>怎么办？外部监控，利用NMI来外部监控OS是否执行正常。（如重置定时器等）<br>因此操作系统统治了中断，禁止用户程序控制中断。</p>
<ul>
<li>悲观的Amdahl’s Law: 如果你有<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="3.441ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 1521 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(500,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"></path></g></g><g data-mml-node="mi" transform="translate(1000,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g></g></g></svg></mjx-container>的代码是不能并行的，那么 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.798ex;" xmlns="http://www.w3.org/2000/svg" width="8.754ex" height="2.89ex" role="img" focusable="false" viewBox="0 -924.8 3869.3 1277.6"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g><g data-mml-node="TeXAtom" transform="translate(617,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="221E" d="M55 217Q55 305 111 373T254 442Q342 442 419 381Q457 350 493 303L507 284L514 294Q618 442 747 442Q833 442 888 374T944 214Q944 128 889 59T743 -11Q657 -11 580 50Q542 81 506 128L492 147L485 137Q381 -11 252 -11Q166 -11 111 57T55 217ZM907 217Q907 285 869 341T761 397Q740 397 720 392T682 378T648 359T619 335T594 310T574 285T559 263T548 246L543 238L574 198Q605 158 622 138T664 94T714 61T765 51Q827 51 867 100T907 217ZM92 214Q92 145 131 89T239 33Q357 33 456 193L425 233Q364 312 334 337Q285 380 233 380Q171 380 132 331T92 214Z"></path></g></g></g><g data-mml-node="mo" transform="translate(1651.9,0)"><path data-c="3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"></path></g><g data-mml-node="mfrac" transform="translate(2707.7,0)"><g data-mml-node="msub" transform="translate(220,446.1) scale(0.707)"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g><g data-mml-node="mn" transform="translate(617,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mi" transform="translate(396.6,-345) scale(0.707)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><rect width="921.6" height="60" x="120" y="220"></rect></g></g></g></svg></mjx-container></li>
<li>乐观的Gustafson’s Law (的更细致版本): 并行计算总是能实现的 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -1.091ex;" xmlns="http://www.w3.org/2000/svg" width="13.834ex" height="3.183ex" role="img" focusable="false" viewBox="0 -924.8 6114.4 1407"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g><g data-mml-node="mi" transform="translate(617,-150) scale(0.707)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g></g><g data-mml-node="mo" transform="translate(1300.5,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"></path></g><g data-mml-node="msub" transform="translate(2356.2,0)"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g><g data-mml-node="TeXAtom" transform="translate(617,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="221E" d="M55 217Q55 305 111 373T254 442Q342 442 419 381Q457 350 493 303L507 284L514 294Q618 442 747 442Q833 442 888 374T944 214Q944 128 889 59T743 -11Q657 -11 580 50Q542 81 506 128L492 147L485 137Q381 -11 252 -11Q166 -11 111 57T55 217ZM907 217Q907 285 869 341T761 397Q740 397 720 392T682 378T648 359T619 335T594 310T574 285T559 263T548 246L543 238L574 198Q605 158 622 138T664 94T714 61T765 51Q827 51 867 100T907 217ZM92 214Q92 145 131 89T239 33Q357 33 456 193L425 233Q364 312 334 337Q285 380 233 380Q171 380 132 331T92 214Z"></path></g></g></g><g data-mml-node="mo" transform="translate(3952.6,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mfrac" transform="translate(4952.8,0)"><g data-mml-node="msub" transform="translate(220,446.1) scale(0.707)"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g><g data-mml-node="mn" transform="translate(617,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mi" transform="translate(403,-345) scale(0.707)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><rect width="921.6" height="60" x="120" y="220"></rect></g></g></g></svg></mjx-container></li>
</ul>
<p>普通程序不能关中断，多处理器也不能关中断，怎么实现互斥？<br>尝试用软件（算法）实现互斥：</p>
<ul>
<li>Dekker’s Algorithm</li>
<li>Peterson’s Algorithm （改进后的Dekker）<ul>
<li>假设读写过程是原子的，任何时刻都可以执行load/store</li>
<li>过程<ul>
<li>希望进厕所：举旗子，把对方的名字贴在门上</li>
<li>之后看：对面没举旗 || 门上是自己的名字 👉才可以进</li>
<li>出来的时候把自己的🚩拿掉</li>
</ul>
</li>
<li>保证了任意打断的正确性。你怎么知道的？Mosaic！</li>
</ul>
</li>
</ul>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p>核心方法论：<strong>Let model checker tell you!</strong><br>与其无意识的瞎猜，不如让Mosaic来告诉你答案！<br>如何知道这个状态机的性质，别忘了<strong>图论</strong>！<br><strong>我们学习和研究的方法论改变了</strong><br><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2024/03/18/GLYoIMUAia6RQ5H.png" width="600"><br>我们只要发散和质疑，提出猜想！让好的工具告诉你对错！<br><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2024/03/18/iHCg2x5um3BOyMF.png" width="250"><br><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2024/03/18/dPsJ9vR5aACQmDH.png" width="200"><br>再去想为什么。用机器来替代一些人类的思维活动。<br>同时可以用一些简单的必要条件来初步验证猜想的正确。<br>而且简单的验证代码如今还可以让LLM来帮你写。</p>
</div>

<p>但是在多处理器系统上简单的写个Peterson并不对（由于上一节课的内容），如果要正确的实现还需要增加大量的内存屏障。而且，如果有多个人上厕所，就不好用了。（所以在现代实践中，这个算法就没什么用）</p>
<blockquote>
<p>为什么像人类一样简单的“等在厕所门口”不行？<br>不能同时“看”和“写”（正因为不能同时，所以中间可能会被插入）<br>要么闭着眼睛写，要么背着手看！<br>读&amp;写不具有原子性</p>
</blockquote>
<p>所以最简单的解决就是实现RW的原子性<br>用硬件来解决就可以了！<br>给我<strong>一点</strong>stop-the-world的机会，一个load/store.<br>（x86的xchg，MIPS甚至支持更多）<br>如果在add/inc前面加上lock，会被编译为原子指令<br>如果想要更多：TSX Memory🛐<br>原子交换xchg:世界上只有一个✔，但是每个人有个❌，操作就是交换，换到✔就可以进去了。别人就在❌和❌不停交换，也就是</p>
<p>还有cmpxchg 🛐</p>
<p>相比于上面的自旋锁，实际的自旋锁更为复杂<br>用户态的自旋锁会导致资源浪费！一核获取，N核围观</p>
<p>🔱System人不喜欢复杂的单点实现，简单能用就可以了，因为System本身就已经足够复杂了</p>
<div class="note-large notel-blue"><div class="notel-title"><p>OSTEP Chapter 28</p>
</div><div class="notel-content"><ul>
<li>mutual exclusion<ul>
<li>disable interruption(simple but bad, as above)</li>
<li>atomic instr:<br>differs in different Arch</li>
</ul>
</li>
<li>fairness</li>
<li>performance</li>
</ul>
 </div></div>


<h2 id="M2-libco"><a href="#M2-libco" class="headerlink" title="M2:libco"></a>M2:libco</h2><p>pigeon 既能运行又能被动态加载的共享库。<br>许多库函数都会提供一个 init 函数，例如 co_init()，在希望使用时调用。但协程库实验中没有。如果你希望在程序运行前完成一系列的初始化工作 (例如分配一些内存)，可以定义 <strong>attribute</strong>((constructor)) 属性的函数，它们会在 main 执行前被运行。</p>
<p>再看到实验文档前，最初实现协程返回的思路是，在非主协程的协程栈底部增加一个co-yield的栈帧，这样的当协程返回时，就会自动的进入一个co_yield执行，从而实现结束后的切换。那么如何回收资源呢，就是在co_yield切换协程时，检查此时的指针是否在协程初始指针之前，如果是，说明协程已经推出了，就可以对对应的资源进行回收。<br>不过这个解决方案确实极其麻烦，而且某种意义上讲，好象就是自己实现了wrapper?虽然从</p>
<p>set long jmp差不多<br>最初的想法是在wrapper中实现资源的回收，看了文档发现这是不可行的，一方面会导致文档中所说的wait一个新协程的情况，另一方面是再多线程的情况下，这种设计会导致在栈被free后再次被分配给其他线程，此时在原来的位置创建yield的栈帧就会导致并发错误。</p>
<p>这个Wrapper实际上不能直接使用，因为wrapper变成了双参函数，使用的话需要修改switch_stack的函数实现，就在准备开始动工的时候，和室友交流意识到可以直接传入协程结构的指针，这样就轻松的解决了这个问题。。</p>
<p>有一个ASsert写错了。。。 yield的时候active co 也可以是刚waiting完。。。</p>
<p>刚开始wrapper的关系都搞错了，离大普。。。</p>
<p>对齐的大问题。。。还没搞懂</p>
<p>还有一些小错误<br>然后发现还有资源泄漏。。。<br>刚开始想fair不fair无所谓，后来发现完全不行<br>不是会死锁，而是会停住！i</p>
<p>逻辑严重错误!!!!</p>
<p>随机性问题；只有绝对随机才不会死锁？</p>
<p>最后的问题是不能yield到自己。。。。。。。。。。。。。。</p>
<h2 id="Lecture-7-C-Mutex-amp-lock"><a href="#Lecture-7-C-Mutex-amp-lock" class="headerlink" title="Lecture 7 (C) Mutex & lock"></a>Lecture 7 (C) Mutex &amp; lock</h2><p>我们目前是如果一个获取了🔒，整个处理器就被stop-the-world了。<br>这样的损失太大了，怎么办保证其他人的运行？把每个不同的资源准备一个锁，实现多把锁。<br>还要保证当一个解锁时，它所做的写必须都是对其他线程可见的，从别人的角度看，它对临界区的修改必须<strong>已经发生</strong>了（怎么实现先不用管，框架里帮你实现了）<br>虽然锁很好用，但并不容易正确处理锁。<br>容易出现忘记加锁了，从而造成数据竞争(Data race)<br><strong>Warning：一定会遇到并发错误</strong></p>
<hr>
<p>但对于操作系统来说，问题并不止如此，还有中断！</p>
<blockquote>
<p>注意：为什么用户态不需要在意这一问题，这是因为在用户态中的锁，在被中断时不会有人尝试去进入临界区，因此不需要在意中断问题（可以认为中断对用户态是透明的“一觉醒来”））</p>
</blockquote>
<p>当你进入临界区，触发中断，再试图进入临界区，此时已经上锁了，无法退出！因此仅有自旋是不对的。</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p>尽量不要<strong>用直觉</strong>去写代码，写错再删….</p>
</div>
<ul>
<li><p>直观的想法：cli -&gt; lock() -&gt; … -&gt; unlock() -&gt; sti</p>
</li>
<li><p><del>一个锁过程中可能会调用中断再次运行这段代码，那么就无法获得这个锁：陷入死锁！</del></p>
</li>
<li><p>多个锁可以嵌套和穿插，但cli和sti只有一个，怎么保证<strong>回到从前</strong>？（注意：正确不是先关后开，而结束后的状态=开始前的状态）<br>保证中断状态不变这件事不容易：必须要保存中断状态。保存在哪？<br>每次关中断都+1，开中断-1，类似每次嵌套都把中断状态存到一个栈里，<strong>每个CPU</strong>都维护<br><strong>推荐阅读：XV6</strong> </p>
<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p>很好的spinlock代码<br>一个启示：多写检查！！<br>另外jyy写的main里面也有很多值得学习的东西。</p>
</div></li>
</ul>
<div class="note note-yellow icon-padding"><i class="note-icon fa-solid fa-group-arrows-rotate"></i><p>群除我佬：<br>关于spinlock的main在本地运行结果不正确的问题：<br>还有就是TCG是什么东西？🛐</p>
</div>

<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p>跳出fast-pass的<strong>投机</strong>思维：即<strong>假设</strong>自己的代码是对的。<br>以后就没有人告诉你对不对了！而且你的未测代码越来越可能不对！</p>
</div>

<div class="note-large notel-red"><div class="notel-title"><p>Spicy🌶️：(半)无锁互斥</p>
</div><div class="notel-content"><p><a class="link" target="_blank" rel="noopener" href="https://gernot-heiser.org/benchmarking-crimes.html">benchmark crimes <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br>自旋锁的scalability极差！（类似于反比例）操作系统只在及其短促的操作上使用自旋锁。Linux Kernel的分析见ppt链接<br>但Linux有大概180K个需要内存保护的函数，怎么办？<br>一个特性：绝大多数数据结构都是Read-mostly<br>可不可以读不加锁？RCU(Read-Copy-Update)策略！<br>牺牲读写的一致性，选择write-on-copy，写入的时候复制建一份新的（对于常见数据结构，不是傻傻的复制，又高效的部分复制），这样<strong>总能读到</strong>一个。<br>用户程序<strong>应该能容忍</strong> <strong>少量的</strong>读到错的。（比方说路由表，读到错的大不了重发一次）<br>这样就解决了性能问题。<br>什么时候扔掉旧版本？阅读材料（并没有啊。。。）</p>
 </div></div>
<p><strong>XV6 Spinlock拿来在实验里用就行了</strong></p>
<hr>
<p>性能问题：大量的自旋锁会浪费大量的资源。<br>持有锁的线程被中断？？，换一个自旋的，这样可能会100%地占用资源。<br>怎么办：在自旋的时候调度到其他线程（由操作系统来做！）<br>pthread_mutex_lock<br>🌶️一个更聪明的实现：Futex: 如果无人争抢就不会陷入操作系统内核，如果有人争抢就会交给操作系统调度。 fast-slow path<br>有很多并不显然的困难问题 🛐</p>
<p><strong>至少目前，mutex就是黑箱就可以了</strong></p>
<h2 id="Lecture-8-Snack"><a href="#Lecture-8-Snack" class="headerlink" title="Lecture 8 (Snack)"></a>Lecture 8 (Snack)</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect8.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br>好用的工具 <a class="link" target="_blank" rel="noopener" href="https://gcc.godbolt.org/">Compiler Explorer <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<p>记住两件事：<br>未测代码都是错的！<br>我写的都是错的！</p>
<p>编译器 + 编译选项 + 特定的硬件 + luck = BUG</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Requirements ---&gt; Design ---&gt; Code[Fault] ---&gt; Execution[Error] ---&gt; [Failure]</span><br><span class="line">              ↑           ↑        ↑                                     ↑</span><br><span class="line">mistake here--+-----------+   Where you make                        Where you find</span><br></pre></td></tr></table></figure></div>

<p>调试就是观察状态机的侧面，以便于找到“第一个错误的状态”<br>printf就是状态的摘要，使人能够通过知识进行判断：快速的对执行进行分块，定位错误在哪一个块上<br>但在很多情况下，有很多的错误状态只是一个值，长得和别的值没有什么区别！</p>
<hr>
<p>调试一切（状态机）！<br>如何解决一个新问题？<br>UNIX哲学中，整个使用计算机都是编程，你都可以去观察侧面，怎么观察？</p>
<ul>
<li>make program verbose <code>-v</code></li>
<li>Profiler <code>perf</code> and Trace <code>strace</code></li>
</ul>
<blockquote>
<p>经过查询，工具中的verbose好像真的是通过多级的if则printf组织的。。。(GPT)</p>
</blockquote>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p><strong>核心方法论</strong>：strace/verbose 的不理解？GPT可以告诉你！<br>GPT非常擅长解释充满了陌生名词但没有复杂逻辑的东西</p>
</div>

<p>报错信息有的时候不可靠的，但是它一定“在什么地方打印出来”。<br>初学者（别人遇到过这个问题）—&gt; 资深程序员（发现原因并解决问题）（“找对象一定给要找程序员：因为出了问题都是自己的原因”）</p>
<div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><strong>重新发现GDB</strong>： <a href="">GDB文档</a> <a href="">QuickGuide</a><br>一些梦寐以求的功能其实GDB已经实现了： 比方说逆向执行！（还有和并发相关的）</p>
</div>

<div class="note-large notel-orange"><div class="notel-title"><p>Extention</p>
</div><div class="notel-content"><p>GDB Cheat Sheet.<br>I have been on it for sometime, though pigeoning!<br><a class="link" target="_blank" rel="noopener" href="https://github.com/Jackcuii/Commandline-quick-sheet">Commandline-quick-sheet <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
 </div></div>

<div class="note-large notel-red"><div class="notel-title"><p>Spicy: Really Spicy!</p>
</div><div class="notel-content"><p>时间压力下，我们会被迫用肌肉记忆解决问题<br>—&gt; 停止自己的技术演进<br>—&gt; 最后技术与社区脱节，成为油腻的中年“键盘侠”<br>怎么办？<br><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2024/03/25/1hi9KtFRMXcGTrC.png" width="300"></p>
 </div></div>

<p>应用调试理论：什么是好的代码？<br>Self-Explanatory Code: 代码应该是自解释的，不需要额外的注释<br>Self-evident Code: 代码应该是自证明的，可以通过阅读确认和需求的一致性。</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p><strong>核心方法论</strong>：因为AI还“不够聪明”：AI is a benchmark! 如果你的代码AI能够理解，那么说明是好代码。</p>
</div>

<hr>
<p>写出BUG了怎么办？</p>
<ul>
<li>多测试</li>
<li>缩短Error和Failure：断言</li>
</ul>
<blockquote>
<p>编译选项：<code>-fsanitize=address</code> 自动添加断言检查存储错。</p>
</blockquote>
<h2 id="Lecture-9-C-Sync-Producer-Consumer"><a href="#Lecture-9-C-Sync-Producer-Consumer" class="headerlink" title="Lecture 9 (C) Sync: Producer-Consumer"></a>Lecture 9 (C) Sync: Producer-Consumer</h2><blockquote>
<p>补充互斥：宏观理解锁<br>应用程序也会被中断，为什么不需要上锁？因为中断对用户程序是不可见的，中断程序(内核态)不回去试图获取用户态的🔒。</p>
</blockquote>
<p>同步：使得两个变化量在时间上具有相对关系。<br>“在某个瞬间互相已知”<br>状态机视角的同步，简单的状态变复杂，再让世界收束到简单的状态（像一个洋葱🧅）<br>”相互已知的简单状态“<br><em>“电子乐后驱jyy”</em> （电子乐这个地方为什么一定要加锁？）</p>
<p>消费者生产者问题，可以解决99%的同步问题！<br>概念模型：往有限缓冲区放东西/取东西</p>
<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p><a class="link" target="_blank" rel="noopener" href="https://github.com/Jackcuii/jyy-codes-test-and-read/blob/master/pc-1.c">第一个错误的生产者-消费者实现 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br>因为没有满足检查和生产/消费的原子性。</p>
</div>

<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p><a class="link" target="_blank" rel="noopener" href="https://github.com/Jackcuii/jyy-codes-test-and-read/blob/master/pc-2.c">第一个正确的生产者-消费者实现 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br>虽然它总是在“自旋”在浪费cpu资源！<br>获取🔒，条件满足则持有不释放🔒，条件失败则<strong>释放</strong>重试（自旋）。</p>
</div>
<p>这是一个万能的方法，上面的depth判断可以抽象成CAN_PRODUCE/CAN_CONSUME<br>这样就是一个万能的模板了！</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p><strong>核心方法论</strong>：为什么“打印括号”？获得一个容易写程序进一步检查，直观的指标！把问题具象化！</p>
</div>
<p>有一个通用的模型，一定有对应的接口实现。<br>我们<strong>发明了条件变量</strong>，但还不要这么傻（不自旋retry，休眠，等待唤醒）：当然有现成的库！</p>
<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p><a class="link" target="_blank" rel="noopener" href="https://github.com/Jackcuii/jyy-codes-test-and-read/blob/master/pc-cv.c">使用了条件变量的接口！很可惜，还是错的 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 书上解释了🛐</p>
</div>
<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p><a class="link" target="_blank" rel="noopener" href="https://github.com/Jackcuii/jyy-codes-test-and-read/blob/master/pc-cv-broadcast.c">真正全局正确的实现，正确打开方式 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>

<p><strong>一个条件变量实现真正正确的P-C</strong></p>
<ol>
<li>唤醒后再检查 （从wait陷入睡眠后会implicit释放掉🔒，被唤醒时会implicit重新获得，因此应该直接开始检查）</li>
<li>唤醒<strong>所有</strong>潜在被唤醒的人</li>
</ol>
<p><strong>我们最好这样写↑</strong></p>
<p>用signal需要两个条件变量来实现🛐</p>
<p>为什么可以解决 <strong>99%</strong> 的问题？<br>计算任务都是有向无环图，计算图切分（有序思考方式）</p>
<ol>
<li>一个生产者，每个核心是消费者，生产者（调度器）拓扑排序计算图，把无依赖的任务扔进buffer，消费者取出任务计算即可。（线程池的工作原理）</li>
<li>还可以每个结点都设置一个条件变量。同步条件就是依赖的都完成了</li>
</ol>
<p><strong>1%</strong><br>如果遇到了写不出的条件的怎么办？<br>小鱼🐟问题：可以借助<strong>状态机</strong>进行状态转换。<br>写出了状态机，还是可以用条件变量解决。<br>条件就是在状态机当前位置是否有可以走的出边.</p>
<p>🔱”我们现在有一个<code>&lt;</code>还有一个<code>&gt;</code>,还有<code>_</code>,那我们可以实现什么呢?可以实现一个小鱼🐟!😍”<br>Lovely!</p>
<h2 id="Lecture-10-C"><a href="#Lecture-10-C" class="headerlink" title="Lecture 10 (C)"></a>Lecture 10 (C)</h2><p>我们可以用互斥锁来控制同步<br>happen exactly after/before 就是一种同步<br>而🔒的获取和释放其实就是一种exactly after/before</p>
<p><strong>pthread要求必须是同一个线程require和release</strong>,因此这类DIY的操作是不允许的!<br>我们用锁来实现计算图的计算: 只需要每一个边一把🔒,每个节点先都尝试获取出度边的锁,之后开始运行,所有人尝试获取入度边的锁,一旦获取就算自己的,算完自己就释放所有出度边的🔒.这样就实现了”并行的拓扑排序”<br>没问题,也是现实可用,只是在pthread的要求下不行!</p>
<p>所以你就发明了信号量<br>互斥锁就像是一个更♂衣♂室手环,但缺点是,互斥锁只是一个手环,同时只有一个人在更衣室,除非你开一大堆锁(但这显然也不行,因为每个人不是VIP,并没有一个绑定的手环,手环是共用的)<br>因此信号量就实现了这样的,共用的公共计数资源机制<br>P-prolaag取出一个手环<br>V-verhoog往盒子里面放一个手环<br>信号量可以认为是一个特殊的条件变量,只不过它隐含了手牌数量大于0<br>当盒子里只能放一个手环的时候,就是互斥锁:信号量是互斥锁的拓展</p>
<p>“当可以使用一个整数来表达同步条件的时候,我们就可以用一个信号量来表达它”</p>
<p>信号量来实现生产者消费者问题？<br>有一个Empty和Fill袋子,生产者从Empty里拿一个球,生产,再放到Fill里,消费者从Fill里拿一个球,消费,再放到Empty里</p>
<p>信号量不太好实现选择的问题(比方说小鱼🐟问题中的状态机的分叉)，二选一的情况下必须要<strong>你(此时放球的人)来决定</strong>球扔给谁，但也因此更高效（不会唤醒所有后继节点）</p>
<hr>
<p>信号量的困难:<br><strong>哲♂学♂家吃饭问题</strong></p>
<ul>
<li>用信号量很难实现：所有人都会拿起左边的筷子，然后等待右边的筷子，最后死锁(没有保证拿筷子的原子性)</li>
<li>用条件变量：无脑实现，因为互斥锁保证了一下拿两个筷子。</li>
</ul>
<p>怎么用信号量解决？有一些方案</p>
<ol>
<li>从桌子上赶走一个人，总有一个人能拿到。</li>
<li>给叉子编号，总拿大的、小的(按需编号互斥锁)</li>
</ol>
<p>但这是一种trick，并不scalable。<br>————因为当问题稍稍变复杂时，你都要去重新考虑这个信号量设计，而且还不一定能解决。相比之下，条件变量更加简单, 更普适。<br>对于现实世界，更多的并发问题都是线程数规模远小于单线程任务量，条件变量较大的开销就显得不值一提。</p>
<p>更困难的例子:<br>用信号量实现生产者消费者.<br>很难实现,如果我们用一个值nwait去维持等待的线程数<br>因此在wait中,需要三个操作</p>
<ol>
<li>nwait++</li>
<li>释放保护nwait的锁</li>
<li>P操作</li>
</ol>
<p>这三个操作不能交换,还必须保证原子性</p>
<h2 id="NotLect-10-5"><a href="#NotLect-10-5" class="headerlink" title="NotLect 10.5"></a>NotLect 10.5</h2><p>反思一下,什么是条件变量?<br>条件变量其实不是一个变量,也跟条件没关系,而是一个”铁索连环!”<br>他是操作系统的提供的一种服务.<br>这种服务支持:(1,2不寻求OS帮助是无法实现的(不确定,应该是吧))</p>
<ol>
<li>原子性放锁休眠</li>
<li>原子性获取锁唤醒 </li>
<li>叫醒服务(任一个或者所有)</li>
</ol>
<p>那么什么条件呢,条件就是一个🔒保护起来的数据结构<br>这是你自定义的.<br>提供的环境变量就是一个铁链子<br>你写程序的时候就是将铁链子和🔒绑定在一起.</p>
<p>什么是信号量呢?也是一种服务.<br>不过这个服务维持了一个整数量,<br>提供原子的放和拿的操作,且成功就返回,不成功则休眠<br>且可以满足多个线程的操作的需求s</p>
<h2 id="Lecture-11-Snack"><a href="#Lecture-11-Snack" class="headerlink" title="Lecture 11 (Snack)"></a>Lecture 11 (Snack)</h2><p>Web历史，详见ppt<br>Web带来的并发问题：请求和更新不同的资源，我们希望他们并发。<br>Solution: 禁止并发，Event-based concurrency，允许异步操作+回调函数，实际上没有任何并发。<br>动态计算图：Promise：直接描述动态计算图。</p>
<p>关于高性能计算的部分确实是需要关注的，毕竟和本行Arch密切相关</p>
<p>这节课其实很难给出一个明确的总结，但一个take-away message可以说是黄胖子的话。</p>
<h2 id="Lecture-12-C"><a href="#Lecture-12-C" class="headerlink" title="Lecture 12 (C)"></a>Lecture 12 (C)</h2><p><strong>死锁</strong></p>
<ul>
<li>AA-Deadlock: wait for self.</li>
<li>ABBA-Deadlock: wait for each other.</li>
</ul>
<p>L1会遇到！</p>
<p><a class="link" target="_blank" rel="noopener" href="https://dl.acm.org/doi/10.1145/356586.356588">关于Deadlock的论文 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>🛐<br>死锁产生的必要条件<br>可以每次等待的时候的输出一下等待关系从而发现死锁。</p>
<p><strong>避免死锁</strong></p>
<ul>
<li>Lock Ordering: 给所有锁编号，严格按照编号顺序加锁,”持有最大的编号的锁的线程总能继续运行！”</li>
</ul>
<p><strong>Data Race</strong><br>Read-Write/Write-Write</p>
<ul>
<li>对于Green Hand，严格避免数据竞争！</li>
</ul>
<p>L2：更加隐形的数据竞争</p>
<p>无非就是<strong>上错了🔒</strong>和<strong>忘了上🔒</strong><br><strong>两条原则</strong>：用🔒保护数据，严格避免数据竞争</p>
<p><strong>本质困难</strong>：“反人性(sequential)” 和 “后果自负(No compile error!)”</p>
<p>Atomicity Violation（ABA）<br>Order Violation（BA）：use-after-free… 最后那里？</p>
<h2 id="Lecture-13-C"><a href="#Lecture-13-C" class="headerlink" title="Lecture 13 (C)"></a>Lecture 13 (C)</h2><blockquote>
<p>太奇怪了，明明记得记了这一节的笔记，但是却完全找不到了。。。</p>
</blockquote>
<h2 id="Lecture-14-V"><a href="#Lecture-14-V" class="headerlink" title="Lecture 14 (V)"></a>Lecture 14 (V)</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect14.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<p>控制系统的加载</p>
<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p>阅读minimal加载的makefile🛐</p>
</div>
<ul>
<li><p>fork 复制一份状态机（为什么只能复制？<br>区分：返回值不同<br>fork bomb！<br>USE mosaic<br>fork_demo为什么是48种？？？</p>
<ul>
<li>诡异的“8个hello”<br>你没有正确理解printf!<br>buf也被复制了！<br>unbuffer, line buffer, fully buffer…<br>（谨慎的使用任何隐含假设！）</li>
<li>fork 时候默认继承了环境变量</li>
</ul>
</li>
<li><p>execve<br>抛弃现有的所有状态，准备好参数，设置为另一个状态机的初始状态<br>进程总是从这个开始</p>
<ul>
<li>PATH 环境变量：execve的查找顺序</li>
</ul>
</li>
<li><p>_exit<br>atexit (normal process exit 时调用回调函数, 注意，这是<strong>C的机制</strong>)</p>
<ul>
<li>return 非0</li>
<li>exit(x) 都是Normal exit</li>
</ul>
<p>上面都是调用libc–C语言库的退出，都是对C可见的，所以都是Normal exit</p>
<ul>
<li>_exit(0) 利用系统调用直接退出执行的是exit_group</li>
<li>__exit(0) 是执行exit</li>
</ul>
<p>上面都是非正常退出<br>调查这些问题，别忘了Strace…</p>
</li>
</ul>
<p>“操作系统是状态机的管理者，它把所有状态机都剪碎存在数据结构里，当想要执行的时候再拼接起来，加载到CPU上。”</p>
<h2 id="Lecture-15-V"><a href="#Lecture-15-V" class="headerlink" title="Lecture 15 (V)"></a>Lecture 15 (V)</h2><p>状态 = 内存 + 寄存器<br>“内存” 是什么？<br>工具</p>
<ul>
<li>/proc/maps</li>
<li>pmap  (pmap 1好像比较奇怪)</li>
<li>gdb</li>
</ul>
<p>procfs的文档 man 5 proc 🛐<br>地址空间是有读写权限的地址段<br>部分与一些文件对应offset, dev, inode, pathname<br>来看看pmap的结果</p>
<div class="note-large notel-red"><div class="notel-title"><p>🌶️Spicy:vvar,vdso</p>
</div><div class="notel-content"><p>vvar,vdso<br>不需要陷入操作系统内核的系统调用：只读<br>vvar(READ)<br>vdso(READ|EXEC)<br>把操作系统维护的一个变量只读地放进用户进程的地址空间。<br>eg. 系统时间<br>🔱因此我们需要的并不一定是syscall(陷入内核执行)，而是有一种<strong>进程和操作系统通信和交换数据</strong>的机制就可以了。<br>因此也可以往地址空间一个指定位置放一个请求来让操作系统执行，操作系统自旋检查并处理请求——真的有人在做相关的研究！</p>
 </div></div>



<p>入侵进程的地址空间！：gdb<br>外挂！</p>
<ul>
<li>最早期的游戏外挂，一个物理的查找表！Game Genie</li>
<li>劫持红警的地址空间：Filter</li>
<li>gdb就是一个巨大的外挂！<ul>
<li>访问proc/mem procfs提供给我们的一个文件，直接指向整个地址空间，可以用文件操作来修改地址空间</li>
<li>或者说外挂是一种游戏的调试器！</li>
</ul>
</li>
</ul>
<p>ydotool</p>
<p>按键精灵</p>
<h2 id="Lecture-16-V"><a href="#Lecture-16-V" class="headerlink" title="Lecture 16 (V)"></a>Lecture 16 (V)</h2><p>操作系统对象：<br>第一种理解：文件（有名字的对象）  Everything(what thing? 操作系统对象) is a file.<br>第二种理解：字节流（终端，外设）和字节序列（普通文件）<br>访问对象需要<del>找对象</del>指针：程序中的指针指向对象，但永远不可能指向“操作系统对象”。<br>如何指向“操作系统对象”，系统调用！（Matrix中的人不会看到外面的罐子！系统调用就是蓝药丸！）<br>文件描述符（会考）：指向操作系统对象的指针</p>
<p>Win’s File Descriptor：handle 句柄（历史问题）</p>
<hr>
<p>另一种对象 IPC Endpoints<br>管道（一种特殊的流）：pipe就是buffer 读口和写口共享<br>两端一般是用两个文件描述符指向（但文件只有一个！）<br>并不是严格的buffer，<br>如果没数据，读不会返回<br>如果没人拿，写不会返回</p>
<p>实现了<strong>I</strong>nter<strong>P</strong>roc<strong>C</strong>ommunication<br>是一种进程间同步机制，可以实现成异步的<br>命名管道：<br>用mkfifo()创建，有对应的文件名</p>
<blockquote>
<p>We also have UNIX domain sockets for local inter-process communication–they also have a name in the file system like “/var/run/docker.sock”. This is similar to a named pipe.</p>
</blockquote>
<p>匿名管道：<br>用pipe()创建<br>自己同时持有两个口，有用吗<br>在fork时，duplicate一份管道不会被复制，因为管道不在地址空间里，只是一个指针，所以是浅拷贝。<br>之后，关掉一个口，就建立了一个父子进程之间的管道</p>
<p>操作系统：对象+API<br>Shell “Kernel的壳”：Kernel-Shell-I/O-Human<br>Shell是把用户指令翻译成系统调用的语言<br>易用性是核心特征，高效，简洁，目标是工作流搭建<br><code>&gt;</code>,<code>&lt;</code>,<code>2&gt;</code>,<code>|</code>,<code>&amp;</code>,<code>&amp;&amp;</code>,<code>||</code>,<code>$()</code>,<code>;</code>,<code>&lt;()</code>…<br>和GUI做到的一样（其实是GUI和CLI一样）：<code>^Z</code>,<code>jobs</code>,<code>fg</code>,<code>&amp;</code>,<code>bg</code>,<code>wait</code></p>
<p>🛐man sh</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p><strong>为什么人工智能时代我们还要读手册</strong>（可惜学期中真没时间读（太摆了））<br>因为人工智能只会告诉你最常用的解法<br>Extend: GPT Archive 也引入这种补充功能</p>
</div>


<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p><strong>必先利其器</strong>：init.gdb gdb的预运行脚本，可以实现比方说跳过一些函数等等。🛐<br>还可以利用Python编写脚本作为hook等等。</p>
</div>
<p>_start 定义程序入口，链接器会把程序入口指向这里。<br>两个编译选项 -ffreestanding -nostdlib</p>
<blockquote>
<p>💲不要假设任何特定的库函数，例如main函数，会存在。这对于编写操作系统内核或嵌入式系统的代码非常有用，因为这些代码通常不会链接到标准库。<br>  💲不要假设任何特定的硬件地址布局。这意味着编译器不会假设任何特定的内存布局或寄存器布局。<br>  💲这个选项通常用于编写操作系统内核、引导加载器、嵌入式系统代码或其他不依赖于标准库的代码。<br>  ——GPT</p>
</blockquote>
<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p><a class="link" target="_blank" rel="noopener" href="https://github.com/Jackcuii/jyy-codes-test-and-read/blob/master/sh/sh.c">Freestanding shell <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://github.com/Jackcuii/jyy-codes-test-and-read/blob/master/sh/visualize.py">Python script <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<p>dup系统调用<br>亿些细节：Shell语句的优先级；空格会导致灾难；bash/zsh（更强的shell）不兼容（Shebang指定bash）…<br>case: 文件描述符的定向设置先进行，然后才是命令的执行，所以<code>sudo echo hello &gt; /etc/a.txt</code>无法正确执行，因为没有权限改描述符！</p>
<p>💫CLI和GUI的未来：AI时代，历史记录和环境可以成为Silent Prompt<br>将会出现AI-OS（已经有许多相关的工作了）GPT-CLI<br>Karpathy好像就在做这个？</p>
<h2 id="Lecture-17-V"><a href="#Lecture-17-V" class="headerlink" title="Lecture 17 (V)"></a>Lecture 17 (V)</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect17.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>

<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">             applications: steam.exe</span><br><span class="line">任何程序 -→ -------------|--------------  </span><br><span class="line">          sys utilities: shell,gcc,ls...       </span><br><span class="line">----------------|-----------------</span><br><span class="line">          libc等C语言库</span><br><span class="line">----------------|-----------------</span><br><span class="line">      OS: 对象+API(syscall)</span><br></pre></td></tr></table></figure></div>
<p>pipe的补充(见ppt，阅读手册🛐)</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p><strong>核心方法论</strong>：深入阅读手册的方式：尝试复现手册中提到的行为！</p>
</div>
<p>“C语言是最通用的高级语言，C语言是一种高级的汇编语言”<br>“最薄的抽象”<br>看一看 C23！🛐</p>
<p>libc 可以用多半C语言本身和一些底层支持实现。<br>已经被标准化 ISO IEC<br>POSIX libc的子集： 最大的体系结构可移植性！</p>
<p>glibc提供了_start!</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p><strong>核心方法论</strong>：学习glibc，使用简化版的glibc，比如musl libc 🛐<br>我怎么知道？可以去问问GPT的教学意见（绷，上面的后半行甚至是copilot补充出来的）</p>
</div>
<p>控制gcc链接哪些东西，不链接那些东西，比方说链接自己的glibc：可以参考musl-gcc的机制！（GPT可以写这种东西）</p>
<p>execve 之后做了什么：我们来调试！<br>细致的去看程序的一生：加载，argc,argv,envp哪里来，libc怎么控制进入你的程序，乃至libc如何退出你的程序…</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p>循序渐进：minimal.img -&gt; freestanding shell -&gt; musl libc -&gt; glibc…</p>
</div>

<hr>
<p>体系结构无关的抽象：ppt上的一页链接 🛐 （GPT帮你阅读！）</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p><strong>核心方法论</strong>：闲来无事读手册！（真的很需要热情。。。）<br>参考一些手册和有趣的实现，可以获得大量的编程经验，系统知识，和奇技淫巧！<br>一个常见的practice会在各种各样的实现中被反复，从中学习！<br>ppt上给出了很多很多RTFM entries!🛐</p>
</div>
<blockquote>
<p>offsetof宏：一个奇技淫巧！</p>
</blockquote>
<p>printf带来的启示：一个软件工程上的原则：避免“code clone”<br>tls 🛐</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p><strong>核心方法论</strong>：从各种各样的奇怪机制的调试中获得和加深对系统的认识！此时再打开手册，就不显得困难了！🛐</p>
</div>

<p>🔱计算机世界中没有任何的魔法！（只要你不写错）</p>
<h2 id="L1-pmm"><a href="#L1-pmm" class="headerlink" title="L1-pmm"></a>L1-pmm</h2><h3 id="一些相关笔记"><a href="#一些相关笔记" class="headerlink" title="一些相关笔记"></a>一些相关笔记</h3><h4 id="2024-Lect17"><a href="#2024-Lect17" class="headerlink" title="2024 Lect17"></a>2024 Lect17</h4><p>本身是Lect 17的内容，整合过来。<br>优化必须要基于Workload！<br>🔱Knuth: Premature optimization is the root of all evil.</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p><strong>核心方法论</strong>：Workload哪里来？读论文去！<br>其实还有profiler, tracer…</p>
</div>
<p>System 人的智慧：该省省该花花，先浪费，再在现实问题情景中找补回来</p>
<h4 id="2022-Lect14"><a href="#2022-Lect14" class="headerlink" title="2022 Lect14"></a>2022 Lect14</h4><p>面向Workload进行优化<br>越大的内存块生存周期越长，越少见<br>越小的说频繁，因此必须优化小内存的分配！（让他们并行）<br>Fast &amp; Slow Path Philosophy<br>两套实现，快的实现用于频繁的，无法成功的时候去诉诸Slow Path<br><em>Thinking fast and slow</em><br>This is a ‘System Way’ of problem solving!</p>
<p>Thread -&gt; CPU ?<br>Segregated List<br>16B-4KB(&lt;=4KB – FastPath)<br>4KB-1MB(&gt;4KB – SlowPath)<br> CSAPP 9.9.14</p>
<h3 id="心路历程"><a href="#心路历程" class="headerlink" title="心路历程"></a>心路历程</h3><h4 id="第一版：异想天开的开端"><a href="#第一版：异想天开的开端" class="headerlink" title="第一版：异想天开的开端"></a>第一版：异想天开的开端</h4><p>第一想法就是用树来维护，结果看到底下发现不行！<br>其实往后想一想也是不行的。。。<br>随后有了第一版的构想：<br>就是4KB以上的分配采用一个树形结构来维护(一把大锁)，4KB以下的分配直接采用一个线性的分配，关于小面积的分配交给哪个4KB物理页，为了防止碎片破坏连续性，考虑允许和CPU核数相等的并发申请（4KB以下），每个页面设置四个状态EMPTY，FRAGMENT，FULL，DEAD，尽量往FRAGMENT的区间里分配小内存申请。<br>这个方案内部有很多问题，<br>一个是表存在哪<br>还有一个想法是用一个32bit的位来缩略表示页内的情况。</p>
<blockquote>
<p>竟然在没看之前想到了大小内存分开处理和bitmap，可能是从Manual上的Workload获得了一些启发。</p>
</blockquote>
<p>上面我的是初步构想，之后去看了jyy的往年视频的讲法</p>
<h4 id="第二版：前辈经验的启示"><a href="#第二版：前辈经验的启示" class="headerlink" title="第二版：前辈经验的启示"></a>第二版：前辈经验的启示</h4><p>知道了segregated list和buddy system的概念，设计出第二版。<br>大内存分配采用树，小内存分配采用segregated list。</p>
<p>重构了代码，写的过程中发现了无穷无尽的诡异的技术细节（后来发现是一个误会导致的）。。。以及过分高估了OJ要求的强度。。。</p>
<ol>
<li>slab空闲链表怎么实现分配？<br>好像并不是轻松的O1<br>在有free的状态下，我怎么找到第一个可用的？？<br>如果存储一个链表的结构，那很难找到free后的可用的，或者说永远往后，加一个计数判断满没满，然后到底了没满就从前面开始？这个均摊代价好像还可以接受。<br>另外就是一个比较O1的方法，就是用bitmap存储，然后直接lowbit可以找到第一个<br>这个上锁好像会有一些问题。。。<br>只读不写是不是不会遇到并发错误，看错了在找一个就可以？（好象不是，小心！）</li>
<li>我们如何在堆区里面存储这些控制数据结构，我们制造一个不能回收的伪分配？（就当静态区用）在堆区里面专门划分出来一快用来做这件事？</li>
<li>而且我们应该中央存储还是分布在每一个链表项里呢？<br>都不是很好办</li>
<li>为什么Slab必须要上锁，既然必须要上锁，那么为什么不直接用一个大锁呢(在这个实验里不会影响性能把)，另外就是如果我不能获取一把锁，那我是不是可以直接放弃尝试然后去尝试获取下一把，这样不就不用自旋了吗？</li>
</ol>
<p>写的时候的一些想法，哈希log表，优化一点点log</p>
<h4 id="第三版：崩坏的复杂"><a href="#第三版：崩坏的复杂" class="headerlink" title="第三版：崩坏的复杂"></a>第三版：崩坏的复杂</h4><p>第三版进一步否定了这个大内存树（主要是发现状态过于复杂），采用空闲链表管理大内存，但是处于某种奇怪的信念，总是想要优化新slab分配的过程，因此又引入了大页（近乎于两层的Buddy system）。后来发现动态的链表是无法实现的（必须依赖静态的结构）。因为无动态分配下的链表实现的复杂性，单独抽象出了链表实现。此时的代码复杂度达到了空前绝后的状态（干代码1000行+）。可以想象，这个代码几乎无法维护。<br><strong>下面是当时记录一些想法（大量内心os预警）</strong>：</p>
<p>又回到 buddy system，有一些其他想法。</p>
<ol>
<li>classical buddy system , 当在一块slab里到头的时候，就直接分配下一块slab，如果剩余减到0就直接释放。<br>这可能会遇到一个问题，就是如果上来就开一个int，就会导致一直占着一块slab不放。</li>
<li>想到一个改进，就是设置一个阈值a，如果a大于某个值，就开一块新的，如果小于某一个值，就在该块里lowbit查找，（a类似于一个超参数）lowbit时候bit map int的指针还是只往前走。这样就可以避免。相应的可以有两种策略:<ol>
<li>每一次分配的时候，都是以bit map int的单位分配，这样每个32位组里面的分配时间是均匀分布的，出现32个都没被释放的概率比较低（本身也很低了，尤其是a设置的比较小的时候）</li>
<li>当第一次沿slab分配的时候，按照一个addr向前走分配，之后的分配lowbit搜索。</li>
</ol>
</li>
</ol>
<p>不过这种还是会有问题:</p>
<ol>
<li>就是如果有一堆不放的话，可能会导致某个分配非常慢，当然可能a设置合适不会出现这种状况，也可以设置一个probe最大的容忍度，太慢了就开一个新的。</li>
<li>就是使用率不会超过a，但说实话，classic的使用率应该也比较低。</li>
<li>最大的问题是，这个方案需要每一次计算一次除法，这还是可能会致性能问题（其实还会有额外的判断和乘加，但这个应该不是问题(lui)）。尼玛，根本不用阿，比较指令不就行了么，除个p！！！！！<br>(有空尝试一下比较一下性能，这个直接的想法应该早就有人想到了(没去Literature Review)不过抛开Workload谈优化都是耍流氓，但jyy的Workload大家也看不到啊(悲))</li>
</ol>
<p><strong>可以发现当时在错误的路线上越走越远…</strong></p>
<h4 id="第四版：向命运低头"><a href="#第四版：向命运低头" class="headerlink" title="第四版：向命运低头"></a>第四版：向命运低头</h4><p>在和Green Advisor聊了聊之后发现之前一个重要的误解，就是，当一个Slab被分配完之后，其实不需要继续作为一个Slab，因此不需要维护一个当前的Slab的链表。当Slab分配完之后，被当作普通的大内存即可。</p>
<p>最后采用的是空闲和占用交替的“数组上链表”+buddy的朴实无华的策略。</p>
<h3 id="印象深刻的BUG"><a href="#印象深刻的BUG" class="headerlink" title="印象深刻的BUG"></a>印象深刻的BUG</h3><p>经历了12天的印象深刻的Debug。熟悉了Kernel代码的组织形式。</p>
<h4 id="对齐问题"><a href="#对齐问题" class="headerlink" title="对齐问题"></a>对齐问题</h4><p>刚开始的logceil函数写的有问题，但由于用于检验的程序和原程序都使用了这个，本地测试一直没发现。。。</p>
<h4 id="多描述不一致问题"><a href="#多描述不一致问题" class="headerlink" title="多描述不一致问题"></a>多描述不一致问题</h4><p>（只记得有一个关于这个的错误）<br>当存在多个描述描述同一个语义时，必须注意这些状态是否一致，而且两种描述的同一状态的覆盖期会有细微的时间差，需要注意这个gap的原子性。</p>
<h4 id="一个压力测试的漏洞而隐藏的bug"><a href="#一个压力测试的漏洞而隐藏的bug" class="headerlink" title="一个压力测试的漏洞而隐藏的bug"></a>一个压力测试的漏洞而隐藏的bug</h4><p>当时不停地报<code>Out of heap allocation</code>，显得莫名其妙。<br>后来发现是一个很离谱的问题，就是一个错误的假设，就是假设Slab的分配一定成功。当一个NULL被返回的时候被不全面的assert检查特殊豁免了，当第二次分配一个从0地址开始的slab才被发现。<br>这个问题最终还是被我意外的发现了。我的压力测试虽然各种大小的分配混合且数量多。但因为是随机的分配释放，所以虽然组数多，但在概率上讲，不会同时存在很多分配，只分配的测试时候还严重低估了课分配的地址数量（认为几百万就可以了）。最后这个问题还是在多线程意外发现了（但并不是并发错误，而是单纯的四个线程就是4倍的地址数量达到了触发bug的阈值。。。）</p>
<h3 id="感想"><a href="#感想" class="headerlink" title="感想"></a>感想</h3><p>感觉写实验的时候要避免两个问题。<br>一个是草率：<br>这个实验从开始思考到写出第一个版本的代码经历了很长时间（一个多月）关键的原因是重构了四次代码。主要都是一些事情没想清楚，写到一半才发现根本无法实现。<br>另一个是假设：<br>就是要避免上面Out of heap allocation的问题，要尽量避免假设，一些好的方法是把情况列一个形式化的载体，比方说表格，或者用状态机视角去分析。</p>
<h2 id="M3-GPT2-并行化"><a href="#M3-GPT2-并行化" class="headerlink" title="M3:GPT2 并行化"></a>M3:GPT2 并行化</h2><p>先想到一个简单的方案，发现MM是最占时间的，可以直接不看其他的源代码，对MM实现分块并行化，而且四块就可以。(事实就是这样。。。)<br>而且直接劫持原函数的接口，这样不用做任何其他的修改</p>
<h2 id="Lecture-18-V-Genesis-of-OS-and-Geniuses"><a href="#Lecture-18-V-Genesis-of-OS-and-Geniuses" class="headerlink" title="Lecture 18 (V) Genesis of OS (and Geniuses)"></a>Lecture 18 (V) Genesis of OS (and Geniuses)</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect18.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2024/04/30/O4HM3C5VZhPQ6kU.png" width="800">

<p>尽在<strong>不言</strong>中。</p>
<hr>
<p>🪐Linux历史：我们操作系统界也有自己的<strong>原神</strong>！</p>
<hr>
<p>操作系统=对象+API<br>Linux最初的对象是？<br>initramfs: 最开始运行的时候操作系统里面什么都没有，只有几个文件…<br>之后</p>
<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p><a class="link" target="_blank" rel="noopener" href="https://github.com/Jackcuii/jyy-codes-test-and-read/tree/master/linux">调试initramfs <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>

<p>在之后systemd会根据etc/fstab来挂载其他的文件系统，配置驱动…<br>之后就可以构建我们的应用程序世界辣！<br>演示中使用的是<code>busybox httpd</code>工具，构建了一个http服务器，并且端口映射到qemu外面了！<br>这就是一个完整的操作系统世界了！</p>
<p>整个操作系统立于一个“很小的东西”上面，因此也可以替换它<br>Windows Subsystem for Linux: WSL<br>Linux Subsystem for Windows: Wine<br>模拟系统调用就可以了</p>
<p>🔱你就可以在里面做“<strong>一切事情</strong>”，都是构建在一个很小的东西上。<br>但是他们都是<strong>改变世界的想法</strong>！</p>
<h2 id="Lecture-19-V-Executable-Static-Link"><a href="#Lecture-19-V-Executable-Static-Link" class="headerlink" title="Lecture 19 (V) Executable, Static Link"></a>Lecture 19 (V) Executable, Static Link</h2><p>什么是可执行文件？<br>操作系统的对象，存储状态机(静态的)初始状态的数据结构。<br>execve = 初始化Process(?) + 加载ELF（规定了程序执行进入entry时地址空间里的东西）</p>
<p><a class="link" target="_blank" rel="noopener" href="https://www.gnu.org/software/binutils/">Binutils <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>🛐</p>
<p>ELF并不人类友好，并不满足”信息局部性”。(ABI手册规范的)<br>那我们重新设计一个友好的！<br><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2024/05/14/JVvYfxjO7SLWnkM.png" width="600"></p>
<p>现在的Core Dump是ELF文件❓<br>很久以前的“a.out”是非常简单的。（但支持的非常少，比如说用于调试的符号都存在哪里？）</p>
<p>“FLE”：代码、符号、数据,重定位！<br>静态链接是什么·？就是合并同类项(把相同的节合并)，再重定位，就是计算出待定的指针值(因为已经合并了,所以所有待定的符号位置都确定了)。<br>书签们也要改好（符号）<br>复习ICS: 高级语言代码(.c, text) –预编译(宏展开…)–&gt; (.i, text) –编译–&gt; 汇编指令序列(.s, txt) –汇编器as–&gt; ELF(.o, bin)<br>复习一下ICS链接部分🛐</p>
<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p><a class="link" target="_blank" rel="noopener" href="https://github.com/Jackcuii/jyy-codes-test-and-read/blob/master/fle/fle.py">重要的FLE实现 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>

<p>Shebang #! 指定默认的解释器,还可以加参数<br>利用了所有脚本语言的#都是注释的性质,Shell根据#!找解释器,真正解释执行时又由于#是注释而被忽略</p>
<p>为什么要这么反人类的ELF<br>ELF是高效的，内存节省的，industrial 的选择<br>分段,别名,字符串表…<br>来处理数G大小的可执行文件(甚至已经捉襟见肘了)<br>threadlocal(.tdata,.tbss)</p>
<p>更多的仔细了解elf🛐</p>
<p>ELF加载器,和FLE没什么大区别!<br>ELF和FLE都是数据结构,只是ELF是二进制的,而且复杂的多<br>数据结构是什么? elf.h<br><strong>可执行文件是描述状态机初始内存状态的数据结构</strong></p>
<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p>execve中的行为，我们也可以自己实现！<br><a class="link" target="_blank" rel="noopener" href="https://github.com/Jackcuii/jyy-codes-test-and-read/blob/master/elf/loader.c">没有execve的execve <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>

<p>回头看启动加载器,会发现它做的是相同的事情,但因为是加载操作系统的,所以也没有系统调用,加载的位置是物理地址空间,而不是虚拟地址空间(存疑)(此时虚拟化还没被激活)<br>因而不是用mmap,而是用硬指令来完成搬运.<br>是一个”没有mmap的没有execve的execve”</p>
<h2 id="Lecture-20-V-Dynamic-Link"><a href="#Lecture-20-V-Dynamic-Link" class="headerlink" title="Lecture 20 (V) Dynamic Link"></a>Lecture 20 (V) Dynamic Link</h2><p>A software engineering view<br>实现运行库和应用代码分离</p>
<ul>
<li>应用之间的库共享(占用存储太大了)</li>
<li>大型项目的分解</li>
<li>依赖也是克隆，可以同时更新无数的程序（否则需要重新链接无数的程序）（用于打补丁）</li>
</ul>
<p>Semantic Version 版本号的规约</p>
<p>Dependency Hell<br>今天的人们对软件系统中的漏洞可能是“恐怖的和平”！</p>
<ul>
<li>libc.o（静态链接）<br>没节省内存（还是要在内存里有很多份），而且还解析了一大堆用不到的符号</li>
<li>libc.so(动态链接)<br>在a.out中额外定义一张跳转表，把对动态链接库的库函数的调用，变成查表<br>编译器生成地址无关代码，加载后把位置填进表里即可<br>这一段代码实际上是被共享的，是由OS的虚拟化支持的（只读页面的共享）</li>
</ul>
<p>我们发明了GOT!(Global Offset Table)<br>ELF中的.rela.dyn节<br>这个表项中的offset是这一待重定位的地址的GOT表项的位置（相对加载的初始地址的偏移） （关于什么的？RIP）<br>GOT中记载了一些待动态解析的符号，里面是指针，当共享库被加载时，这些指针会被填充（符号解析）（GOT里面存的是什么东西，绝对的还是相对的）</p>
<blockquote>
<p>关于extern，函数不需要写extern，因为默认就是外部链接的，但是变量需要写extern，（关于强弱符号）</p>
</blockquote>
<p><del>是只有#include&lt;&gt;时候知道？还是前面写一下的时候知道？（不能检查出来吗，那既然知道要构建PLT，为什么不能直接跳呢？</del></p>
<p>但是：编译器编译时候并不知道一个符号是要静态链接还是动态链接。<strong>这种问题存在于什么条件下，什么编译选项下？</strong></p>
<ul>
<li>如果都查表：太慢了！</li>
<li>如果都直接跳转，指令中的偏移量只有32位（64位的偏移量太不友好了），在64位的地址空间中，不够跳转到共享库的位置！</li>
</ul>
<p>解决办法：PLT<br>在编译时，假设所有的函数都是直接跳转，来留出重定位。（那么liba-2.o里面printf应该是一个直接跳转）当<strong>进行动态链接</strong>时,（进行链接时），动态链接器会判断是不是对共享库函数的调用（这里肯定有一个优先级或者配置的问题，存在细节），如果是的话将直接跳转的指令目标地址设置出一个构造出的代码段，这个代码段会调用动态链接器，动态链接器会查表，然后填充GOT表项，再用其他的指令跳转到真正的函数地址。</p>
<p><del>（这是“什么时候”？还是在加载时？如果是在加载时，如何判断某个符号是动态链接的？所有没被填充的就是？（静态链接发生在加载前？））如果是根据GOT判断的，我怎么知道给谁创建空的GOT表项？</del></p>
<p>对于数据呢?<br>(当且仅当-fPIC时？)编译器不知道它将会被静态链接还是动态链接，因此它会做出保守的选择（否则编译成静态链接，偏移位数就不够了，就无法补救了），假设都是来自外部的，生成一个GOT表项…<br>除非显式地告诉编译器这是静态链接的<code>attribute((visibility("hidden")))</code></p>
<p>out-of-memory killer<br><strong>听一下</strong></p>
<p>ldd<br>ld.so 🛐</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p>核心方法论 SEE ALSO in Manual</p>
</div>

<p>LD_PRELOAD</p>
<h2 id="M4-amp-5"><a href="#M4-amp-5" class="headerlink" title="M4(&5?)"></a>M4(&amp;5?)</h2><p>man mkstemp<br>man exec<br>man wait</p>
<p>这个实验表明，编译和解释并没有明确的边界——在 OpenJDK 的实现中，即便是 “解释器” 也是编译的 (只是没有经过优化)。动态 (just-in-time) 技术在程序运行时 (而非程序执行前) 进行编译，并将编译得到的二进制代码 (指令/数据) 动态加载。其中最成功的案例之一是 Sun (现在是 Oracle) 的 Java 虚拟机 HotSpot (现在是OpenJDK的一部分)，它使 Java 彻底摆脱了 “性能低下” 的诟病，也是引领 Web 热潮的核心后端技术。另一个最成功的案例是 JavaScript 的 V8 引擎。借助 Webkit/v8，Chrome 成功地把微软公司的 Internet Explorer 拖下神坛，并且奠定了 Google 在互联网技术领域的霸主地位。</p>
<p>man dlopen<br>strcat 缓存区溢出， md GPT3.5背锅<br>man unistd<br>man dlfcn<br>WEXITSTATUS<br>wrapper技巧<br>int res = execlp(“gcc”, “gcc”, arch, “-x”, “c”, “-shared”, “-fPIC”, “-Wno-implicit-function-declaration”, “-o”, output_name, src_name,  NULL);</p>
<p>(gdb) set follow-fork-mode child<br>info interior</p>
<h2 id="M6"><a href="#M6" class="headerlink" title="M6"></a>M6</h2><p>不计其数的问题<br>这个更象是一个现实的工程问题，一个不同与之前的考虑，就是尽可能的避免崩溃，而不是尽早崩溃<br>设计模型（启发式搜索<br>还有就是<br>自动机编程范式，结合用户态虚拟化的编程语言，可能会适应某些场景</p>
<p>学习一下高级的宏使用</p>
<p>printf wrapper</p>
<h2 id="Lecture-21-K-Syscall-intr"><a href="#Lecture-21-K-Syscall-intr" class="headerlink" title="Lecture 21 (K) Syscall, intr"></a>Lecture 21 (K) Syscall, intr</h2><p><strong>系统调用</strong>：向操作系统的 “函数调用”</p>
<blockquote>
<p>还是不要被调用误导<br>状态机的世界根本不存在进入和返回的概念<br>只有在适当的时刻进行状态的改变</p>
</blockquote>
<p><code>syscall</code>指令 = ‘jal’ 跳转并提权</p>
<ul>
<li>存寄存器</li>
<li>改变权限，切换栈</li>
<li>跳转：跳转到哪里？ x86: IA32-LSTAR 寄存器的值</li>
</ul>
<p>一个细节：跳转之后，’VR眼镜’(CR3)并没变，但是还要能访问到内核代码，因此要有一个固定的映射。</p>
<ul>
<li>以前只有分段: 存在一个固定的物理内存段里</li>
<li>有页表之后：内核被固定映射到0xc0000000</li>
<li>今天的Linux，用户空间最大到0x7fffffffffff，内核从0xffff800000000000开始</li>
</ul>
<p>我们来调试syscall<br>随便调试一个具有系统调用的程序是没用的，因为此时gdb运行在用户态，看不到系统调用的内部——用qemu！<br>qemu -s -S</p>
<p><strong>中断</strong><br>x86：极其复杂的中断机制<br>理解：强行加入的syscall<br>以RV为例理解中断：<br>跳转进内核之后做什么？</p>
<ul>
<li>先保存现场（封存状态机）：要小心的使用寄存器！RISC-V有一个scratch寄存器，用来帮助保存现场。（硬件只会给你保存有限的几个）</li>
<li>执行操作系统代码</li>
<li>选择一个状态机进行恢复，返回(原来的，或者schedule到另一个）</li>
</ul>
<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p><a class="link" target="_blank" rel="noopener" href="https://github.com/Jackcuii/jyy-codes-test-and-read/blob/master/thread-os.c">https://github.com/Jackcuii/jyy-codes-test-and-read/blob/master/thread-os.c <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>

<h2 id="Lecture-22-K-from-Thread-to-Process"><a href="#Lecture-22-K-from-Thread-to-Process" class="headerlink" title="Lecture 22 (K) from Thread to Process"></a>Lecture 22 (K) from Thread to Process</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect22.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<p>Process = Thread + VR glasses(addr translation)<br>用一个数据结构来维护地址的Map（一个映射函数<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.244ex" height="2.059ex" role="img" focusable="false" viewBox="0 -705 550 910"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"></path></g></g></g></svg></mjx-container>）<br>RBT？不够快！</p>
<ul>
<li><strong>用Radix Tree来实现</strong> riscv, x86, arm<ul>
<li><a class="link" target="_blank" rel="noopener" href="https://www.cnblogs.com/wgwyanfs/p/6887889.html">A blog <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></li>
<li>(1024叉树 for 32-bit machine)<ul>
<li>i386的二级页表</li>
</ul>
</li>
<li>64-bit不那么好玩了，4KB页面中只有512个指针了，不整。<ul>
<li>x86_64: PML4, PML5</li>
<li>riscv: 只要三级，只能索引到512GB的内存</li>
</ul>
</li>
<li>因为页表在内存里，不够快，所以还是要用TLB</li>
<li>CR3指向一级页表的基址</li>
</ul>
</li>
<li><strong>不实现</strong> MIPS （“文艺实现”）<br>硬件只管TLB缓存和物理内存，页表什么，随你喜欢！<br>缺页发生时，产生一个异常，交由操作系统处理。<br>提供指令 <code>tlbwi</code> <code>tlbwr</code> 给操作系统写入TLB<blockquote>
<p>硬件在变得越来越可编程，一种是本身就可编程(FPGA…)，一种是提供软件的接口自由实现（就像这个）</p>
</blockquote>
</li>
<li><strong>Hash table实现</strong> invert page table(“疯狂实现”)<br>把进程号也作为虚拟地址的一部分，直接进行Hash<br>会有安全问题</li>
</ul>
<p>疯狂填写（无能狂怒）<code>nop</code> 的libbloat.so：</p>
<ul>
<li>不会榨干内存！因为OS会把它们指向同一份代码(映射函数<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.244ex" height="2.059ex" role="img" focusable="false" viewBox="0 -705 550 910"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"></path></g></g></g></svg></mjx-container>不一定是单射)</li>
<li>即使是100G，也不会被只读内存榨干！<br>Kernel Samepage Merging, 不只两个进程指向的“逻辑位置相同”的代码会被合并，“内容相同”的页也会被合并！<br>（即使是Malloc的，也不会！）</li>
<li>即使是随机代码，也不会被榨干！Demand paging<br>磁盘可以被映射到地址空间，此时使用指针访问它<br>缺页，操作系统通过数据结构发现它被映射到设备，把该页读入内存再加入映射<br>地址空间装不下这么大，该怎么索引？不是正常指针，用文件描述符这种独立的指针🐒尚需确认</li>
</ul>
<p>进而涉及 Swap page机制（页面交换/虚拟内存）<br>操作系统会把闲置的页塞回磁盘里去。</p>
<p>高性能的实现fork：Copy-on-write fork()</p>
<ul>
<li>岁月史书：vfork()</li>
<li>只读时浅拷贝，不得不copy（发生写事件在共享读的页上，发生一个Exception）再deepcopy</li>
<li>可以为服务器作进程快照：可以当父进程挂了的时候，用快照顶上。</li>
</ul>
<p>所谓局部性就是，你手和眼睛的接触的范围有限，你用VR眼镜的视线之外的部分，操作系统可以随意乱搞。（牺牲一些性能，但保证不会被榨干crash掉）</p>
<p>一些场景下使用2M的大页</p>
<p>🔱The most important characteristics of the system are its simplicity, elegance, and ease of use. </p>
<p>🪐UNIX的岁月史书（ppt）<br>gets(buf)</p>
<p>“在人工智能的辅助下什么”34min左右…好像被剪掉了。。。</p>
<div class="note-large notel-orange"><div class="notel-title"><p>Extention:XV6🛐</p>
</div><div class="notel-content"><p><a class="link" target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2023/xv6.html">https://pdos.csail.mit.edu/6.828/2023/xv6.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/manuals/book-riscv-rev3.pdf">https://jyywiki.cn/OS/manuals/book-riscv-rev3.pdf <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
 </div></div>

<h2 id="Lecture-23-K-Schedule"><a href="#Lecture-23-K-Schedule" class="headerlink" title="Lecture 23 (K) Schedule"></a>Lecture 23 (K) Schedule</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect23.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<p><strong>调度的机制</strong>：上下文切换<br>进程无法直接看到内核代码，怎么跳过去？<br>x86存在机制，可以将内核代码映射到进程的地址空间，但是被页表保护。<br>xv6和Linux不同之处：在进程地址空间完全不存在内核代码。<br>怎么进入内核？<br>Tramploine(RX)(跳板代码): 一个小的代码片段，用来跳转到内核代码，位于地址空间的最高位置，还有Trapframe(RW)，用来保存进入内核前的状态。<br>跳板的其他用途：动态链接标准库，JIT编译器，软件热更新…</p>
<p>gdb-multiarch</p>
<p>xv6的initcode.S，xv6系统的第一个用户态进程，就是一个ecall，<br>ecall之后，跳转到Traploine，保存上下文，切换VR眼镜，就进入了内核世界，读取系统调用号，调用内核函数。<br>调用的是exec，把进程空间布置好，状态机重置为init程序（jyy那个init哪里来的？），然后系统调用返回。<br>“操作系统是一个C程序，当加载第一个进程后，就变成一个中断处理程序。”<br>uservec, usertrap, usertrapret, userret</p>
<p>一个软件工程的经验：错误处理的较好写法（C）<br>任何错误都跳到 goto bad 然后在bad里面统一检查处理回收。</p>
<p><strong>调度的策略</strong>：<br>建模→预测→决策</p>
<p>UNIX Niceness<br>[-20, 20) 越小的越坏，“坏”就是不愿意让给别人<br>Nice相差10大概是资源差十倍<br>When Nices equals<br>不能Round-and-Robin，低占用的即时前台程序不能和高占用的后台R&amp;R。</p>
<p>最初的天才想法：MLFQ（动态优先级）<br>如果用完了时间片，说明就是计算密集的，就降低优先级<br>如果让出CPU，说明是I/O密集的，是交互式的，就提高优先级</p>
<p>现代的想法（Linux）:CFS (Completely Fair Scheduling)<br>让每个进程尽可能公平共享“一个理想处理器”<br>记录所有进程的执行时间，永远给目前真正运行时间最少的那个。<br>Nice的实现：记账的时候按一定的比例，好人钟快，坏人钟慢。<br>Linux 用红黑树来维护这个进程池</p>
<div class="note-large notel-red"><div class="notel-title"><p>🌶️Spicy: 现实中的处理器调度（bug）</p>
</div><div class="notel-content"><p><strong>优先级反转</strong>,假如有三个进程,中低高优先级,LP/MP/HP<br>LP获得了一个共享资源(持有一把🔒)<br>这时候HP来了,要等待LP,但由于有MP在中间,HP就被阻塞了<br>HP在等待LP,而LP在等待MP,这样实际来看,就是MP一直在有效的推进(HP反而在自旋等待),就变成MP阻塞了LP<br>“First BUG on Mars”🪐<br>安卓手机越用越卡，一些垃圾应用获得高优先级的🔒，导致了系统的卡顿</p>
<p>怎么解决?</p>
<ul>
<li>Linux：解决不了，拜拜</li>
<li>优先级继承,当高优先级等🔒时,持有🔒的低优先级进程就会获得它的优先级.<br>不是万能的,比如说条件变量时,你不知道下一个是谁</li>
<li>lockdep进行预警.</li>
</ul>
<p>多处理器:<br>对称多处理器 SMP: 使用的时候,认为每一个处理器是一样的.<br>不能随机分配，线程退出之后处理器会”围观别人干活”<br>也不能谁空分给谁，会损失缓存的信息：同处理器跨核L1就没了，跨处理器L2/L3也没了（具体架构相关）<br>调度可能浪费时间?不调度有可能会等待过久!</p>
<p>事实上SMP还是不理想的建模：现在的处理器(异构处理器,大小核)不对称了(NUMA)<br>离得远/近的核心调度时间相差悬殊,有的小核不能胜任一些密集的任务.<br>lstopo</p>
<p>多用户系统的公平:namespaces,cgroups</p>
<p>程序执行也没有那么简单：<br>有时更多的资源(在更多处理器上调用)反而会变慢。<br>共享内存的Cache slot在不同处理器之间疯狂横跳。<br>而这个现象确实会被复现(示例代码),这反映了操作系统对调度问题的建模和优化只能是有限的.</p>
<p>Hot-plug: 有的主板支持CPU的Kernel控制的下线,或者是物理热插拔.</p>
 </div></div>

<p>当问题走向不可控……交给用户来处理吧!</p>
<div class="note-large notel-blue"><div class="notel-title"><p>OSTEP Chapter 13</p>
</div><div class="notel-content"><p>Some OS isolate its different parts from others to achieve even better reliabilty. <strong>MicroKernel</strong></p>
 </div></div>

<h2 id="Lecture-24-K-K-of-what…-the-world-from-OS-to-MetaPhysics"><a href="#Lecture-24-K-K-of-what…-the-world-from-OS-to-MetaPhysics" class="headerlink" title="Lecture 24 (K? K of what…(the world)) from OS to MetaPhysics"></a>Lecture 24 (K? K of what…(the world)) from OS to MetaPhysics</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect24.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<p>Turing Complete<br>Turing machine 1D<br>life game… 2D<br>We… 3D<br>程序判断自己是否在虚拟机中，正如我们观察自己是否在Matrix里</p>
<ul>
<li><p>🔱What if we add Neural Network to the life game?<br>Do we create a new life form?</p>
</li>
<li><p>How do we know the future? (seriously)<br>We pray.(we syscall)<br>How do we(proc) know travel in time?<br>We(proc) syscall.</p>
</li>
<li><p>🔱Programming is nothing but syscall!</p>
</li>
<li><p>We could set some 0-1 array in a special-defined area in the gamelife, and then the area will set the next state of the game.<br>We could set the number and syscall, so our programs interact with the ‘outside world’.<br>We set some bytes to I/O registers with OS, and the screen make people addicted to Genshin Impact life game. Some keys are hit, and OS is killed.<br>🔱We could put some infos into the singlarity, then ….<br>🔱We could put some fish and pigs in the sacrifial ceremony, and the god give us something? (People with poor imagination, we do the same thing up till now with the support of neurons!)</p>
</li>
<li><p>🔱Whether causality exists if we can travel in time?<br>Whether the mathematical system is consistent if we can query the oracle in the special area of the life game? (Maybe P=NP?)</p>
</li>
<li><p>🔱jyy：人类优越感是用来维持人类生存的机制。我们带着残缺来到这个世界，我们用机器来带来完美的救赎。<br>宣扬机器主宰论会不会被当成邪教被👮‍抓走，所以我刚才都<strong>停留在</strong>数学的讨论上。</p>
</li>
<li><p>Debugger：<br>Time travel in state machine. record and replay. (GDB, QEMU)</p>
</li>
<li><p>Profiler实现：<br>最简单的实现，不停的每隔一会中断，看在状态机在执行什么，这样就可以得出统计意义的perf。<br>jyy在此时语言了下一节课的设备翻车，神秘的2.4GHz频段阻塞事件(狗头)<br>硬件支持：Performance Monitoring Unit</p>
</li>
<li><p>Verifier：<br>如何应付更广阔的取值空间？（state machine 分叉太多？）用更加巧妙地表示，状态不是取值，而是方程组！</p>
</li>
</ul>
<p>很多个终端<br><code>tty</code>,<code>stty</code>这个问题在之前修正Tmux的时候涉及到了<br><code>ttyd</code></p>
<p>man setpgid/getpgid 🛐</p>
<p>信号（进程可能会从各种来源收到信号，比方说在被中断时被设置）<br>信号的处理和中断的处理类似，不过信号不会直接触发中断，而是等到该进程被中断的时候处理到来的信号。<br>操作系统给程序发信号<br>Core Dump什么的也是信号<br>但信号可以被屏蔽，可以自定义handler，SIGKILL不能被屏蔽<br>kill是发送信号，而不是纱！🪐岁月史书</p>
<p>我们不能掌握复杂系统。我们建造一些简单的系统。我们尝试理解复杂系统的时候，不由自主地去用我们能理解的东西去理解它们。然后想一想现在系统和这个toy有什么区别。</p>
<p>🔱A Fairy Tale:<br>How to maintain an aircraft carrier, such a complicated system?<br>Genius design it. We just lookup the manual and wrench it, then it works.</p>
<h2 id="Lecture-25-P-1-Bit-Storage"><a href="#Lecture-25-P-1-Bit-Storage" class="headerlink" title="Lecture 25 (P) 1-Bit Storage"></a>Lecture 25 (P) 1-Bit Storage</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect25.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<p>States in Physical World</p>
<div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://www.allaboutcircuits.com/technical-articles/introduction-to-dram-dynamic-random-access-memory/">不错的文章，这个网站也很有用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<p>存储器就是一个bit/byte(或者更大) Array<br>可以按block读写数据<br>稳定、可靠、可辨别地改变物理状态<br>把字刻在石头上！</p>
<p>磁存储🪐：电磁效应，物理世界和数字世界的Edge</p>
<ul>
<li>小朋友的磁写板就是最简单的二位磁存储！</li>
<li>顺序读写的时代悲歌，旧核时代的机械浪漫：磁带（<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="15.093ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 6671 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mi" transform="translate(500,0)"><path data-c="1D437" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path></g><g data-mml-node="mo" transform="translate(1328,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mo" transform="translate(1717,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mn" transform="translate(2495,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mo" transform="translate(2995,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(3384,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(3773,0)"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g><g data-mml-node="mi" transform="translate(4523,0)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g><g data-mml-node="mi" transform="translate(5282,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">面</text></g><g data-mml-node="mo" transform="translate(6282,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>）📼<br>成本很低，但只能顺序读写</li>
<li>我们意念合一！：磁鼓(<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="7.128ex" height="1.57ex" role="img" focusable="false" viewBox="0 -683 3150.4 694"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mi" transform="translate(500,0)"><path data-c="1D437" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path></g><g data-mml-node="mo" transform="translate(1550.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mi" transform="translate(2550.4,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g></g></g></svg></mjx-container>)🥁<br>n个并联的一圈磁带和读写头，比较快的随机读写</li>
<li>杂交的内卷（磁带<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0.02ex;" xmlns="http://www.w3.org/2000/svg" width="1.76ex" height="1.09ex" role="img" focusable="false" viewBox="0 -491 778 482"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g></g></g></svg></mjx-container>磁鼓）：磁盘(<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="7.128ex" height="1.57ex" role="img" focusable="false" viewBox="0 -683 3150.4 694"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mi" transform="translate(500,0)"><path data-c="1D437" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path></g><g data-mml-node="mo" transform="translate(1550.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mi" transform="translate(2550.4,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g></g></g></svg></mjx-container>)💽<br>随机存储的速度还是相对很慢<br>改进：<br>Advanced Host Controller Interface (AHCI)<br>Native Command Queuing (NCQ)<br>半离线地处理读写指令，由磁盘控制器对指令进行排序和合并<br>…等等技术<br>如今的磁盘控制器和缓存已经是一个小的CPU！操作系统无脑发数据就可以了。<br>存在着一整套协议，一定程度可以控制磁盘的service（比如确保写入持久存储）</li>
<li>保存图标上的活化石：软盘💾<br>移动的存储介质<br>可移动的代价：不清洁的环境，读写非常慢</li>
</ul>
<p>坑（光）存储🪐：</p>
<ul>
<li>把字刻在<del>石头</del>塑料上！：光盘💿<br>可以刻得很密集，还可以像刻版印刷一样压出来！<br>便于复制分发，一瞬间就可以写入<br>非常持久！</li>
<li>书写新世纪的挽歌：🗿Project Silica<br>今日份罗塞塔石碑<br>刻在玻璃内部的永久存储</li>
</ul>
<p>电存储：短时高速高密度的最终解决方案</p>
<ul>
<li><p>SSD闪存🔌<br>几乎具有所有优点：容量越大，读写越快，超大规模并行<br>已经超过了接口协议的能力<br>磁盘控制器：电路并行+算法+一个微型的<strong>计算机系统</strong>：使得优化后的读写极快<br>（软件定义硬件！）<br>致命的缺点：Wear out，放不干净电，万次读写<br>FTL：如何克服Wear out？又一个虚拟内存系统，VR眼jing</p>
<ul>
<li>security issue:<br>整个是一个copy-on-write系统，修改就复制，尽量不做抹除操作<br>这样并不能抹除</li>
<li>越加密，越复杂，越安全，可靠性就会越低（无法恢复）</li>
</ul>
<p>SSD可靠性由软件决定，但是软件是一些公司写的，竞争的环境 -&gt; 必然会存在偷工减料（狗头）</p>
</li>
</ul>
<h2 id="Lecture-26-P-I-x2F-O"><a href="#Lecture-26-P-I-x2F-O" class="headerlink" title="Lecture 26(P) I/O"></a>Lecture 26(P) I/O</h2><p>计算机系统对外部世界的边缘：I/O<br>Mem-mapped I/O: CPU并不关心自己接的是什么，它只能看到一个地址空间<br>把一部分地址空间分给“外面”就可以了<br>I/O就是“线”<br>把寄存器赋予一个地址<br>通过控制寄存器，状态寄存器，数据寄存器，来和外设交互</p>
<ul>
<li>串口(UART)🔌</li>
<li>键盘控制器接口(IBM PC/AT 8042 PS/2)⌨</li>
<li>磁盘控制器💽<ul>
<li>ATA 40pin</li>
<li>IDE,SATA…</li>
</ul>
</li>
<li>打印机🖨<ul>
<li>早期的画的是“矢量图”，“移动的画笔”<br>画面就是绘制指令序列<br>PostScript 是描述页面的DSL (Page DL),类似于一种汇编<br>PDF 就是 PostScript Ultra<br>打印机的CPU就是一个Page DL的解释器，<br>打印机是将汇编指令翻译成机械运动的机器</li>
</ul>
</li>
<li>Something not exist yet: 💫<br>获取良好的可拓展性：为未来的外设留下接口<br>需要一个特殊的接口，把I/O虚拟化👇</li>
<li>PCI总线：<br>总线有自己的虚拟的地址空间，CPU通过总线和外设交互<br>总线会识别I/O设备，给他们分配总线地址，并负责把数据分发到各个I/O设备上<br>CPU只能看到一个I/O也就是总线。<ul>
<li>总线还会桥接到其他总线上，比如USB总线</li>
<li>即插即用不是一个Easy story</li>
</ul>
</li>
</ul>
<p>这么多的外设都是中断来源，但CPU只有一个可屏蔽中断引脚<br>所以需要一个中断控制器,管理（排序）来自不同外设的中断<br>查看 <code>lspci -tv</code><br>Intel 8259 PIC, APIC…</p>
<ul>
<li>IPI: CPU 也可以给 CPU 发中断<br>总是先Reset一个CPU，执行启动程序，然后再给其他CPU发IPI，启动他们<br>CPU 也是 CPU 的外设！</li>
</ul>
<p>释放CPU的算力：如何处理非常慢的外设交互（eg.大数据存盘）<br>CPU是General Purpose的，当它长期做某“一件事”的时候，就是一种浪费。<br>交给其他的CPU去做，不过这个CPU不需要很强：只会memcpy就可以了！</p>
<ul>
<li>DMA 协处理器：只会load/store的协处理器，在memory和register(device的)之间的搬运工（甚至可以memory-memory）</li>
</ul>
<p>计算机系统里充满了CPU<br>CPU的核心，DMA，打印机，网卡…<br>以及…<strong>GPU</strong>！</p>
<ul>
<li>GPU <ul>
<li>马里奥的奇迹🪐<br>在性能很低的处理器上实现60fps<br>GPU的祖宗NES PPU</li>
<li>走向3D<br>虚假的真实感：Screen Space Ambient Occlusion<br>从伪-3D到空间多面体建模</li>
<li>真实的真实感：Ray Tracing<br>从眼睛射出光线，由于光路的可逆性，追溯到光源/非光源，从而获得真实的光照效果</li>
</ul>
</li>
</ul>
<p>走向异构计算：有限的、固定的、重复的指令，把这个功能分离出来，就可以做得时钟周期更快，<strong>并行度更高</strong></p>
<p><strong>TLB Flash摸鱼了🐟</strong> (没找到这里，，，)</p>
<h2 id="L2-kmt"><a href="#L2-kmt" class="headerlink" title="L2-kmt"></a>L2-kmt</h2><p>这个实验其实反而没有特别的多的设计层面</p>
<p>对于单核状态下，就朴实无华的创建和销毁，采用了自旋锁+睡眠信号量，调度采用轮询+引入一定的随机性(50% 跳过一个)。<br>对于多核的共享栈问题和V操作插入问题<br>共享栈利用额外的<code>schedulability</code>标记，在陷入之处标记为不可调度，记录上一个线程，在新线程再次陷入内核时释放上一个线程。(是不是也可以用锁锁栈来解决？)<br>对于V操作插入问题，设置完状态释放锁之前标记<code>wait_but_not_yield</code>标记，在yield时候归零即可，填补上这个gap。（这其实是一个L1提及的“多描述一致性”类的问题）</p>
<h3 id="印象深刻的BUG！！！！！！非常印象深刻！！！！！！"><a href="#印象深刻的BUG！！！！！！非常印象深刻！！！！！！" class="headerlink" title="印象深刻的BUG！！！！！！非常印象深刻！！！！！！"></a>印象深刻的BUG！！！！！！非常印象深刻！！！！！！</h3><p>可以说是终生难忘的25天。</p>
<h4 id="前面调的BUG是“上游投毒”-doge"><a href="#前面调的BUG是“上游投毒”-doge" class="headerlink" title="前面调的BUG是“上游投毒”(doge)"></a>前面调的BUG是“上游投毒”(doge)</h4><p>过于信任绿导师的代码了（狗头），应该先关中断，再取cpu信息。<br>不过在调试这个的过程中，逐渐把qemu连接 + gdb script + python的调试方法熟练了起来，也算是很有收获。</p>
<h4 id="最大的一个BUG"><a href="#最大的一个BUG" class="headerlink" title="最大的一个BUG"></a>最大的一个BUG</h4><p><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2024/08/13/PMHFc1LnTqiy9WB.png" alt=".png"></p>
<p>应该是有史以来给我印象最深的bug，可以和千年虫并列(bushi<br>当时已经有些破防了，还多次骚扰助教学长和绿导师求助。<br>主要就是本地测试没问题，主要测试了这几个</p>
<ol>
<li>Producer-Consumer4线程</li>
<li>打印ABC</li>
<li>在中断处理程序中V，用户程序中P</li>
<li>混合corner case在用户程序中P之后创建新线程</li>
</ol>
<p>正确同步且负载比较均衡，但OJ永远都是Rej</p>
<ul>
<li>改变多个调度策略的实现 依然不可以</li>
<li>改变信号量实现（自旋/睡眠） 依然不可以</li>
<li>测试队列 压力测试正确</li>
<li>多创建大量线程 没问题</li>
<li>瞪眼瞅检查（假设1不用信号量 </li>
<li>语义一致性检查</li>
<li>清栈问题（当时没解决这个，因为单核不存在该问题）</li>
<li>百万打印量级别的压力测试 也没问题</li>
<li>去掉assert 报错原因还是不变</li>
<li>……</li>
</ul>
<p>最后另一位群里同学发现了（震惊于这位哥们的想象力），是因为在pmm-&gt;init阶段打印log导致的，改了之后就通过了。。。（嘿啊喂手册上明明说可以的，建议改一下捏（半恼））<br>还遇到了不常见的Heisenbug，打印log就消失，不打印就出现</p>
<h3 id="想记录一下关于清栈问题的理解（想到的一个便于理解的视角）"><a href="#想记录一下关于清栈问题的理解（想到的一个便于理解的视角）" class="headerlink" title="想记录一下关于清栈问题的理解（想到的一个便于理解的视角）"></a>想记录一下关于清栈问题的理解（想到的一个便于理解的视角）</h3><p>可以不考虑是CPU拿来状态机跑。<br>而是认为CPU是固定地址空间上“跳动的指针”。<br><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2024/08/13/elvCH8E2h9jxANW.png" alt="1.png"></p>
<h3 id="记录一个室友提供的逆向思维"><a href="#记录一个室友提供的逆向思维" class="headerlink" title="记录一个室友提供的逆向思维"></a>记录一个室友提供的逆向思维</h3><p>在负载均衡时，不要想着测试的视角让线程找不同的CPU，而是反过来避免CPU”占一个”</p>
<h3 id="一些感想"><a href="#一些感想" class="headerlink" title="一些感想"></a>一些感想</h3><p>感觉这个实验做到后面，整个人都有一点被异化了，耽误了同时进行的许多事情（其实也没有占用很多时间，因为多数时候都觉得没什么课修改和测试的了，主要是心态炸了有点开摆）。觉得以后无论做什么还是要<del>心如死灰</del> <strong>心平气和</strong>（和水群以及做好错误信息反馈(逃），这样能最大程度“负载均衡”和发挥生产力。</p>
<h2 id="Lecture-27-P-vfs-Driver"><a href="#Lecture-27-P-vfs-Driver" class="headerlink" title="Lecture 27(P) vfs, Driver"></a>Lecture 27(P) vfs, Driver</h2><p><strong>文件描述符是一个指向操作系统对象的指针！</strong><br>文件是“虚拟磁盘”（把磁盘的一部分映射到地址龙剑）<br>Syscalls: mmap,lseek,ftruncate</p>
<blockquote>
<p>GPT的一个趋势：self-validation</p>
</blockquote>
<p>还是那个方法论：用AI来写一个小的验证代码</p>
<p>无尽的细节：偏移量管理<br>父子进程共用一个offset，文件描述符是浅拷贝。（存在大量的并发追加操作，如写入终端、写入日志）<br>open:获得一个独立的offset<br>dup: 两个共享offset<br>execve: 文件描述符不变<br>O_APPEND: 保证写入的时候是追加，打开时永远指向文件末尾</p>
<blockquote>
<p>有大量的细节都是与fork交叉带来的，因为进程的状态机并不只是内存和寄存器，还有操作系统内核中维护的文件描述符表、页表、信号处理表等等。<br>操作系统：<strong>平方级别</strong>（<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.576ex;" xmlns="http://www.w3.org/2000/svg" width="2.825ex" height="2.463ex" role="img" focusable="false" viewBox="0 -833.9 1248.8 1088.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msubsup"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mn" transform="translate(845.3,363) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mi" transform="translate(748,-247) scale(0.707)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g></g></g></g></svg></mjx-container>）的复杂度膨胀</p>
</blockquote>
<p>如何实现Everything is a file？<br>真实的文件好说，虚拟的文件呢？<br>在每一个文件相关的系统调用中，都会有一个switch case，根据文件的类型，调用不同的处理程序。<br>如果这个文件是设备的话，那么就会调用设备驱动程序。<br>如果这个文件是虚拟文件的话，那么就会调用虚拟文件(e.g. /proc/{pid}/maps)的处理程序。<br>这些东西假装自己是文件，如何假装👇<br>文件 = （部分）实现了文件操作的 “Anything”（能“像文件一样”被操作的东西都是文件）<br>设备驱动: 把系统调用 “翻译” 成与设备能听懂的数据的内核代码<br>vfs的虚拟文件们：</p>
<ul>
<li>devfs</li>
<li>procfs</li>
</ul>
<p>都是有一个驱动程序，在file syscall，往用户传进来的buf里写，假装自己是个文件。</p>
<p>.ko文件是一个内核模块，可以被动态加载到内核中？🛐</p>
<p>对于设备来说，以上是和设备的数据交互（核弹），还有和设备的配置交互<br>控制可以是数据的一部分 ANSI ESCAPE CODE<br>提供新的接口（也是寄存器）：<br>ioctl 函数原型参数后面是…👉完全由设备决定<br>是操作系统最大的💩🏔️来源（User-define是原罪啊！）<br>复杂性：不计其数的hidden speciefication<br>procfs巨大的负担（procfs的秘密）<br>同时也非常脆弱（无数的应用程序parse procfs的内容，一旦损坏会导致系统的完全崩溃）</p>
<p>KVM设备：硬件虚拟化，一个完整的可以加载到物理机上的虚拟机🛐</p>
<h2 id="Lecture-28-P-fs"><a href="#Lecture-28-P-fs" class="headerlink" title="Lecture 28(P) fs"></a>Lecture 28(P) fs</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect28.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<p>回顾:文件是虚拟的磁盘镜像<br>信息的局部性：树状层次结构。<br>数据/非数据的文件管理：</p>
<ul>
<li>Unix-like: 都在/中</li>
<li>数据Windows: C: D: E:…（A. B.是软盘）每个驱动器一个根<br>非数据Windows特有的机制：注册表（一个巨大的配置文件）<br>但注册表不在文件系统里<br>Win里面有一类为设备的对象，但也有类似Everything is a file的机制</li>
</ul>
<p>mount 🐟<br>mount就是目录树的嫁接。（改掉了原来的目录，但是文件还在）<br>mount就可以把某一个<strong>设备</strong>(其实就是一个支持某些操作的字节序列)挂载到某一个目录上<br>procfs是一个不需要设备的文件系统，只需要一个驱动程序<br>/proc 其实只是一个普通的目录，只是procfs被mount挂载在了上面（甚至可以被挂载在不同地方很多份）<br>提供了<strong>灵活性</strong>，不同的目录可以分配给不同的设备</p>
<p>把磁盘挂载到目录上,不会形成一个自指么???</p>
<p>文件可以是是虚拟的设备<br>那么把某个虚拟磁盘(比如某个.img文件系统镜像)挂载到某个目录上呢？<br>loopback device（不能被写在？🐟）<br>制造一个虚拟的设备loop，把文件关联到这个虚假的存储设备上，然后把这个设备挂载到某个目录上</p>
<p>FHS 有一套文件系统的标准 🛐</p>
<p>目录管理 mkdir,rmdir,getdents<br>User-friendly: globbing</p>
<p>文件系统允许一个文件被多次引用</p>
<ul>
<li>硬链接,一个指针,指向相同的东西,只有名字可能是不同的<br>可以想一下,实际上你看到的是若干个文件名和一个实际的文件的对应关系<br>所以删文件的系统调用是unlink,意思就是把这个实际文件的引用计数减少一个<br>(是文件系统实现的一部分?所以不能链接不存在东西)</li>
<li>符号链接/软链接(Symbolic Link)<br>更加宽松,可以指向任何地方,甚至可以指向不存在的东西<br>jyy’s Galgame<br>每个目录都是一个状态机,软链接可以作为状态机的迁移</li>
</ul>
<p>文件系统实现:<br>现实我们面对的是块设备而不是随机存储设备：小的读写都会被严重放大<br>目录如何实现? 也是一个虚拟的文件</p>
<ul>
<li><p>古早现实：单目录文件非常少不超过几十个，单文件比较小，文件系统要尽可能小<br>纯真的链表最为合适<br>目录：就是一个文件<br>两种设计🐟<br>File Allocation Table (FAT)<br>解决可靠性问题：存很多份</p>
<p>FAT32.读代码🐟</p>
</li>
</ul>
<p>fat32.h实验可以使用</p>
<p>UNIX文件系统:<br>不同于FAT,引入inode的概念,可以是文件或者是目录,包括元数据甚至是文件头,具有一定的局部性(比如同一目录文件的inode会被放在一个块里)<br>常用的部分会直接索引,不常用的部分会多级索引</p>
<h2 id="Lecture-29-P-Reliablity"><a href="#Lecture-29-P-Reliablity" class="headerlink" title="Lecture 29(P) Reliablity"></a>Lecture 29(P) Reliablity</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect29.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<p>没有任何可靠的存储设备：哪怕由于三体人进攻地球！<br>临时失效、部分失效、永久失效。</p>
<p>RAID 存储设备虚拟化 D.Patterson的杰作！<br>既要可靠性，也要性能！<br>另一种虚拟化：之前的虚拟化是将但设备虚拟化成多设备，而RAID是将多设备虚拟化成一个设备。（这种虚拟化在计算中心里面也是常见的）</p>
<ul>
<li>RAID-0:<br>无备份，<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="9.015ex" height="1.731ex" role="img" focusable="false" viewBox="0 -683 3984.6 765"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path></g><g data-mml-node="mo" transform="translate(1328.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mi" transform="translate(2384.6,0)"><path data-c="3A3" d="M666 247Q664 244 652 126T638 4V0H351Q131 0 95 0T57 5V6Q54 12 57 17L73 36Q89 54 121 90T182 159L305 299L56 644L55 658Q55 677 60 681Q63 683 351 683H638V679Q640 674 652 564T666 447V443H626V447Q618 505 604 543T559 605Q529 626 478 631T333 637H294H189L293 494Q314 465 345 422Q400 346 400 340Q400 338 399 337L154 57Q407 57 428 58Q476 60 508 68T551 83T575 103Q595 125 608 162T624 225L626 251H666V247Z"></path></g><g data-mml-node="mi" transform="translate(3106.6,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g></g></g></svg></mjx-container><br>交错排列可以获得读写并行，无法容错，尤其交错时</li>
<li>RAID-1：<br>保持<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="5.254ex" height="1.692ex" role="img" focusable="false" viewBox="0 -666 2322.4 748"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(822.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(1822.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></svg></mjx-container>份镜像，<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="7.381ex" height="1.731ex" role="img" focusable="false" viewBox="0 -683 3262.6 765"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path></g><g data-mml-node="mo" transform="translate(1328.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mi" transform="translate(2384.6,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g></g></g></svg></mjx-container>，只能读并行，容错率高</li>
</ul>
<p>如果假设不会有两块盘同时失效（Fail stop）？<br>求和检查：环和（或者叫异或、奇偶…）<br>但是每次修改校验和都会修改<br>把校验分散在多个盘上，可以提高性能</p>
<ul>
<li>RAID-5<br>…🐟</li>
</ul>
<p>发现Fail-stop：RAID板卡上的软件会检测🐟</p>
<div class="note-large notel-red"><div class="notel-title"><p>🌶️Spicy:</p>
</div><div class="notel-content"><p>如果硬盘不连接到一块板卡上呢？构造一个巨大的分布式RAID，可以容纳整个互联网世界：Google File System<br>map reduce🐟<br>数据中心存储：EBS：Elastic Block Storage<br>🐟</p>
<p>发现问题非常困难：Fail Slow 或者 一部分数据损坏，同时多层虚拟化增加了系统复杂度</p>
 </div></div>

<p>崩溃一致性：Crash Consistency<br>需求：无论何时Crash(Kernel panic, 断电)，不能修改一半！<br>这其实是<strong>某种意义上的并发</strong>问题，Crash<strong>类似于一种中断</strong><br>磁盘的按块写接口，是无法实现原子性的（甚至都不能保证顺序）<br>bread,bwrite<br>最基础的磁盘提供了:bflush等待所有缓冲的写操作落盘<br>且磁盘的校验机制保证了单次bwrite的原子性<br>但还是不行,因为写入一个文件是很多个bwrite的集合<br><del>糟了，那个L1可能也会有类似的问题</del><br>需要写 inode(文件的元数据和块索引),bitmap(标记空闲块),文件数据(可能还有多次bwrite),三部分<br>(inode和bitmap是集中存储的)<br>崩溃可能会导致</p>
<ul>
<li>资源泄漏：目录系统是没更新，bitmap更新了</li>
<li>文件不一致：文件的前后部分版本不一致</li>
<li>最严重的问题：bitmap没更新，目录系统更新了，这一块可能会泄露，同时还可能会被别人修改</li>
</ul>
<p>(部分)解决上面的不一致:FSCK：一个困难的问题<br>由于Crash的时候你不能确定之前进行了哪些操作进行了一半，所以只能修正成一个最可能的。<br>比如当你移动一个目录时，需要修改大量的指针.<br>但是FSCK的过程也可能Crash，就更chaos了</p>
<p>FSCK只是一个兜底的办法,我们希望有更好的处理:<br>在非原子的设备中实现原子性的”All or Nothing”操作<br>重新理解数据结构：</p>
<ul>
<li>数据结构，既是有组织的数据（结果视角）。</li>
<li>也是<strong>一串有组织的操作的结果</strong>（过程视角）。</li>
</ul>
<ol>
<li>我们想要修改数据结构</li>
<li>将一个TXbegin+需要修改所需的所有操作全部写入到一个Append-only的日志中</li>
<li>日志完整写入磁盘,flush,写一个TXend标记</li>
<li>开始修改数据结构</li>
<li>数据结构落盘了,就可以把日志删除了</li>
</ol>
<p>如果发现了Crash，如果有配对的TXbegin和TXend，那么就可以Replay日志，如果没有，那么就可以把日志删除</p>
<p>考一考<br>如果获取锁的时候crash了呢</p>
<h2 id="Lecture-30-Summary"><a href="#Lecture-30-Summary" class="headerlink" title="Lecture 30 Summary"></a>Lecture 30 Summary</h2><ul>
<li>Everything is a state machine</li>
<li>Emulate state machines with executable models</li>
<li>Enumeration demystifies operating systems</li>
</ul>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>《 Email to Green Advisor 》<br>这篇其实从学期一初就开始写了，希望的是等到OS这门课出分之后发给绿导师，希望当时我是以一个幸存者的心态，完成了这门课全部的任务，取得了一个不错的分数（不得不这样）比较轻松的发送这篇邮件。</p>
<p>这门课给我的体验的是很好的，我想对比的是同是这学期的算法设计与分析课。黄宇老师的算法课有着非常的清晰的讲解，我也不得不承认确实是一门好课，我用了一个月左右才想清楚了为什么这门课会让我感到痛苦。就是：对于对OI有一定接触的我来说，这些经典“算法”早已没有了初见的新鲜感，更重要的是每节课都在向我传达一个概念“你又不能做什么，你又没法会什么”，因为这些都需要“灵感”，（课上的方法论甚至都不足以解决那占比80%的考试题😭（当然任何形式的考试都承担着检验以外的筛选作用））。相比之下我觉得OS给我的感觉是每一节课后，“我又能做成什么，我又能解决更多问题（乃至所有问题）”。不同于上算法课之前上刑场一般的心理负担，每节操作系统课虽然带着成吨的没读完的OSTEP，没理解完的讲义，没整理完的笔记，没学完的工具，没写完的实验，但都是无比期待的。我觉得这可能是一种“极客主义”。</p>
<p>我想提出一点异见的就是您说只发表“not trivial”的工作。我接触到了一个概念就是do not judge novelty，我觉得，对于一般的研究者而言，他们可能终其一生都无法做出creative的工作，但他们的工作也是有价值的，也需要一个获得认同的平台。（在知乎看到过一个人说一个化学教授说，我们做实验，失败了，也是有价值的，至少别人看到了，知道这样做不行，不用再好费时间了。类似地，CS里面有一些仅仅是方法的融合怪，至少也可以证明这些方法的交叉不会产生奇妙的“化学反应”。）可能只有聪明人做科研才是有价值的，但是在大量聪明人去经商/捞钱的今天，让一些不聪明的人去回收一些low fruit也是应该的。（虽然说 do not judge novelty今天已经变味，更多成为了一种灌水的辩护，这个界限也很难分辨…）</p>
<p>还有就是对这门课程的建议，我觉得这门课的地位已经不言而喻，作为第一个入选CSDIY的国内课程，我觉得这是无上的光荣（比什么CCF发的什么奖项含金量高太多，毕竟这是华语区<strong>热爱CS</strong>的人投出来的票，好过某随意增减名额把OIer的未来当儿戏的组织太多）。相比于上海交大的一些透露着买办阶级的所谓的好课（质量固然是有的，毕竟是从海外ctrl+C/V来的），这门课更像是一座灯塔。但我发现了一个问题就是，由于您各种意义上一个“聪明人”，所以您上课的节奏虽然适中，但有一些结构上的问题加以忽略。对于拔尖班之类的大佬，他们的可以很快地处理和解决问题点，并且在节奏稍缓的时候迅速的将结构组织起来。但对于我这样反应比较慢的人来说，我全程都在高强度的处理一些思考点（有些甚至还当堂处理不完）最后的感受就是只体会到了一些零散的点。之后虽然有回放可以反复观看，但是由于短时记忆遗忘的问题，就会有一种夹生感，最后需要数倍的时间去组织起来。因此我觉得如果在讲义和授课中更加强调一点结构，这门课就会向普通的同学，乃至开源之后的更广泛的受众群体更加友好。</p>
<p>系统知识，明白自己干什么，提高理想注意，水完这个<br>建议增加分级制度和每年新内容的Update Log</p>
<p>课程主页爬到了第三,第二是AI，第一是默认页</p>
<p>不要做减法，做加法，大家确实要hard以下<br>把状态机的视角灌输到下一届一个班的同学了</p>
<p>最后一节课显著增加</p>
<p>评价体系不变，课程改革根本无法实现</p>
<p>环境虽然差，但目前很优越，不够内卷有空间了</p>
<p>之前说的西工大不是大学<br>残酷并不意味着残酷</p>
<p>人类的本质preaching machine</p>
<p>如何发现问题<br>回答应不应该</p>
<p>杜绝沙文主义</p>
<p>不要再没有意义上的事情上沾沾自喜<br>做一些只有你自己相信的事情</p>
<p>回归了humble</p>

            </div>

            
                <div class="post-copyright-info">
                    <div class="article-copyright-info-container">
    <ul>
        <li>Post title：Talk to the God——Notes for jyy OS</li>
        <li>Post author：Jackcui</li>
        <li>Create time：2024-02-28 09:02:59</li>
        <li>
            Post link：https://jackcuii.github.io/2024/02/28/OS/
        </li>
        <li>
            Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

                </div>
            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/CS/">#CS</a>&nbsp;
                        </li>
                    
                        <li class="tag-item">
                            <a href="/tags/Notes/">#Notes</a>&nbsp;
                        </li>
                    
                </ul>
            

            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                            rel="prev"
                            href="/2024/03/01/HPP/"
                            >
                                <span class="left arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </span>
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">Notes for Heterogeneous Parallel Programming By W. Hwu</span>
                                    <span class="post-nav-item">Prev posts</span>
                                </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                            rel="next"
                            href="/2024/02/26/ComputerNetwork/"
                            >
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">Notes for Computer Network</span>
                                    <span class="post-nav-item">Next posts</span>
                                </span>
                                <span class="right arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </span>
                            </a>
                        </div>
                    
                </div>
            


            
                <div class="comment-container">
                    <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fa-solid fa-comments"></i>&nbsp;Comments
    </div>
    

        
            
 
    <div id="waline"></div>
    <script type="module"  data-pjax>
        import { init } from 'https://evan.beee.top/js/waline.mjs';

        function loadWaline() {
            init({
                el: '#waline',
                serverURL: 'https://comment.jackcuii.cn/',
                lang: 'zh-CN',
                dark: 'body[class~="dark-mode"]',
                requiredMeta: ['nick','mail'], // cannot customize by theme config, change it yourself
            });
        }

        if ('true') {
            const loadWalineTimeout = setTimeout(() => {
                loadWaline();
                clearTimeout(loadWalineTimeout);
            }, 1000);
        } else {
            window.addEventListener('DOMContentLoaded', loadWaline);
        }
        
    </script>



        
    
</div>

                </div>
            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">Talk to the God——Notes for jyy OS</div>
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-text">References</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Waiting-List"><span class="nav-text">Waiting List</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%AA%E8%AE%BA"><span class="nav-text">绪论</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E5%88%AB%E8%AF%B4%E6%98%8E"><span class="nav-text">特别说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-1"><span class="nav-text">Lecture 1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-2"><span class="nav-text">Lecture 2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#M1-pstree"><span class="nav-text">M1:pstree</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#L0-Pic-Display"><span class="nav-text">L0-Pic Display</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-3"><span class="nav-text">Lecture 3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-4"><span class="nav-text">Lecture 4</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-5-C-Intro-of-Multiprocessor"><span class="nav-text">Lecture 5 (C) Intro of Multiprocessor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-6-C-Mutex-amp-lock"><span class="nav-text">Lecture 6 (C) Mutex &amp; lock</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#M2-libco"><span class="nav-text">M2:libco</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-7-C-Mutex-amp-lock"><span class="nav-text">Lecture 7 (C) Mutex &amp; lock</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-8-Snack"><span class="nav-text">Lecture 8 (Snack)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-9-C-Sync-Producer-Consumer"><span class="nav-text">Lecture 9 (C) Sync: Producer-Consumer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-10-C"><span class="nav-text">Lecture 10 (C)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NotLect-10-5"><span class="nav-text">NotLect 10.5</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-11-Snack"><span class="nav-text">Lecture 11 (Snack)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-12-C"><span class="nav-text">Lecture 12 (C)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-13-C"><span class="nav-text">Lecture 13 (C)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-14-V"><span class="nav-text">Lecture 14 (V)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-15-V"><span class="nav-text">Lecture 15 (V)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-16-V"><span class="nav-text">Lecture 16 (V)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-17-V"><span class="nav-text">Lecture 17 (V)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#L1-pmm"><span class="nav-text">L1-pmm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0"><span class="nav-text">一些相关笔记</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2024-Lect17"><span class="nav-text">2024 Lect17</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2022-Lect14"><span class="nav-text">2022 Lect14</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BF%83%E8%B7%AF%E5%8E%86%E7%A8%8B"><span class="nav-text">心路历程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E7%89%88%EF%BC%9A%E5%BC%82%E6%83%B3%E5%A4%A9%E5%BC%80%E7%9A%84%E5%BC%80%E7%AB%AF"><span class="nav-text">第一版：异想天开的开端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E7%89%88%EF%BC%9A%E5%89%8D%E8%BE%88%E7%BB%8F%E9%AA%8C%E7%9A%84%E5%90%AF%E7%A4%BA"><span class="nav-text">第二版：前辈经验的启示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E7%89%88%EF%BC%9A%E5%B4%A9%E5%9D%8F%E7%9A%84%E5%A4%8D%E6%9D%82"><span class="nav-text">第三版：崩坏的复杂</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E7%89%88%EF%BC%9A%E5%90%91%E5%91%BD%E8%BF%90%E4%BD%8E%E5%A4%B4"><span class="nav-text">第四版：向命运低头</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%B0%E8%B1%A1%E6%B7%B1%E5%88%BB%E7%9A%84BUG"><span class="nav-text">印象深刻的BUG</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E9%BD%90%E9%97%AE%E9%A2%98"><span class="nav-text">对齐问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E6%8F%8F%E8%BF%B0%E4%B8%8D%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98"><span class="nav-text">多描述不一致问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E7%9A%84%E6%BC%8F%E6%B4%9E%E8%80%8C%E9%9A%90%E8%97%8F%E7%9A%84bug"><span class="nav-text">一个压力测试的漏洞而隐藏的bug</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%84%9F%E6%83%B3"><span class="nav-text">感想</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#M3-GPT2-%E5%B9%B6%E8%A1%8C%E5%8C%96"><span class="nav-text">M3:GPT2 并行化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-18-V-Genesis-of-OS-and-Geniuses"><span class="nav-text">Lecture 18 (V) Genesis of OS (and Geniuses)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-19-V-Executable-Static-Link"><span class="nav-text">Lecture 19 (V) Executable, Static Link</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-20-V-Dynamic-Link"><span class="nav-text">Lecture 20 (V) Dynamic Link</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#M4-amp-5"><span class="nav-text">M4(&amp;5?)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#M6"><span class="nav-text">M6</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-21-K-Syscall-intr"><span class="nav-text">Lecture 21 (K) Syscall, intr</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-22-K-from-Thread-to-Process"><span class="nav-text">Lecture 22 (K) from Thread to Process</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-23-K-Schedule"><span class="nav-text">Lecture 23 (K) Schedule</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-24-K-K-of-what%E2%80%A6-the-world-from-OS-to-MetaPhysics"><span class="nav-text">Lecture 24 (K? K of what…(the world)) from OS to MetaPhysics</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-25-P-1-Bit-Storage"><span class="nav-text">Lecture 25 (P) 1-Bit Storage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-26-P-I-x2F-O"><span class="nav-text">Lecture 26(P) I&#x2F;O</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#L2-kmt"><span class="nav-text">L2-kmt</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%B0%E8%B1%A1%E6%B7%B1%E5%88%BB%E7%9A%84BUG%EF%BC%81%EF%BC%81%EF%BC%81%EF%BC%81%EF%BC%81%EF%BC%81%E9%9D%9E%E5%B8%B8%E5%8D%B0%E8%B1%A1%E6%B7%B1%E5%88%BB%EF%BC%81%EF%BC%81%EF%BC%81%EF%BC%81%EF%BC%81%EF%BC%81"><span class="nav-text">印象深刻的BUG！！！！！！非常印象深刻！！！！！！</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%8D%E9%9D%A2%E8%B0%83%E7%9A%84BUG%E6%98%AF%E2%80%9C%E4%B8%8A%E6%B8%B8%E6%8A%95%E6%AF%92%E2%80%9D-doge"><span class="nav-text">前面调的BUG是“上游投毒”(doge)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%80%E5%A4%A7%E7%9A%84%E4%B8%80%E4%B8%AABUG"><span class="nav-text">最大的一个BUG</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%83%B3%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8B%E5%85%B3%E4%BA%8E%E6%B8%85%E6%A0%88%E9%97%AE%E9%A2%98%E7%9A%84%E7%90%86%E8%A7%A3%EF%BC%88%E6%83%B3%E5%88%B0%E7%9A%84%E4%B8%80%E4%B8%AA%E4%BE%BF%E4%BA%8E%E7%90%86%E8%A7%A3%E7%9A%84%E8%A7%86%E8%A7%92%EF%BC%89"><span class="nav-text">想记录一下关于清栈问题的理解（想到的一个便于理解的视角）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%AA%E5%AE%A4%E5%8F%8B%E6%8F%90%E4%BE%9B%E7%9A%84%E9%80%86%E5%90%91%E6%80%9D%E7%BB%B4"><span class="nav-text">记录一个室友提供的逆向思维</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E6%84%9F%E6%83%B3"><span class="nav-text">一些感想</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-27-P-vfs-Driver"><span class="nav-text">Lecture 27(P) vfs, Driver</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-28-P-fs"><span class="nav-text">Lecture 28(P) fs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-29-P-Reliablity"><span class="nav-text">Lecture 29(P) Reliablity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-30-Summary"><span class="nav-text">Lecture 30 Summary</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8E%E8%AE%B0"><span class="nav-text">后记</span></a></li></ol>

    </div>
</div>
            </div>
        
    </div>
</div>


                

            </div>



        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info">
            &copy;
            
              <span>2022</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Jackcui</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv" class="busuanzi_container_site_uv">
                        VISITOR COUNT&nbsp;<span id="busuanzi_value_site_uv" class="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="busuanzi_container_site_pv">
                        TOTAL PAGE VIEWS&nbsp;<span id="busuanzi_value_site_pv" class="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            <span class="powered-by-container">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" href="https://hexo.io">Hexo</a></span>
                <br> 
            <span class="theme-version-container">THEME&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v1.2.3</a>
        </div>
        
        
        
            <div id="start_time_div" style="display:none">
                2022/8/17 11:45:14
            </div>
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
        
            <script async data-pjax>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="unfolded-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="right-bottom-tools tool-scroll-to-top flex-center">
                <i class="fa-regular fa-arrow-up"></i>
            </li>
        

        <li class="right-bottom-tools tool-scroll-to-bottom flex-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="folded-tools-list">
        <li class="right-bottom-tools tool-toggle-show flex-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    


</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/layouts/menu-shrink.js"></script>

<script src="/js/tools/go-top-bottom.js"></script>

<script src="/js/tools/dark-light-toggle.js"></script>



    
<script src="/js/tools/local-search.js"></script>




    
<script src="/js/tools/code-block.js"></script>




    
<script src="/js/layouts/lazyload.js"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/layouts/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js"></script>







<div class="post-scripts pjax">
    
        
<script src="/js/tools/toc-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/layouts/toc.js"></script>

<script src="/js/plugins/tabs.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            REDEFINE.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            REDEFINE.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            REDEFINE.refresh();
        });
    });
</script>




    <div id="aplayer"></div>

<script src="/js/libs/APlayer.min.js"></script>


<script src="/js/plugins/aplayer.js"></script>


</body>
</html>
