<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    <meta name="description" content="Jackcui personal homepage.">
    <meta name="author" content="Jackcui">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-redefine.png">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://evan.beee.top" crossorigin>
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2024/02/28/os/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Talk to the God——Notes for jyy OS">
    <meta property="og:description" content="Jackcui personal homepage.">
    <meta property="og:url" content="http://example.com2024/02/28/OS/">
    
    <meta property="og:site_name" content="Jackcui&#39;s Chatter">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Talk to the God——Notes for jyy OS">
    <meta name="twitter:description" content="Jackcui personal homepage.">
    <meta name="twitter:image" content="/images/redefine-logo.svg">
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/redefine-logo.svg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/redefine-logo.svg">
    <meta name="theme-color" content="#005080">
    <link rel="shortcut icon" href="/images/redefine-logo.svg">
    <!--- Page Info-->
    
    <title>
        
            Talk to the God——Notes for jyy OS -
        
        Jackcui&#39;s Chatter
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/assets/fonts.css">

    <!--- Font Part-->
    
    
    
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    let REDEFINE = window.REDEFINE || {};
    REDEFINE.hexo_config = {"hostname":"example.com","root":"/","language":"en","path":"search.xml"};
    REDEFINE.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#005080","avatar":"https://s2.loli.net/2023/03/24/nBqwGYDJx6CdZr7.png","favicon":"/images/redefine-logo.svg","og_image":{"enable":false,"image_url":null},"article_img_align":"center","right_side_width":"210px","content_max_width":"1000px","nav_color":{"left":"#f78736","right":"#367df7","transparency":35},"hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"background_image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title_color":{"light":"#fff","dark":"#d1d1b6"},"font_sizes":{"title":"2.8rem","subtitle":"1.5rem"},"line_height":1.2,"title":"131a6ea Not Found","subtitle":{"enable":true,"list":["We go near, we go far.","We got found, we got lost"]},"custom_font":{"enable":false,"font_family":null,"font_url":null}},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_block":{"copy":true,"style":"mac","custom_font":{"enable":false,"font_family":null,"font_url":null}},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"1.2.3","friend_links":{"columns":2},"home_article":{"date_format":"auto","category":{"enable":true,"limit":3},"tag":{"enable":true,"limit":3}},"plugins":{"aplayer":{"enable":true,"audio":[{"name":"美好事物","artist":"房东的猫","url":"/mhsw.mp3","cover":"/mhsw.jpg"},{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":false,"version":"9.3.0"}}};
    REDEFINE.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 6.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="menu-wrapper">
    
    <div class="menu-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Jackcui&#39;s Chatter
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="pc">
                <ul class="menu-list">
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        HOME
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="has-dropdown" 
                                    href="#" onClick="return false;">
                                    
                                        
                                            <i class="fa-solid fa-dove"></i>
                                        
                                        LINKS&nbsp;<i class="fa-solid fa-chevron-down"></i>
                                    
                                </a>
                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                    
                                        <li>
                                        <a href="/links">FRIEND LINK
                                        </a>
                                        </li>
                                    
                                    </ul>
                                
                            </li>
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/UNacceptable"  >
                                    
                                        
                                            <i class="fa-solid fa-alien-8bit"></i>
                                        
                                        UNW
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/tags"  >
                                    
                                        
                                            <i class="fa-duotone fa-hashtag"></i>
                                        
                                        TAG
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="menu-drawer">
        <ul class="drawer-menu-list">
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                HOME
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="has-dropdown" 
                        href="#" onClick="return false;">
                            
                                
                                    <i class="fa-solid fa-dove"></i>
                                
                                LINKS&nbsp;<i class="fa-solid fa-chevron-down"></i>
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                              
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" href="/links">FRIEND LINK</a>
                            </li>
                        
                    
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="/UNacceptable"  >
                             
                                
                                    <i class="fa-solid fa-alien-8bit"></i>
                                
                                UNW
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="/tags"  >
                             
                                
                                    <i class="fa-duotone fa-hashtag"></i>
                                
                                TAG
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            
            
                <div class="article-title">
                    <h1 class="article-title-regular">Talk to the God——Notes for jyy OS</h1>
                </div>
            
                
            

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="https://s2.loli.net/2023/03/24/nBqwGYDJx6CdZr7.png">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">Jackcui</span>
                            
                                <span class="author-label">NJU Loser</span>
                            
                        </div>
                        <div class="meta-info">
                            <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="pc">2024-02-28 09:02:59</span>
        <span class="mobile">2024-02-28 09:02</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="pc">2024-06-06 11:01:15</span>
            <span class="mobile">2024-06-06 11:01</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/CS/">CS</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Notes/">Notes</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-file-word"></i>&nbsp;<span>9.4k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>34 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content markdown-body">
                <h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>jyy ‘The Green Advisor’ OS, NJU 2024 Spring<br>License same as the original course.</p>
<h2 id="Waiting-List"><a href="#Waiting-List" class="headerlink" title="Waiting List"></a>Waiting List</h2><ul>
<li>第一节 ⛔</li>
<li>第二节 ⛔</li>
<li>M1 ✅ 🛐🛐🛐</li>
<li>第三节 ⛔</li>
<li>第四节 ⛔</li>
<li>L0 ⛔</li>
<li>第五节 ⛔</li>
<li>第六节 ⛔</li>
<li>第七节 ✅<ul>
<li>阅读XV6源码</li>
<li>群除我佬的问题</li>
<li>*benchmark crimes的阅读</li>
<li>*RCU细节（缺少链接）</li>
</ul>
</li>
<li>第八节 ✅<ul>
<li>学习一下GDB in Python</li>
<li>阅读GDB文档，quick guide, cheat sheet</li>
</ul>
</li>
<li>第九节 ✅ 🛐</li>
<li>第十节 ⛔</li>
<li>第十一节 ✅</li>
<li>第十二节 ✅</li>
<li>第十三节 ⛔</li>
<li>第十四节 ✅ 🛐</li>
<li>第十五节 ⛔</li>
<li>第十六节 ⛔</li>
<li>第十七节 ✅ 🛐🛐🛐🛐🛐🛐🛐</li>
<li>第十八节 ⛔</li>
<li>第十九节 ⛔</li>
<li>第二十节 ⛔</li>
<li>第二十一节 ⛔</li>
<li>第二十二节 ✅ 🛐XV6重要！</li>
<li>第二十三节 ⛔</li>
<li>第二十四节 ⛔</li>
<li>第二十五节 ⛔</li>
</ul>
<h2 id="绪论"><a href="#绪论" class="headerlink" title="绪论"></a>绪论</h2><p>在做了充足的心理准备之后，终于决定报了jyy老师的OS。</p>
<blockquote>
<p>世界上有两种人：没见过<strong>神</strong>的人和见过jyy的人。</p>
</blockquote>
<p><strong>神</strong>自我革命，<strong>神</strong>制造困境，<strong>神</strong>传达启示，<strong>神</strong>引发灵感。<br>本篇作为与<strong>神</strong>的对话，忠实记录了 jyyOS 24Spring 的课程笔记，实验实录，教材读书笔记和心得感受。</p>
<h3 id="特别说明"><a href="#特别说明" class="headerlink" title="特别说明"></a>特别说明</h3><p>为了更适应英文环境，其实绝大多数的笔记都使用英语来记了，但由于绿导师的内容比较深，大面积的使用英语会使得“再提取”非常困难(鸡尾酒会效应)，而且个别思考内容我第一次用英语乱找一个说法写上，下次自己都看不懂什么意思，因此就用中文记了，我可am not那种Chinese英语mix着说的’fashion speaker’(doge)</p>
<h2 id="Lecture-1"><a href="#Lecture-1" class="headerlink" title="Lecture 1"></a>Lecture 1</h2><div class="note-large notel-blue"><div class="notel-title"><p>OSTEP Chapter 1,2</p>
</div><div class="notel-content"><p>3 Easy Pieces: virtualization, concurrency, persistence</p>
<ul>
<li><p>virtualization: physical—virtualization–&gt;virtual form<br><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="10.854ex" height="1.602ex" role="img" focusable="false" viewBox="0 -697 4797.6 708"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mtext"><path data-c="1D40E" d="M64 339Q64 431 96 502T182 614T295 675T420 696Q469 696 481 695Q620 680 709 589T798 339Q798 173 697 82T432 -10Q262 -10 163 85T64 339ZM625 454Q618 502 600 538T562 593T515 624T469 639T431 642Q331 642 276 563Q232 493 232 353Q232 315 234 285T244 216T267 148T308 94T372 56Q405 46 432 46Q517 46 567 106T627 267Q631 299 631 353Q631 418 625 454Z"></path><path data-c="1D412" d="M64 493Q64 582 120 636T264 696H272Q280 697 285 697Q380 697 454 645L480 669Q484 672 488 676T495 683T500 688T504 691T508 693T511 695T514 696T517 697T522 697Q536 697 539 691T542 652V577Q542 557 542 532T543 500Q543 472 540 465T524 458H511H505Q489 458 485 461T479 478Q472 529 449 564T393 614T336 634T287 639Q228 639 203 610T177 544Q177 517 195 493T247 457Q253 454 343 436T475 391Q574 326 574 207V200Q574 163 559 120Q517 12 389 -9Q380 -10 346 -10Q308 -10 275 -5T221 7T184 22T160 35T151 40L126 17Q122 14 118 10T111 3T106 -2T102 -5T98 -7T95 -9T92 -10T89 -11T84 -11Q70 -11 67 -4T64 35V108Q64 128 64 153T63 185Q63 203 63 211T69 223T77 227T94 228H100Q118 228 122 225T126 205Q130 125 193 88T345 51Q408 51 434 82T460 157Q460 196 439 221T388 257Q384 259 305 276T221 295Q155 313 110 366T64 493Z" transform="translate(864,0)"></path></g><g data-mml-node="mo" transform="translate(1780.8,0)"><path data-c="2248" d="M55 319Q55 360 72 393T114 444T163 472T205 482Q207 482 213 482T223 483Q262 483 296 468T393 413L443 381Q502 346 553 346Q609 346 649 375T694 454Q694 465 698 474T708 483Q722 483 722 452Q722 386 675 338T555 289Q514 289 468 310T388 357T308 404T224 426Q164 426 125 393T83 318Q81 289 69 289Q55 289 55 319ZM55 85Q55 126 72 159T114 210T163 238T205 248Q207 248 213 248T223 249Q262 249 296 234T393 179L443 147Q502 112 553 112Q609 112 649 141T694 220Q694 249 708 249T722 217Q722 153 675 104T555 55Q514 55 468 76T388 123T308 170T224 192Q164 192 125 159T83 84Q80 55 69 55Q55 55 55 85Z"></path></g><g data-mml-node="mtext" transform="translate(2836.6,0)"><path data-c="1D415" d="M592 686H604Q615 685 631 685T666 684T700 684T724 683Q829 683 835 686H843V624H744L611 315Q584 254 546 165Q492 40 482 19T461 -6L460 -7H409Q398 -4 391 9Q385 20 257 315L124 624H25V686H36Q57 683 190 683Q340 683 364 686H377V624H289L384 403L480 185L492 212Q504 240 529 298T575 405L670 624H582V686H592Z"></path><path data-c="1D40C" d="M314 0Q296 3 181 3T48 0H39V62H147V624H39V686H305Q316 679 323 667Q330 653 434 414L546 157L658 414Q766 662 773 674Q778 681 788 686H1052V624H944V62H1052V0H1040Q1016 3 874 3T708 0H696V62H804V341L803 618L786 580Q770 543 735 462T671 315Q540 13 536 9Q528 1 507 1Q485 1 477 9Q472 14 408 162T281 457T217 603Q215 603 215 334V62H323V0H314Z" transform="translate(869,0)"></path></g></g></g></svg></mjx-container><br>*<strong>standard library</strong> (APIs)<br>*<strong>resource manager</strong><br>ctrl-c used to terminate the <strong>foreground</strong> program in UNIX-based OSs<br><strong>ALSR</strong>: Address Space Layout Randomization: randomized the address where executables are put each time when the process is created to avoid buffer overflow attacks</p>
</li>
<li><p>concurrency: differenet processes ‘simultaneous’<br>*due to the OS execute the instruction groups not atomically, ill-designed multithreading programs may have unexpected results</p>
</li>
<li><p>persistence: store data persistently, namely, I/O<br><strong>journaling</strong>:keep track of changes made to data<br>JBD: Journaling Block Device<br>and WAL in database<br><strong>copy-on-write</strong>:delay the copying of data until the moment it’s actually modified.<br>duplicate on use</p>
</li>
</ul>
<p>Design aims:</p>
<ul>
<li>abstractions</li>
<li>performance</li>
<li>protection(isolation)</li>
<li>reliability(not fail)</li>
<li>…</li>
</ul>
<p>OS history…</p>
 </div></div>


<h2 id="Lecture-2"><a href="#Lecture-2" class="headerlink" title="Lecture 2"></a>Lecture 2</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect2.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br>可以认为是对状态机模型的深入阐述：<br>yzh版本：<a class="link" target="_blank" rel="noopener" href="https://jackcuii.github.io/2023/07/04/ysyx0004/">https://jackcuii.github.io/2023/07/04/ysyx0004/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>

<p><em>“最小的应用程序”</em> 说明了什么？ 程序是状态机，状态机不能退出自己，只能从外部退出，操作系统也是程序，也是状态机，也不能退出自己。<br>用户程序—用syscall—借助—&gt;操作系统—用I/O message—借助—&gt;硬件 来退出自己。</p>
<blockquote>
<p>硬件呢？它也是状态机，但从主板总控的视角上看，供电控制系统是伺服运行的，它<strong>从未</strong> <code>退出</code> 过</p>
</blockquote>
<p>深入理解状态机模型：理解调用和递归<br><em>case:C语言解释器解决函数调用</em></p>
<p>2.1 和 2.2 还没</p>
<p>递归向非递归的转换：<br>其实就是手动来实现了栈，也就是函数调用的过程，跳出“出去回来”的思维模式，一切其实都是在“顺序” “前进”</p>
<blockquote>
<p>某种程度上说，都是递归，或者说非递归就是递归，递归可以认为是一种固有的形式逻辑？</p>
</blockquote>
<div class="note-large notel-red"><div class="notel-title"><p>Spicy</p>
</div><div class="notel-content"><p>更深入地理解状态机：理解编译和优化<br>编译就是状态机之间映射。<br>什么是优化？就是行为不变提高效率/减少资源消耗。什么是行为不变？就是<strong>系统调用不变</strong>。（其余的操作<strong>都是黑箱</strong>，只有调用才和外界产生联系）<br>不仅如此？系统调用也可以改变，保证系统调用的行为一致（<strong>行为的行为</strong>），可以把程序本身somehow做成调用，也就是系统的一部分。（前沿了）<br>额…那这和没有操作系统的区别在于？</p>
 </div></div>

<p>还有很多🛐🛐🛐🛐</p>
<hr>
<h2 id="M1-pstree"><a href="#M1-pstree" class="headerlink" title="M1:pstree"></a>M1:pstree</h2><div class="note-large notel-green"><div class="notel-title"><p>M1 Log</p>
</div><div class="notel-content"><ul>
<li>确实觉得祖传代码应该好好打击了!<ul>
<li>hy老师上周宣布算法的OJ由于<strong>系里禁止</strong>查重而取消，这两件事对比起来看让人唏嘘啊。。。</li>
</ul>
</li>
<li>学习jyy在命令行里接入了GPT，感觉方便了许多！</li>
<li>没看后面的就想（问GPT）到了在哪找到state，切实感觉到了方法论的变化（GPT on the shell 之后，问GPT不用点鼠标了，频率飙升）</li>
<li>🛐 <a class="link" target="_blank" rel="noopener" href="https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap12.html">欠债：POSIX参数约定 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></li>
<li>编写可移植的代码？？？</li>
<li>关于Hard Test的事例，略感恐惧<ul>
<li>这个虽然给出了,但以后的实验呢，想都不敢想。。。</li>
<li>这个或许可以通过strace来发现，但“行为相同”到这个程度……</li>
<li>另外就是发现OJ平台好像可以看到错误返回值</li>
</ul>
</li>
</ul>
<div class="note-large notel-red"><div class="notel-title"><p>Spicy🌶️</p>
</div><div class="notel-content"><ul>
<li>Windows Kernel -&gt; offer API</li>
<li>UNIX (Philosophy) -&gt; Everything is a file -&gt; files</li>
<li>在某一个时刻，高级语言也会变成汇编语言，毕竟Programming终究也就是一个Wheel，好像跟蒸汽机没什么区别…</li>
</ul>
 </div></div>

<ul>
<li><p>man 5 proc</p>
</li>
<li><p>还是要认真读manual，实验了半天得到的参数解析规则其实在文档里已经写了，不过好像手册没有明确写熔断？（比如说读到-V之后就不再解析了，后面错误参数也不管了）</p>
</li>
<li><p>🛐<strong>欠债</strong>：如何写出string robust的代码？</p>
</li>
<li><p>🛐<strong>欠债</strong>：如何写出内存安全的代码？</p>
</li>
<li><p>kthreadd pid=2 ppid=0 内核线程守护进程，运行在内核上的进程,并不会显示在pstree里, 而且发现查询后得知线程在对应进程文件夹下的task文件夹里，不过在/proc中cd相应的序号，也可以进去，虽然实际上不在那里也ls不到，不知道是怎么实现的。</p>
<div class="note note-yellow icon-padding"><i class="note-icon fa-solid fa-group-arrows-rotate"></i><p>群除我佬之后发现原生pstree中是可以指定根的，只要指定根为0就可以发现了</p>
</div></li>
</ul>
<p>🔱<strong>3.15 V1.0 感想</strong>：<br>前前后后写了10几个小时，终于得到了第一个稳定的版本，确实感觉很菜（<br>coding 能力确实低下（虽然有熟悉环境的时间）<br>不过也确实感谢去年ICS的自行加练，一定程度上没有让差距拉的更大<br>现在效率确实远没有群众大佬高，但是感觉能力确实在一点点积累，也希望后面能跟上大家的进度。。。<br>在有些地方踌躇过多，但因为其实没有实际的经验，所以写出来的还是缺乏健壮性。。。<br>而且这么简单的功能写了如此之多行，属实是屎山<br>但<strong>新的风暴确实已经产生了！</strong> 🌪️🌪️🌪️</p>
<ul>
<li>32/64 robustness<br>第一次提交挂了，应该是32/64的问题，问了GPT值得注意的问题</li>
</ul>
<p><strong>32/64 Robustness Checklist:</strong><br>🔻 指针整数转换的时候使用：<code>uintptr_t</code>/<code>intptr_t</code><br>🔻 使用定长的<code>uint32_t</code>系列整型，尽量保证整形长度不变<br>🔻 检查数据对齐</p>
<ul>
<li>使用<code>#pragma pack</code>或<code>__attribute__((aligned))</code>等指令来控制结构体的对齐方式。</li>
<li>在动态分配内存时，考虑使用<code>aligned_alloc</code>、<code>posix_memalign</code>等函数来获取对齐的内存块。</li>
</ul>
<p>🔻 注意<code>size_t</code>的使用<br>🔻 确保使用的第三方库和函数的支持<br>🔻 使用预定义宏如<code>__LP64__</code>、<code>_WIN64</code>等实现条件编译<br>🔻 使用静态代码分析工具如Lint、Cppcheck等来检查。</p> </div></div>




<h2 id="Lecture-3"><a href="#Lecture-3" class="headerlink" title="Lecture 3"></a>Lecture 3</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect3.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<p>物理世界也是状态机，计算机系统的状态机通过Intr和外界连接起来。<br>如何控制一台裸机？把程序放到RESET状态里！<br>固件Firmware：系统配置，开机检查，<strong>加载操作系统</strong><br>Legacy BIOS -&gt; UEFI：丰富的I/O设备, PIC IPIC…<br>CIH病毒：破坏BIOS<br>EFI 分区，我们可以用mount挂载它。<br>还有一个Boot管理工具 <a class="link" target="_blank" rel="noopener" href="https://www.rodsbooks.com/refind/">rEFInd <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<ul>
<li>手册并不是写给学生的，但要痛苦的读</li>
<li>AbstractMachine可以让你绕开手册</li>
<li>模拟器需要做的其实就是状态转移</li>
</ul>
<div class="note-large notel-orange"><div class="notel-title"><p>Extension: Learn from the God</p>
</div><div class="notel-content"><p>GPT on the shell!<br><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2024/03/06/7V1YSIWd8qiNDLz.jpg" alt="b0b8a7feeb7d08c76cf146201fc895e.jpg"></p>
 </div></div>

<p>看到3.3节  浮现课上代码</p>
<h2 id="Lecture-4"><a href="#Lecture-4" class="headerlink" title="Lecture 4"></a>Lecture 4</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect4.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<ul>
<li>Coq 语言 -&gt; 经过<a class="link" target="_blank" rel="noopener" href="https://cacm.acm.org/news/formal-software-verification-measures-up/">形式化验证 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></li>
<li><strong>这门课的逻辑思路</strong>：建模-&gt;用Python实现这个模型的Toy（能实现的原因：操作系统就是一个状态机！）-&gt;对比Toy和真实操作系统的区别-&gt;认识真实操作系统的性质</li>
<li>如何设置？把所有<strong>性质</strong>都显式的assertion出来。</li>
<li>操作系统的理解：管理状态机的状态机, 最早的并发程序</li>
<li>那我们如何来实现一个“状态机的状态机”玩具呢？如果有简单的工具就好了！——Generator</li>
<li>数学视角下，状态机就是一个图，因此系统的状态就是图，因此就可以使用图论方法，比方说，用广度优先搜索验证程序/系统的正确性。</li>
</ul>
<p><strong>待完成，跑一下 30lineOS 复习Python Gene，余者完成</strong></p>
<p>GDB TUI?</p>
<p>ewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufewigooooooojfewighwiorhgihiihrhfuwdhuhhudhhfhuhdhfhcndjncjnjdncdnufu</p>
<h2 id="Lecture-5-C"><a href="#Lecture-5-C" class="headerlink" title="Lecture 5 (C)"></a>Lecture 5 (C)</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect5.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<ul>
<li>多线程程序：多个状态机共享内存，有私有的（C：栈区/Assemble：寄存器）</li>
</ul>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p>核心方法论：<strong>Questioning and Proofing</strong><br>对给出的结论持怀疑态度，并且试着去构造案例去验证。（Hands dirty…）</p>
</div>

<ul>
<li>如何证明共享内存？简单！</li>
<li>如何证明不共享栈区？<br>找到栈区？指向栈区的“指针”！-&gt;局部变量取地址<br>如何大致画出栈区范围？ stack overflow! —&gt; default 8MB</li>
</ul>
<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p>阅读代码：<a class="link" target="_blank" rel="noopener" href="https://github.com/Jackcuii/jyy-codes-test-and-read/blob/master/thread-lib/thread.h">最小线程库 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>简化了线程API</p>
</div>

<blockquote>
<p>mosaic的使用：直接连起来即可，管道喂给collect.py这样就可以收集结果。</p>
</blockquote>
<div class="note-large notel-orange"><div class="notel-title"><p>Extention: LLM</p>
</div><div class="notel-content"><p>LLaMA.cpp: Support run LLM on CPU (OpenSource)<br><a class="link" target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/622450960">https://zhuanlan.zhihu.com/p/622450960 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
 </div></div>



<ul>
<li><p><strong>需要reading: Quickguide GDB调试并发程序</strong></p>
</li>
<li><p>开放<strong>你的</strong>思想：“放弃编程原子性的假设”，进行中的状态机会被改变！</p>
<ul>
<li>在一个处理器的多线程意义下，语句的原子性已经不存在了</li>
<li>在多处理器的意义下，连一条汇编指令的原子性都不存在了</li>
</ul>
</li>
<li><p>1+1都写不对了？确实，而且几乎没人能写对 Dekker’s Algorithm 是第一个<br>Question 1+1: N个threads, sum最小是？ 2！任意多个线程都是！</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Thread 1 | Thread 2</span><br><span class="line">load 0   | load 0</span><br><span class="line">store 1  |</span><br><span class="line">load 1   |</span><br><span class="line">store 2  |</span><br><span class="line">         | store 1</span><br><span class="line">load 1   | </span><br><span class="line">         | load 1</span><br><span class="line">         | store 2</span><br><span class="line">         | load 2</span><br><span class="line">         | store 3</span><br><span class="line">store 2  |</span><br></pre></td></tr></table></figure></div></li>
<li><p>线程安排是以一个NP-Complete问题，<em>LLM级别的直觉</em> 也不能解决！</p>
</li>
</ul>
<hr>
<ul>
<li>更大的麻烦：<strong>编译器</strong>也是这么认为的！<br>回顾编译优化，现在每一条指令之间都可能是系统调用！<br>共享内存的背景下，几乎任何程序，都是“不可优化的”！<br><em>‘Heisenbug’</em>: Copilot：“一个bug，你试图修复它，它就消失了！” <ul>
<li>更可怕的是当编译器执行了优化，可能会把并发错误隐藏起来！<br>-O1 稳定 10000000：把和优化到寄存器里了，只最后写内存了一次<br>-O2 稳定 20000000: 直接编译成一个加了，遇到的概率很小</li>
<li>waiting for flag bug:<br>while(!flag);<br>“等另一个线程举起旗子”<br>也不行！编译器视角：要么直接过，<strong>要么死循环</strong>。<ul>
<li>解决（也是很多并发的解决办法）：插入不可优化代码，见jyyppt/volatile</li>
<li><strong>而本课程建议：加锁！</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="note-large notel-red"><div class="notel-title"><p>Spicy</p>
</div><div class="notel-content"><ul>
<li>更更更大的麻烦：<strong>处理器</strong>也是这么认为的！（处理器也是编译器）<br>如果单线程乱序等效，处理器就可以乱序执行。<br>处理器取出多条指令，然后判断是否冲突。欸？这不就是编译器吗，同样会导致并发错误！<ul>
<li>“相对论效应”：复杂的相对时序<br>多处理器的背景下，共享内存并不是简单共享“同一块”，会发现程序执行的绝对顺序完全不存在了，对于不同的CPU，观测到的时序可能是不一样的（因为多级缓存复杂的写入逻辑（copy-on-write 之类的））。</li>
<li>model checker 都失效了<br>因为model checker是基于“一块共享内存”建模的<br>困难的 memory model (比如x86的 write buffer)<ul>
<li>如果model不同，就很难相互模拟，比如ARM和x86之间</li>
</ul>
</li>
</ul>
</li>
</ul>
 </div></div>


<div class="note-large notel-blue"><div class="notel-title"><p>OSTEP Chapter 25,26,27</p>
</div><div class="notel-content"><ul>
<li>PCB(Process Control Block) v.s. TCB(Thread Control Block)</li>
<li>objdump参数：-g</li>
<li><strong>工具使用valgrind, purify, helgrind</strong></li>
<li>pthread库基础<ul>
<li>pthread_create 创建线程 </li>
<li>pthread_join 等待线程返回（并不是所有的场景都需要）</li>
</ul>
</li>
<li>pthread lock<ul>
<li>pthread_mutex_init</li>
<li>pthread_mutex_lock</li>
<li>pthread_mutex_unlock</li>
<li>pthread_mutex_destroy</li>
<li>pthread_mutex_trylock(一般不要用)</li>
<li>pthread_mutex_timedlock(一般不要用)</li>
</ul>
</li>
<li>pthread cond var 暂时略过</li>
</ul>
<p><strong>Multithreading Checklist</strong>:<br>🔻 </p>
 </div></div>


<h2 id="Lecture-6-C"><a href="#Lecture-6-C" class="headerlink" title="Lecture 6 (C)"></a>Lecture 6 (C)</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect6.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<p>‘sequential creature’的反击：<br>互斥！不允许并发！给它们上锁，让状态机上的一部分缩成一个点！<br>如果都不让并发了？那还并发干什么？<br>运算是可以并行的。局部性原理（经典物理：“物体对相邻的物体产生影响需要时间！”），局部的计算都可以独立的进行，只需要谨慎的处理分块的边界。可以认为不能并发的<strong>任务</strong>部分远远少于可以并发的。</p>
<p>如何互斥？对于一个处理器，关中断就可以了！<br>但当某一个程序卡死了，OS就卡死了。<br>怎么办？外部监控，利用NMI来外部监控OS是否执行正常。（如重置定时器等）<br>因此操作系统统治了中断，禁止用户程序控制中断。</p>
<ul>
<li>悲观的Amdahl’s Law: 如果你有<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="3.441ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 1521 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(500,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"></path></g></g><g data-mml-node="mi" transform="translate(1000,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g></g></g></svg></mjx-container>的代码是不能并行的，那么 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.798ex;" xmlns="http://www.w3.org/2000/svg" width="8.754ex" height="2.89ex" role="img" focusable="false" viewBox="0 -924.8 3869.3 1277.6"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g><g data-mml-node="TeXAtom" transform="translate(617,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="221E" d="M55 217Q55 305 111 373T254 442Q342 442 419 381Q457 350 493 303L507 284L514 294Q618 442 747 442Q833 442 888 374T944 214Q944 128 889 59T743 -11Q657 -11 580 50Q542 81 506 128L492 147L485 137Q381 -11 252 -11Q166 -11 111 57T55 217ZM907 217Q907 285 869 341T761 397Q740 397 720 392T682 378T648 359T619 335T594 310T574 285T559 263T548 246L543 238L574 198Q605 158 622 138T664 94T714 61T765 51Q827 51 867 100T907 217ZM92 214Q92 145 131 89T239 33Q357 33 456 193L425 233Q364 312 334 337Q285 380 233 380Q171 380 132 331T92 214Z"></path></g></g></g><g data-mml-node="mo" transform="translate(1651.9,0)"><path data-c="3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"></path></g><g data-mml-node="mfrac" transform="translate(2707.7,0)"><g data-mml-node="msub" transform="translate(220,446.1) scale(0.707)"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g><g data-mml-node="mn" transform="translate(617,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mi" transform="translate(396.6,-345) scale(0.707)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><rect width="921.6" height="60" x="120" y="220"></rect></g></g></g></svg></mjx-container></li>
<li>乐观的Gustafson’s Law (的更细致版本): 并行计算总是能实现的 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -1.091ex;" xmlns="http://www.w3.org/2000/svg" width="13.834ex" height="3.183ex" role="img" focusable="false" viewBox="0 -924.8 6114.4 1407"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g><g data-mml-node="mi" transform="translate(617,-150) scale(0.707)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g></g><g data-mml-node="mo" transform="translate(1300.5,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"></path></g><g data-mml-node="msub" transform="translate(2356.2,0)"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g><g data-mml-node="TeXAtom" transform="translate(617,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="221E" d="M55 217Q55 305 111 373T254 442Q342 442 419 381Q457 350 493 303L507 284L514 294Q618 442 747 442Q833 442 888 374T944 214Q944 128 889 59T743 -11Q657 -11 580 50Q542 81 506 128L492 147L485 137Q381 -11 252 -11Q166 -11 111 57T55 217ZM907 217Q907 285 869 341T761 397Q740 397 720 392T682 378T648 359T619 335T594 310T574 285T559 263T548 246L543 238L574 198Q605 158 622 138T664 94T714 61T765 51Q827 51 867 100T907 217ZM92 214Q92 145 131 89T239 33Q357 33 456 193L425 233Q364 312 334 337Q285 380 233 380Q171 380 132 331T92 214Z"></path></g></g></g><g data-mml-node="mo" transform="translate(3952.6,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mfrac" transform="translate(4952.8,0)"><g data-mml-node="msub" transform="translate(220,446.1) scale(0.707)"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g><g data-mml-node="mn" transform="translate(617,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mi" transform="translate(403,-345) scale(0.707)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><rect width="921.6" height="60" x="120" y="220"></rect></g></g></g></svg></mjx-container></li>
</ul>
<p>尝试用软件（算法）实现互斥：</p>
<ul>
<li>Dekker’s Algorithm</li>
<li>Peterson’s Algorithm<ul>
<li>假设读写过程是原子的，任何时刻都可以执行load/store</li>
<li>过程<ul>
<li>希望进厕所：举旗子，把对方的名字贴在门上</li>
<li>之后看对面：举没举旗，门上是不是自己的名字</li>
</ul>
</li>
<li>保证了任意打断的正确性。你怎么知道的？Mosaic！</li>
</ul>
</li>
</ul>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p>核心方法论：<strong>Let model checker tell you!</strong><br>与其无意识的瞎猜，不如让Mosaic来告诉你答案！<br>如何知道这个状态机的性质，别忘了图论！<br><strong>我们学习和研究的方法论改变了</strong><br><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2024/03/18/GLYoIMUAia6RQ5H.png" width="600"><br>我们只要发散和质疑，提出猜想！让好的工具告诉你对错！<br><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2024/03/18/iHCg2x5um3BOyMF.png" width="250"><br><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2024/03/18/dPsJ9vR5aACQmDH.png" width="200"><br>再去想为什么。</p>
</div>

<blockquote>
<p>为什么人类的“等在厕所门口”不行？<br>不能同时“看”和“写”（正因为不能同时，所以中间可能会被插入）<br>要么闭着眼睛写，要么背着手看！</p>
</blockquote>
<p>不行怎么办，在关键区stop-the-world！<br>问题是：??</p>
<ul>
<li>只能操作系统可以stop-the-world（关中断）</li>
<li>多处理器也用不了</li>
</ul>
<p>软件解决如此困难，用硬件来解决就可以了！<br>硬件实现的原子指令 <strong>重听一下这里</strong><br>用硬件把看和写变成同时！<br>给我<strong>一点</strong>stop-the-world的机会，一个load/store.</p>
<hr>
<p>Peterson解决问题了吗？没有的<br>怎么办？还是要世界停下！不过停下一小会。</p>
<p>带比较的exchange<br>细节：lhj多处理器</p>
<p>TSX Memory</p>
<p>相比于上面的自旋锁，实际的自旋锁更为复杂<br>用户态的自旋锁会导致资源浪费！</p>
<div class="note-large notel-blue"><div class="notel-title"><p>OSTEP Chapter 28</p>
</div><div class="notel-content"><ul>
<li>mutual exclusion<ul>
<li>disable interruption(simple but bad, as above)</li>
<li>atomic instr:<br>differs in different Arch</li>
</ul>
</li>
<li>fairness</li>
<li>performance</li>
</ul>
 </div></div>



<h2 id="Lecture-7-C"><a href="#Lecture-7-C" class="headerlink" title="Lecture 7 (C)"></a>Lecture 7 (C)</h2><p>如何保证大家的运行？实现多把锁。<br>还要保证当一个解锁时，它所做的写必须都是对其他线程可见的（怎么实现先不用管，框架里帮你实现了）<br>虽然锁很好用，但并不容易正确处理锁。<br>容易出现忘记加锁了，从而造成数据竞争(Data race)<br><strong>Warning：一定会遇到并发错误</strong></p>
<hr>
<p>在现实运行中，并不止如此，还有中断！<br>当你进入临界区，触发中断，再试图进入临界区，此时已经上锁了，无法退出！因此仅有自旋是不对的。</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p>尽量不要<strong>用直觉</strong>去写代码，写错再删….</p>
</div>
<ul>
<li><p>直观的想法：cli -&gt; lock() -&gt; … -&gt; unlock() -&gt; sti</p>
</li>
<li><p>一个锁过程中可能会调用中断再次运行这段代码，那么就无法获得这个锁：陷入死锁！</p>
</li>
<li><p>多个锁可以嵌套和穿插，但cli和sti只有一个，怎么保证<strong>回到从前</strong>？<br>保证中断状态不变这件事不容易：必须要保存中断状态。保存在哪？<br>每次关中断都+1，开中断-1，类似每次嵌套都把中断状态存到一个栈里，<strong>每个CPU</strong>都维护<br><strong>推荐阅读：XV6</strong></p>
<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p>很好的spinlock代码<br>一个启示：多写检查！！<br>另外jyy写的main里面也有很多值得学习的东西。</p>
</div></li>
</ul>
<div class="note note-yellow icon-padding"><i class="note-icon fa-solid fa-group-arrows-rotate"></i><p>群除我佬：<br>关于spinlock的main在本地运行结果不正确的问题：<br>还有就是TCG是什么东西？</p>
</div>

<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p>跳出fast-pass的<strong>投机</strong>思维：即<strong>假设</strong>自己的代码是对的。<br>以后就没有人告诉你对不对了！而且你的未测代码越来越可能不对！</p>
</div>


<div class="note-large notel-red"><div class="notel-title"><p>Spicy</p>
</div><div class="notel-content"><p><a class="link" target="_blank" rel="noopener" href="https://gernot-heiser.org/benchmarking-crimes.html">benchmark crimes <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br>自旋锁的scalability极差！（类似于反比例）操作系统只在及其短促的操作上使用自旋锁。Linux Kernel的分析见ppt链接<br>但Linux有大概180K个需要内存保护的函数，怎么办？<br>一个特性：绝大多数数据结构都是Read-mostly<br>可不可以读不加锁？RCU(Read-Copy-Update)策略！<br>牺牲读写的一致性，选择write-on-copy，写入的时候复制建一份新的（对于常见数据结构，不是傻傻的复制，又高效的部分复制），这样<strong>总能读到</strong>一个。<br>用户程序<strong>应该能容忍</strong> <strong>少量的</strong>读到错的。（比方说路由表，读到错的大不了重发一次）<br>这样就解决了性能问题。<br>什么时候扔掉旧版本？阅读材料（并没有啊。。。）</p>
 </div></div>

<p><strong>XV6 Spinlock拿来在实验里用就行了</strong></p>
<hr>
<p>性能问题：大量的自旋锁会浪费大量的资源。<br>持有锁的线程被中断？？，换一个自旋的，这样可能会100%地占用资源。<br>怎么办：在自旋的时候调度到其他线程（由操作系统来做！）<br>pthread_mutex_lock<br>Futex: 如果无人争抢就不会陷入操作系统内核，如果有人争抢就会交给操作系统调度。<br>有很多并不显然的困难问题</p>
<p><strong>至少目前，mutex就是黑箱就可以了</strong></p>
<h2 id="Lecture-8-Snack"><a href="#Lecture-8-Snack" class="headerlink" title="Lecture 8 (Snack)"></a>Lecture 8 (Snack)</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect8.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br>好用的工具 <a class="link" target="_blank" rel="noopener" href="https://gcc.godbolt.org/">Compiler Explorer <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<p>记住两件事：<br>未测代码都是错的！<br>我写的都是错的！</p>
<p>编译器 + 编译选项 + 特定的硬件 + luck = BUG</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Requirements ---&gt; Design ---&gt; Code[Fault] ---&gt; Execution[Error] ---&gt; [Failure]</span><br><span class="line">              ↑           ↑        ↑                                     ↑</span><br><span class="line">mistake here--+-----------+   Where you make                        Where you find</span><br></pre></td></tr></table></figure></div>

<p>调试就是观察状态机的侧面，以便于找到“第一个错误的状态”<br>printf就是状态的摘要，使人能够通过知识进行判断：快速的对执行进行分块，定位错误在哪一个块上<br>但在很多情况下，有很多的错误状态只是一个值，长得和别的值没有什么区别！</p>
<hr>
<p>调试一切（状态机）！<br>如何解决一个新问题？<br>UNIX哲学中，整个使用计算机都是编程，你都可以去观察侧面，怎么观察？</p>
<ul>
<li>make program verbose <code>-v</code></li>
<li>Profiler <code>perf</code> and Trace <code>strace</code></li>
</ul>
<blockquote>
<p>经过查询，工具中的verbose好像真的是通过多级的if则printf组织的。。。(GPT)</p>
</blockquote>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p><strong>核心方法论</strong>：strace/verbose 的不理解？GPT可以告诉你！<br>GPT非常擅长解释充满了陌生名词但没有复杂逻辑的东西</p>
</div>

<p>报错信息有的时候不可靠的，但是它一定“在什么地方打印出来”。<br>初学者（别人遇到过这个问题）—&gt; 资深程序员（发现原因并解决问题）（“找对象一定给要找程序员：因为出了问题都是自己的原因”）</p>
<div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><strong>重新发现GDB</strong>： <a href="">GDB文档</a> <a href="">QuickGuide</a><br>一些梦寐以求的功能其实GDB已经实现了： 比方说逆向执行！（还有和并发相关的）</p>
</div>

<div class="note-large notel-orange"><div class="notel-title"><p>Extention</p>
</div><div class="notel-content"><p>GDB Cheat Sheet.<br>I have been on it for sometime, though pigeoning!<br><a class="link" target="_blank" rel="noopener" href="https://github.com/Jackcuii/Commandline-quick-sheet">Commandline-quick-sheet <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
 </div></div>

<div class="note-large notel-red"><div class="notel-title"><p>Spicy: Really Spicy!</p>
</div><div class="notel-content"><p>时间压力下，我们会被迫用肌肉记忆解决问题<br>—&gt; 停止自己的技术演进<br>—&gt; 最后技术与社区脱节，成为油腻的中年“键盘侠”<br>怎么办？<br><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2024/03/25/1hi9KtFRMXcGTrC.png" width="300"></p>
 </div></div>

<p>应用调试理论：什么是好的代码？<br>Self-Explanatory Code: 代码应该是自解释的，不需要额外的注释<br>Self-evident Code: 代码应该是自证明的，可以通过阅读确认和需求的一致性。</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p><strong>核心方法论</strong>：因为AI还“不够聪明”：AI is a benchmark! 如果你的代码AI能够理解，那么说明是好代码。</p>
</div>

<hr>
<p>写出BUG了怎么办？</p>
<ul>
<li>多测试</li>
<li>缩短Error和Failure：断言</li>
</ul>
<blockquote>
<p>编译选项：<code>-fsanitize=address</code> 自动添加断言检查存储错。</p>
</blockquote>
<h2 id="Lecture-9-C"><a href="#Lecture-9-C" class="headerlink" title="Lecture 9 (C)"></a>Lecture 9 (C)</h2><p>宏观理解锁<br>应用程序也会被中断，为什么不需要上锁？因为中断对用户程序是不可见的，中断程序(内核态)不回去试图获取用户态的🔒。</p>
<p>状态机视角的同步，简单的状态变复杂，再让世界收束到简单的状态<br>”相互已知的简单状态“<br><em>“电子乐后驱jyy”</em></p>
<p>消费者生产者问题，可以解决99%的同步问题！<br>概念模型：往有限缓冲区放东西/取东西</p>
<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p><a class="link" target="_blank" rel="noopener" href="https://github.com/Jackcuii/jyy-codes-test-and-read/blob/master/pc-1.c">第一个错误的生产者-消费者实现 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p><a class="link" target="_blank" rel="noopener" href="https://github.com/Jackcuii/jyy-codes-test-and-read/blob/master/pc-2.c">第一个正确的生产者-消费者实现 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br>虽然它总是在“自旋”在浪费cpu资源！</p>
</div>
<p>但这是一个万能的方法，上面的depth判断可以抽象成CAN_PRODUCE/CAN_CONSUME<br>这样就是一个万能的模板了！</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p><strong>核心方法论</strong>：为什么“打印括号”？获得一个容易写程序进一步检查，直观的指标！把问题具象化！</p>
</div>
<p>有一个通用的模型，一定有对应的接口实现。<br>我们发明了条件变量，但还不要这么傻（休眠，等待唤醒）：当然有现成的库！</p>
<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p><a class="link" target="_blank" rel="noopener" href="https://github.com/Jackcuii/jyy-codes-test-and-read/blob/master/pc-cv.c">使用了条件变量的接口！很可惜，还是错的 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 书上解释了🛐</p>
</div>
<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p><a class="link" target="_blank" rel="noopener" href="https://github.com/Jackcuii/jyy-codes-test-and-read/blob/master/pc-cv-broadcast.c">真正全局正确的实现，正确打开方式 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>

<p><strong>一个锁实现真正正确的条件变量</strong></p>
<ol>
<li>唤醒后再检查</li>
<li>唤醒所有潜在被唤醒的人</li>
</ol>
<p><strong>我们最好这样写↑</strong></p>
<p>为什么可以解决99%的问题？<br>计算任务都是有向无环图，计算图切分（有序思考方式）</p>
<ol>
<li>一个生产者，每个核心是消费者，生产者（调度器）拓扑排序计算图，把任务分配给消费者即可。（线程池的工作原理）</li>
<li>还可以每个结点都设置一个条件变量。同步条件就是依赖的都完成了</li>
</ol>
<p>1%<br>如果遇到了写不出的条件的怎么办？可以借助状态机进行状态转换。<br>写出了状态机，还是可以用条件变量解决。</p>
<div class="note-large notel-primary"><div class="notel-title"><p>icon-padding</p>
</div><div class="notel-content"><p>这个要看jyy的第九节的视频（🐟的实现）</p>
 </div></div>


<h2 id="Lecture-10-C"><a href="#Lecture-10-C" class="headerlink" title="Lecture 10 (C)"></a>Lecture 10 (C)</h2><p>我们可以用互斥锁来控制同步<br>自旋锁和互斥锁？<br>pthread要求必须是同一个线程require和release</p>
<p>适用于一般模型：给每条边分别加锁！就像是一个拓扑排序！给入边上锁，给出边解锁！</p>
<p>理解信号量：口袋和球<br>信号量可以理解成是互斥锁的自然扩展，不过允许不同的人去放球（释放锁）和拿球（获取锁）<br>所以就可以用信号量去实现上面的模型！</p>
<p>信号量还可以用来管理计数型资源</p>
<p>信号量来实现生产者消费者问题？为什么非要有两个袋子？</p>
<p>信号量不太好实现选择的问题，二选一的情况下必须要你来决定球扔给谁，但也因此更高效（不会唤醒所有后继节点）</p>
<hr>
<p>对比：<br><strong>哲学家吃饭问题</strong><br>用信号量很难实现：所有人都会拿起左边的筷子，然后等待右边的筷子，最后死锁<br>用条件变量：无脑实现，因为互斥锁保证了一下拿两个筷子。</p>
<p>怎么用信号量解决？有一些方案</p>
<ol>
<li>从桌子上赶走一个人，总有一个人能拿到。</li>
<li>给叉子编号，总拿大的、小的</li>
</ol>
<p>但这是一种trick，并不scalable。<br>————因为当问题变复杂时，你都要去考虑这个问题，而且还不一定能解决。相比之下，条件变量更加简单, 更普适。<br>对于现实世界，更多的并发问题都是线程数规模远小于单线程任务量，条件变量的开销就显得不值一提。</p>
<h2 id="Lecture-11-Snack"><a href="#Lecture-11-Snack" class="headerlink" title="Lecture 11 (Snack)"></a>Lecture 11 (Snack)</h2><p>Web历史，详见ppt<br>Web带来的并发问题：请求和更新不同的资源，我们希望他们并发。<br>Solution: 禁止并发，Event-based concurrency，允许异步操作+回调函数，实际上没有任何并发。<br>动态计算图：Promise：直接描述动态计算图。</p>
<p>关于高性能计算的部分确实是需要关注的，毕竟和本行Arch密切相关</p>
<p>这节课其实很难给出一个明确的总结，但一个take-away message可以说是黄胖子的话。</p>
<h2 id="Lecture-12-C"><a href="#Lecture-12-C" class="headerlink" title="Lecture 12 (C)"></a>Lecture 12 (C)</h2><p><strong>死锁</strong></p>
<ul>
<li>AA-Deadlock: wait for self.</li>
<li>ABBA-Deadlock: wait for each other.</li>
</ul>
<p>L1会遇到！</p>
<p><a class="link" target="_blank" rel="noopener" href="https://dl.acm.org/doi/10.1145/356586.356588">关于Deadlock的论文 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>🛐<br>死锁产生的必要条件<br>可以每次等待的时候的输出一下等待关系从而发现死锁。</p>
<p><strong>避免死锁</strong></p>
<ul>
<li>Lock Ordering: 给所有锁编号，严格按照编号顺序加锁,”持有最大的编号的锁的线程总能继续运行！”</li>
</ul>
<p><strong>Data Race</strong><br>Read-Write/Write-Write</p>
<ul>
<li>对于Green Hand，严格避免数据竞争！</li>
</ul>
<p>L2：更加隐形的数据竞争</p>
<p>无非就是<strong>上错了🔒</strong>和<strong>忘了上🔒</strong><br><strong>两条原则</strong>：用🔒保护数据，严格避免数据竞争</p>
<p><strong>本质困难</strong>：“反人性(sequential)” 和 “后果自负(No compile error!)”</p>
<p>Atomicity Violation（ABA）<br>Order Violation（BA）：use-after-free… 最后那里？</p>
<h2 id="Lecture-13-C"><a href="#Lecture-13-C" class="headerlink" title="Lecture 13 (C)"></a>Lecture 13 (C)</h2><h2 id="Lecture-14-V"><a href="#Lecture-14-V" class="headerlink" title="Lecture 14 (V)"></a>Lecture 14 (V)</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect14.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<p>控制系统的加载</p>
<div class="note note-cyan icon-padding"><i class="note-icon fa-solid fa-user-secret"></i><p>阅读minimal加载的makefile🛐</p>
</div>
<ul>
<li><p>fork 复制一份状态机（为什么只能复制？<br>区分：返回值不同<br>fork bomb！<br>USE mosaic<br>fork_demo为什么是48种？？？</p>
<ul>
<li>诡异的“8个hello”<br>你没有正确理解printf!<br>buf也被复制了！<br>unbuffer, line buffer, fully buffer…<br>（谨慎的使用任何隐含假设！）</li>
<li>fork 时候默认继承了环境变量</li>
</ul>
</li>
<li><p>execve<br>抛弃现有的所有状态，准备好参数，设置为另一个状态机的初始状态<br>进程总是从这个开始</p>
<ul>
<li>PATH 环境变量：execve的查找顺序</li>
</ul>
</li>
<li><p>_exit<br>atexit (normal process exit 时调用回调函数, 注意，这是<strong>C的机制</strong>)</p>
<ul>
<li>return 非0</li>
<li>exit(x) 都是Normal exit</li>
</ul>
<p>上面都是调用libc–C语言库的退出，都是对C可见的，所以都是Normal exit</p>
<ul>
<li>_exit(0) 利用系统调用直接退出执行的是exit_group</li>
<li>__exit(0) 是执行exit</li>
</ul>
<p>上面都是非正常退出<br>调查这些问题，别忘了Strace…</p>
</li>
</ul>
<p>“操作系统是状态机的管理者，它把所有状态机都剪碎存在数据结构里，当想要执行的时候再拼接起来，加载到CPU上。”</p>
<h2 id="Lecture-15-V"><a href="#Lecture-15-V" class="headerlink" title="Lecture 15 (V)"></a>Lecture 15 (V)</h2><p>28min左右<br>/proc/maps<br>pmap<br>gdb<br>地址空间是有读写权限的内存段</p>
<p>入侵进程的地址空间！：gdb<br>外挂！</p>
<ul>
<li>最早期的游戏外挂，一个物理的查找表！Game Genie</li>
<li>劫持红警的地址空间：Filter</li>
<li>gdb就是一个巨大的外挂！<ul>
<li>访问proc/mem procfs提供给我们的一个文件，直接指向整个地址空间，可以用文件操作来修改地址空间</li>
<li>或者说外挂是一种游戏的调试器！</li>
</ul>
</li>
</ul>
<p>ydotool</p>
<p>按键精灵</p>
<h2 id="Lecture-16-V"><a href="#Lecture-16-V" class="headerlink" title="Lecture 16 (V)"></a>Lecture 16 (V)</h2><p>操作系统对象：<br>第一种理解：文件（有名字的对象）  Everything(what thing? 操作系统对象) is a file.<br>第二种理解：字节流（终端，外设）和字节序列（普通文件）<br>访问对象需要<del>找对象</del>指针：程序中的指针指向对象，但永远不可能指向“操作系统对象”。<br>如何指向“操作系统对象”，系统调用！（Matrix中的人不会看到外面的罐子！系统调用就是蓝药丸！）<br>文件描述符（会考）：指向操作系统对象的指针</p>
<p>Win’s File Descriptor：handle 句柄（历史问题）</p>
<hr>
<p>另一种对象 IPC Endpoints<br>管道（一种特殊的流）：pipe就是buffer 读口和写口共享<br>两端一般是用两个文件描述符指向（但文件只有一个！）<br>并不是严格的buffer，<br>如果没数据，读不会返回<br>如果没人拿，写不会返回</p>
<p>实现了<strong>I</strong>nter<strong>P</strong>roc<strong>C</strong>ommunication<br>是一种进程间同步机制，可以实现成异步的<br>命名管道：<br>用mkfifo()创建，有对应的文件名</p>
<blockquote>
<p>We also have UNIX domain sockets for local inter-process communication–they also have a name in the file system like “/var/run/docker.sock”. This is similar to a named pipe.</p>
</blockquote>
<p>匿名管道：<br>用pipe()创建<br>自己同时持有两个口，有用吗<br>在fork时，duplicate一份管道不会被复制，因为管道不在地址空间里，只是一个指针，所以是浅拷贝。<br>之后，关掉一个口，就建立了一个父子进程之间的管道</p>
<p>操作系统：对象+API</p>
<p>Shell “Kernel的壳”</p>
<p>Kernel-Shell-I/O-Human</p>
<p>Shell是把用户指令翻译成系统调用的语言</p>
<p>man sh</p>
<p>为什么人工智能我们还要读手册</p>
<p>因为人工智能只会告诉你最常用的解法</p>
<p>GPT Archive 也引入这种补充功能</p>
<p>make 展开</p>
<p>实现一个shell</p>
<p>runcmd那块</p>
<p>技巧gdb skip function</p>
<p>看一下调试部分，以及最后的解释？</p>
<h2 id="Lecture-17-V"><a href="#Lecture-17-V" class="headerlink" title="Lecture 17 (V)"></a>Lecture 17 (V)</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect17.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>

<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">             applications: steam.exe</span><br><span class="line">任何程序 -→ -------------|--------------  </span><br><span class="line">          sys utilities: shell,gcc,ls...       </span><br><span class="line">----------------|-----------------</span><br><span class="line">          libc等C语言库</span><br><span class="line">----------------|-----------------</span><br><span class="line">      OS: 对象+API(syscall)</span><br></pre></td></tr></table></figure></div>
<p>pipe的补充(见ppt，阅读手册🛐)</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p><strong>核心方法论</strong>：深入阅读手册的方式：尝试复现手册中提到的行为！</p>
</div>
<p>“C语言是最通用的高级语言，C语言是一种高级的汇编语言”<br>“最薄的抽象”<br>看一看 C23！🛐</p>
<p>libc 可以用多半C语言本身和一些底层支持实现。<br>已经被标准化 ISO IEC<br>POSIX libc的子集： 最大的体系结构可移植性！</p>
<p>glibc提供了_start!</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p><strong>核心方法论</strong>：学习glibc，使用简化版的glibc，比如musl libc 🛐<br>我怎么知道？可以去问问GPT的教学意见（绷，上面的后半行甚至是copilot补充出来的）</p>
</div>
<p>控制gcc链接哪些东西，不链接那些东西，比方说链接自己的glibc：可以参考musl-gcc的机制！（GPT可以写这种东西）</p>
<p>execve 之后做了什么：我们来调试！<br>细致的去看程序的一生：加载，argc,argv,envp哪里来，libc怎么控制进入你的程序，乃至libc如何退出你的程序…</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p>循序渐进：minimal.img -&gt; freestanding shell -&gt; musl libc -&gt; glibc…</p>
</div>

<hr>
<p>体系结构无关的抽象：ppt上的一页链接 🛐 （GPT帮你阅读！）</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p><strong>核心方法论</strong>：闲来无事读手册！（真的很需要热情。。。）<br>参考一些手册和有趣的实现，可以获得大量的编程经验，系统知识，和奇技淫巧！<br>一个常见的practice会在各种各样的实现中被反复，从中学习！<br>ppt上给出了很多很多RTFM entries!🛐</p>
</div>
<blockquote>
<p>offsetof宏：一个奇技淫巧！</p>
</blockquote>
<p>printf带来的启示：一个软件工程上的原则：避免“code clone”<br>tls 🛐</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p><strong>核心方法论</strong>：从各种各样的奇怪机制的调试中获得和加深对系统的认识！此时再打开手册，就不显得困难了！🛐</p>
</div>

<p>🔱计算机世界中没有任何的魔法！（只要你不写错）</p>
<h2 id="L1"><a href="#L1" class="headerlink" title="L1"></a>L1</h2><p>本身是Lect 17的内容，整合过来。<br>优化必须要基于Workload！<br>🔱Knuth: Premature optimization is the root of all evil.</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p><strong>核心方法论</strong>：Workload哪里来？读论文去！<br>其实还有profiler, tracer…</p>
</div>

<p>System 人的智慧：该省省该花花，先浪费，再在现实问题情景中找补回来</p>
<h2 id="Lecture-18-V"><a href="#Lecture-18-V" class="headerlink" title="Lecture 18 (V)"></a>Lecture 18 (V)</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect18.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2024/04/30/O4HM3C5VZhPQ6kU.png" width="800">

<p>尽在不言中。<br>Linux历史：我们操作系统界也有自己的<strong>原神</strong>！</p>
<h2 id="Lecture-19-V-可执行文件，静态链接"><a href="#Lecture-19-V-可执行文件，静态链接" class="headerlink" title="Lecture 19 (V) 可执行文件，静态链接"></a>Lecture 19 (V) 可执行文件，静态链接</h2><p>什么是可执行文件？<br>操作系统的对象，存储状态机(静态的)初始状态的数据结构。<br>execve = 初始化Process(?) + 加载ELF（规定了程序执行进入entry时地址空间里的东西）</p>
<p><a class="link" target="_blank" rel="noopener" href="https://www.gnu.org/software/binutils/">Binutils <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>🛐</p>
<p>ELF并不人类友好，并不满足”信息局部性”。(ABI手册规范的)<br>那我们重新设计一个友好的！<br><img lazyload="" src="/images/loading.svg" data-src="https://s2.loli.net/2024/05/14/JVvYfxjO7SLWnkM.png" width="600"></p>
<p>jammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmjammmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm<br>现在的Core Dump是ELF文件❓<br>很久以前的“a.out”是非常简单的。（但支持的非常少，比如说用于调试的符号都存在哪里？）</p>
<p>“FLE”：代码、符号、重定位！<br>静态链接是什么·？就是合并同类项，再重定位，就是计算出待定的指针值。<br>书签们也要改好（符号）<br>复习ICS: 高级语言代码(.c, text) –预编译(宏展开…)–&gt; (.i, text) –编译–&gt; 汇编指令序列(.s, txt) –汇编器as–&gt; ELF(.o, bin)<br>复习一下ICS链接部分🛐</p>
<p>“FLE”的加载 56min<br>阅读Funny的代码</p>
<p>ELF是高效的，内存节省的，industrial 的选择<br>threadlocal</p>
<p>静态ELF加载器那里</p>
<p>execve中的行为，我们也可以自己实现！</p>
<h2 id="Lecture-20-V"><a href="#Lecture-20-V" class="headerlink" title="Lecture 20 (V)"></a>Lecture 20 (V)</h2><p>A software engineering view<br>实现运行库和应用代码分离</p>
<ul>
<li>应用之间的库共享(占用存储太大了)</li>
<li>大型项目的分解</li>
<li>依赖也是克隆，可以同时更新无数的程序（否则需要重新链接无数的程序）</li>
</ul>
<p>前面那个更新网页依赖前面一点（再听一下）<br>Semantic Version</p>
<p>Dependency Hell</p>
<p>libc.o（静态链接）<br>没节省内存（还是要在内存里有很多份），而且还解析了一大堆用不到的符号</p>
<p>libc.so(动态链接)<br><strong>听一下</strong></p>
<p>ldd<br>ld.so 🛐</p>
<div class="note note-green icon-padding"><i class="note-icon fa-solid fa-bolt"></i><p>核心方法论 SEE ALSO in Manual</p>
</div>

<p>LD_PRELOAD</p>
<h2 id="Lecture-21-K-Syscall-intr"><a href="#Lecture-21-K-Syscall-intr" class="headerlink" title="Lecture 21 (K) Syscall, intr"></a>Lecture 21 (K) Syscall, intr</h2><p>系统调用：向操作系统的 “函数调用”</p>
<p><code>syscall</code>指令 = 跳转并提权<br>in RISC-V </p>
<h2 id="Lecture-22-K-from-Thread-to-Process"><a href="#Lecture-22-K-from-Thread-to-Process" class="headerlink" title="Lecture 22 (K) from Thread to Process"></a>Lecture 22 (K) from Thread to Process</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect22.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<p>Process = Thread + VR glasses(addr translation)<br>用一个数据结构来维护地址的Map（一个映射函数<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.244ex" height="2.059ex" role="img" focusable="false" viewBox="0 -705 550 910"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"></path></g></g></g></svg></mjx-container>）<br>RBT？不够快！</p>
<ul>
<li><strong>用Radix Tree来实现</strong> riscv, x86, arm<ul>
<li><a class="link" target="_blank" rel="noopener" href="https://www.cnblogs.com/wgwyanfs/p/6887889.html">A blog <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></li>
<li>(1024叉树 for 32-bit machine)<ul>
<li>i386的二级页表</li>
</ul>
</li>
<li>64-bit不那么好玩了，4KB页面中只有512个指针了，不整。<ul>
<li>x86_64: PML4, PML5</li>
<li>riscv: 只要三级，只能索引到512GB的内存</li>
</ul>
</li>
<li>因为页表在内存里，不够快，所以还是要用TLB</li>
<li>CR3指向一级页表的基址</li>
</ul>
</li>
<li><strong>不实现</strong> MIPS （“文艺实现”）<br>硬件只管TLB缓存和物理内存，页表什么，随你喜欢！<br>缺页发生时，产生一个异常，交由操作系统处理。<br>提供指令 <code>tlbwi</code> <code>tlbwr</code> 给操作系统写入TLB<blockquote>
<p>硬件在变得越来越可编程，一种是本身就可编程(FPGA…)，一种是提供软件的接口自由实现（就像这个）</p>
</blockquote>
</li>
<li><strong>Hash table实现</strong> invert page table(“疯狂实现”)<br>把进程号也作为虚拟地址的一部分，直接进行Hash<br>会有安全问题</li>
</ul>
<p>疯狂填写（无能狂怒）<code>nop</code> 的libbloat.so：</p>
<ul>
<li>不会榨干内存！因为OS会把它们指向同一份代码(映射函数<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.244ex" height="2.059ex" role="img" focusable="false" viewBox="0 -705 550 910"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"></path></g></g></g></svg></mjx-container>不一定是单射)</li>
<li>即使是100G，也不会被只读内存榨干！<br>Kernel Samepage Merging, 不只两个进程指向的“逻辑位置相同”的代码会被合并，“内容相同”的页也会被合并！<br>（即使是Malloc的，也不会！）</li>
<li>即使是随机代码，也不会被榨干！Demand paging<br>磁盘可以被映射到地址空间，此时使用指针访问它<br>缺页，操作系统通过数据结构发现它被映射到设备，把该页读入内存再加入映射<br>地址空间装不下这么大，该怎么索引？不是正常指针，用文件描述符这种独立的指针🐒尚需确认</li>
</ul>
<p>进而涉及 Swap page机制（页面交换/虚拟内存）<br>操作系统会把闲置的页塞回磁盘里去。</p>
<p>高性能的实现fork：Copy-on-write fork()</p>
<ul>
<li>岁月史书：vfork()</li>
<li>只读时浅拷贝，不得不copy（发生写事件在共享读的页上，发生一个Exception）再deepcopy</li>
<li>可以为服务器作进程快照：可以当父进程挂了的时候，用快照顶上。</li>
</ul>
<p>所谓局部性就是，你手和眼睛的接触的范围有限，你用VR眼镜的视线之外的部分，操作系统可以随意乱搞。（牺牲一些性能，但保证不会被榨干crash掉）</p>
<p>一些场景下使用2M的大页</p>
<p>🔱The most important characteristics of the system are its simplicity, elegance, and ease of use. </p>
<p>🪐UNIX的岁月史书（ppt）<br>gets(buf)</p>
<p>“在人工智能的辅助下什么”34min左右…好像被剪掉了。。。</p>
<div class="note-large notel-orange"><div class="notel-title"><p>Extention:XV6🛐</p>
</div><div class="notel-content"><p><a class="link" target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2023/xv6.html">https://pdos.csail.mit.edu/6.828/2023/xv6.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/manuals/book-riscv-rev3.pdf">https://jyywiki.cn/OS/manuals/book-riscv-rev3.pdf <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
 </div></div>

<h2 id="Lecture-23-K-Schedule"><a href="#Lecture-23-K-Schedule" class="headerlink" title="Lecture 23 (K) Schedule"></a>Lecture 23 (K) Schedule</h2><div class="note note-primary icon-padding"><i class="note-icon fa-solid fa-circle-arrow-right"></i><p><a class="link" target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2024/lect23.md">务必搭配jyywiki食用 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</div>
<p>前面Meltdown那里🐒<br>进程无法直接看到内核代码，怎么跳过去？<br>Tramploine: 一个小的代码片段，用来跳转到内核代码</p>
<p>gdb-multiarch</p>
<p>阅读XV6的init代码🐒第一个进程</p>
<p>调度：<br>建模→预测→决策</p>
<p>UNIX Niceness<br>[-20, 20) 越小的越坏，“坏”就是不愿意让给别人<br>Nice相差10大概是资源差十倍<br>When Nices equals<br>不能Round-and-Robin，低占用的即时前台程序不能和高占用的后台R&amp;R。</p>
<p>再听一下MLFQ🐒<br>CFS<br>红黑树</p>
<div class="note-large notel-red"><div class="notel-title"><p>🌶️Spicy:</p>
</div><div class="notel-content"><p>优先级反转🐒<br>Linux：解决不了，拜拜<br>安卓手机越用越卡，一些垃圾应用获得高优先级的🔒，导致了系统的卡顿</p>
<p>对称多处理器 SMP<br>不能随机分配，线程退出之后处理器会”围观别人干活”<br>也不能谁空分给谁，会损失缓存的信息：同处理器跨核L1就没了，跨处理器L2/L3也没了（具体架构相关）</p>
<p>事实上SMP还是不理想的建模：现在的处理器不对称了</p>
<p>多用户</p>
<p>程序执行也没有那么简单：<br>有时更多的资源反而会变慢。<br>共享内存的Cache slot在不同处理器之间疯狂横跳。</p>
 </div></div>



            </div>

            
                <div class="post-copyright-info">
                    <div class="article-copyright-info-container">
    <ul>
        <li>Post title：Talk to the God——Notes for jyy OS</li>
        <li>Post author：Jackcui</li>
        <li>Create time：2024-02-28 09:02:59</li>
        <li>
            Post link：https://jackcuii.github.io/2024/02/28/OS/
        </li>
        <li>
            Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

                </div>
            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/CS/">#CS</a>&nbsp;
                        </li>
                    
                        <li class="tag-item">
                            <a href="/tags/Notes/">#Notes</a>&nbsp;
                        </li>
                    
                </ul>
            

            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                            rel="prev"
                            href="/2024/03/01/HPP/"
                            >
                                <span class="left arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </span>
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">Notes for Heterogeneous Parallel Programming By W. Hwu</span>
                                    <span class="post-nav-item">Prev posts</span>
                                </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                            rel="next"
                            href="/2024/02/26/ComputerNetwork/"
                            >
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">Notes for Computer Network</span>
                                    <span class="post-nav-item">Next posts</span>
                                </span>
                                <span class="right arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </span>
                            </a>
                        </div>
                    
                </div>
            


            
                <div class="comment-container">
                    <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fa-solid fa-comments"></i>&nbsp;Comments
    </div>
    

        
            
 
    <div id="waline"></div>
    <script type="module"  data-pjax>
        import { init } from 'https://evan.beee.top/js/waline.mjs';

        function loadWaline() {
            init({
                el: '#waline',
                serverURL: 'https://comment.jackcuii.cn/',
                lang: 'zh-CN',
                dark: 'body[class~="dark-mode"]',
                requiredMeta: ['nick','mail'], // cannot customize by theme config, change it yourself
            });
        }

        if ('true') {
            const loadWalineTimeout = setTimeout(() => {
                loadWaline();
                clearTimeout(loadWalineTimeout);
            }, 1000);
        } else {
            window.addEventListener('DOMContentLoaded', loadWaline);
        }
        
    </script>



        
    
</div>

                </div>
            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">Talk to the God——Notes for jyy OS</div>
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-text">References</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Waiting-List"><span class="nav-text">Waiting List</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%AA%E8%AE%BA"><span class="nav-text">绪论</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E5%88%AB%E8%AF%B4%E6%98%8E"><span class="nav-text">特别说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-1"><span class="nav-text">Lecture 1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-2"><span class="nav-text">Lecture 2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#M1-pstree"><span class="nav-text">M1:pstree</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-3"><span class="nav-text">Lecture 3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-4"><span class="nav-text">Lecture 4</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-5-C"><span class="nav-text">Lecture 5 (C)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-6-C"><span class="nav-text">Lecture 6 (C)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-7-C"><span class="nav-text">Lecture 7 (C)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-8-Snack"><span class="nav-text">Lecture 8 (Snack)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-9-C"><span class="nav-text">Lecture 9 (C)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-10-C"><span class="nav-text">Lecture 10 (C)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-11-Snack"><span class="nav-text">Lecture 11 (Snack)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-12-C"><span class="nav-text">Lecture 12 (C)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-13-C"><span class="nav-text">Lecture 13 (C)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-14-V"><span class="nav-text">Lecture 14 (V)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-15-V"><span class="nav-text">Lecture 15 (V)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-16-V"><span class="nav-text">Lecture 16 (V)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-17-V"><span class="nav-text">Lecture 17 (V)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#L1"><span class="nav-text">L1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-18-V"><span class="nav-text">Lecture 18 (V)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-19-V-%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%EF%BC%8C%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5"><span class="nav-text">Lecture 19 (V) 可执行文件，静态链接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-20-V"><span class="nav-text">Lecture 20 (V)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-21-K-Syscall-intr"><span class="nav-text">Lecture 21 (K) Syscall, intr</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-22-K-from-Thread-to-Process"><span class="nav-text">Lecture 22 (K) from Thread to Process</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture-23-K-Schedule"><span class="nav-text">Lecture 23 (K) Schedule</span></a></li></ol>

    </div>
</div>
            </div>
        
    </div>
</div>


                

            </div>



        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info">
            &copy;
            
              <span>2022</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Jackcui</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv" class="busuanzi_container_site_uv">
                        VISITOR COUNT&nbsp;<span id="busuanzi_value_site_uv" class="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="busuanzi_container_site_pv">
                        TOTAL PAGE VIEWS&nbsp;<span id="busuanzi_value_site_pv" class="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            <span class="powered-by-container">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" href="https://hexo.io">Hexo</a></span>
                <br> 
            <span class="theme-version-container">THEME&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v1.2.3</a>
        </div>
        
        
        
            <div id="start_time_div" style="display:none">
                2022/8/17 11:45:14
            </div>
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
        
            <script async data-pjax>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="unfolded-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="right-bottom-tools tool-scroll-to-top flex-center">
                <i class="fa-regular fa-arrow-up"></i>
            </li>
        

        <li class="right-bottom-tools tool-scroll-to-bottom flex-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="folded-tools-list">
        <li class="right-bottom-tools tool-toggle-show flex-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    


</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/layouts/menu-shrink.js"></script>

<script src="/js/tools/go-top-bottom.js"></script>

<script src="/js/tools/dark-light-toggle.js"></script>



    
<script src="/js/tools/local-search.js"></script>




    
<script src="/js/tools/code-block.js"></script>




    
<script src="/js/layouts/lazyload.js"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/layouts/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js"></script>







<div class="post-scripts pjax">
    
        
<script src="/js/tools/toc-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/layouts/toc.js"></script>

<script src="/js/plugins/tabs.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            REDEFINE.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            REDEFINE.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            REDEFINE.refresh();
        });
    });
</script>




    <div id="aplayer"></div>

<script src="/js/libs/APlayer.min.js"></script>


<script src="/js/plugins/aplayer.js"></script>


</body>
</html>
